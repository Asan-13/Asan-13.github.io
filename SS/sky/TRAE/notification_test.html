<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>远程通知功能测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="./libs/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <script src="./libs/@supabase/supabase-js/dist/umd/supabase.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        priority: {
                            high: '#ef4444',
                            medium: '#f59e0b',
                            low: '#10b981',
                            none: '#64748b'
                        },
                        primary: '#60a5fa',
                        secondary: '#94a3b8',
                        dark: {
                            bg: '#1e293b',
                            card: '#334155',
                            hover: '#475569',
                            text: '#f8fafc',
                            textSecondary: '#cbd5e1'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .notification {
                @apply fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-[10000] transform transition-all duration-300 translate-x-full;
            }
            .notification.show {
                @apply translate-x-0;
            }
            .notification.error {
                @apply bg-red-500;
            }
            .announcement-card {
                @apply bg-dark-card rounded-xl shadow-lg p-4 sm:p-6 mb-5 border border-primary/20 hover:shadow-2xl transition-all duration-300 hover:border-primary/40 relative overflow-hidden;
            }
            .announcement-card::before {
                @apply absolute top-0 left-0 w-1 h-full bg-primary opacity-70;
                content: '';
            }
            .announcement-header {
                @apply flex flex-wrap items-center justify-between mb-3 sm:mb-4 gap-3;
            }
            .announcement-icon {
                @apply text-primary text-xl sm:text-2xl mr-2 sm:mr-3;
            }
            .announcement-title {
                @apply font-bold text-base sm:text-lg flex-1 text-primary;
            }
            .announcement-content {
                @apply text-dark-textSecondary mb-4 sm:mb-5 pl-6 sm:pl-8 leading-relaxed line-clamp-2 sm:line-clamp-3 transition-all duration-300 text-sm overflow-hidden;
            }
            .announcement-card.expanded .announcement-content {
                @apply line-clamp-none;
            }
            .expand-btn {
                @apply text-xs text-primary hover:text-primary/80 transition-colors duration-200 mt-2 flex items-center justify-center;
            }
            .announcement-footer {
                @apply flex flex-wrap items-center justify-between pt-3 sm:pt-4 border-t border-gray-600/50 gap-2;
            }
            .announcement-time {
                @apply text-xs text-dark-textSecondary flex items-center;
            }
            .announcement-badge {
                @apply px-2 py-1 rounded-full text-xs font-medium bg-primary/20 text-primary hover:bg-primary/30 transition-all duration-200;
            }
            .close-btn {
                @apply text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded-full hover:bg-red-500/10;
            }
            .empty-state {
                @apply bg-dark-card rounded-xl p-6 sm:p-8 text-center border border-gray-600/50 transition-all duration-300 hover:shadow-lg;
            }
            .empty-icon {
                @apply text-gray-500 text-4xl sm:text-5xl mb-3 sm:mb-4 animate-pulse;
            }
            .empty-text {
                @apply text-dark-textSecondary text-sm sm:text-base mb-4;
            }
            .empty-action {
                @apply mt-4;
            }
            .refresh-btn {
                @apply bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 mx-auto;
            }
            .priority-indicator {
                @apply w-2 h-2 rounded-full mr-2;
            }
            .priority-high {
                @apply bg-priority-high;
            }
            .priority-medium {
                @apply bg-priority-medium;
            }
            .priority-low {
                @apply bg-priority-low;
            }
            .priority-none {
                @apply bg-priority-none;
            }
            .read-status {
                @apply w-3 h-3 rounded-full mr-2;
            }
            .unread {
                @apply bg-primary;
            }
            .read {
                @apply bg-gray-500;
            }
        }
    </style>
    
    <style>
        /* 主题变量定义 */
        :root {
            --bg-color: #1e293b;
            --card-color: #334155;
            --text-color: #f8fafc;
            --text-secondary: #cbd5e1;
            --primary-color: #60a5fa;
            --border-color: rgba(96, 165, 250, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }
        
        [data-theme="light"] {
            --bg-color: #FFF5F7 !important;
            --card-color: #FFFFFF !important;
            --text-color: #3D1A2D !important;
            --text-secondary: #8A4A62 !important;
            --primary-color: #FFA7C4 !important;
            --border-color: rgba(255, 167, 196, 0.4) !important;
            --shadow-color: rgba(138, 74, 98, 0.2) !important;
        }
        
        body {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        
        .bg-dark-card {
            background-color: var(--card-color) !important;
        }
        
        .text-dark-text {
            color: var(--text-color) !important;
        }
        
        .text-dark-textSecondary {
            color: var(--text-secondary) !important;
        }
        
        .bg-primary {
            background-color: var(--primary-color) !important;
        }
    </style>
</head>
<body class="p-4">
    <h1 class="text-2xl font-bold mb-6">远程通知功能测试</h1>
    
    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3">功能说明</h2>
        <div class="bg-dark-card rounded-lg p-4 border border-gray-600">
            <p class="mb-2">1. <strong>数据来源</strong>：从Supabase的notifications表获取远程通知数据</p>
            <p class="mb-2">2. <strong>展示逻辑</strong>：</p>
            <ul class="list-disc list-inside ml-4 mb-2">
                <li>页面加载时自动获取最新通知</li>
                <li>支持定时检查新通知（默认每5分钟）</li>
                <li>仅显示激活状态的通知</li>
                <li>本地缓存最后拉取时间，避免重复显示</li>
            </ul>
            <p class="mb-2">3. <strong>UI展示</strong>：</p>
            <ul class="list-disc list-inside ml-4">
                <li>顶部右侧弹出通知（与现有系统一致）</li>
                <li>下方显示所有通知列表</li>
                <li>支持手动关闭单个通知</li>
            </ul>
        </div>
    </div>
    
    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3">测试控制</h2>
        <div class="flex gap-4">
            <button id="fetch-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg">
                <i class="fa fa-refresh"></i> 手动获取通知
            </button>
            <button id="clear-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                <i class="fa fa-trash"></i> 清除缓存
            </button>
            <button id="theme-toggle" class="bg-dark-card hover:bg-dark-hover text-white px-4 py-2 rounded-lg">
                <i class="fa fa-moon-o"></i> 切换主题
            </button>
        </div>
    </div>
    
    <div class="mb-6">
        <h2 class="text-xl font-semibold mb-3">通知列表</h2>
        <div id="notifications-list" class="space-y-4">
            <!-- 通知列表将在这里动态生成 -->
        </div>
    </div>
    
    <!-- 通知元素 -->
    <div id="notification" class="notification"></div>
    
    <script>
        // Supabase配置
        const supabaseUrl = 'https://prusinqhwaduefiuqkwt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydXNpbnFod2FkdWVmaXVxa3d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTI5OTYsImV4cCI6MjA3OTU4ODk5Nn0.X__p8sP8ZdaOBGsbFWnhAdgLnjTXN-Y8YMVL5csVQ2Y';
        let supabase;
        
        // 初始化Supabase
        async function initSupabase() {
            try {
                // 检查CDN加载的Supabase库导出方式
                let createClientFunc = null;
                
                if (typeof window.supabase?.createClient === 'function') {
                    createClientFunc = window.supabase.createClient;
                } else if (typeof window.createClient === 'function') {
                    createClientFunc = window.createClient;
                } else if (typeof createClient === 'function') {
                    createClientFunc = createClient;
                }
                
                if (createClientFunc) {
                    supabase = createClientFunc(supabaseUrl, supabaseKey);
                    showNotification('Supabase初始化成功', false);
                    return true;
                } else {
                    showNotification('无法找到Supabase客户端函数', true);
                    return false;
                }
            } catch (error) {
                showNotification('Supabase初始化失败: ' + error.message, true);
                return false;
            }
        }
        
        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            if (isError) {
                notification.classList.add('error');
            } else {
                notification.classList.remove('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 从Supabase获取通知
        async function fetchNotifications() {
            if (!supabase) {
                showNotification('Supabase未初始化，无法获取通知', true);
                return [];
            }
            
            try {
                const { data, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                showNotification(`成功获取 ${data.length} 条通知`, false);
                return data || [];
            } catch (error) {
                showNotification('获取通知失败: ' + error.message, true);
                return [];
            }
        }
        
        // 渲染通知列表
        function renderNotifications(notifications) {
            const notificationsList = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-bell-o empty-icon"></i>
                        <p class="empty-text">暂无公告通知</p>
                        <p class="text-xs text-dark-textSecondary">当有新公告发布时，将在这里显示</p>
                        <div class="empty-action">
                            <button id="empty-refresh-btn" class="refresh-btn">
                                <i class="fa fa-refresh"></i>
                                <span>手动刷新</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // 添加空状态刷新按钮事件监听
                document.getElementById('empty-refresh-btn').addEventListener('click', async () => {
                    await checkNewNotifications();
                });
                
                return;
            }
            
            // 从localStorage获取已读通知ID
            const readNotifications = JSON.parse(localStorage.getItem('readNotifications') || '[]');
            
            notificationsList.innerHTML = notifications.map(notification => {
                // 确定通知优先级
                const priority = notification.priority || 'none';
                // 确定是否已读
                const isRead = readNotifications.includes(notification.id);
                
                return `
                    <div class="announcement-card ${isRead ? 'opacity-90' : ''}">
                        <div class="announcement-header">
                            <div class="flex items-center">
                                <i class="fa fa-bullhorn announcement-icon"></i>
                                <div class="flex-1">
                                    <div class="flex items-center mb-1">
                                        <span class="priority-indicator priority-${priority}"></span>
                                        <h3 class="announcement-title">${notification.title}</h3>
                                        ${!isRead ? '<span class="read-status unread"></span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="announcement-badge">公告</span>
                                <button class="close-btn ml-3" data-id="${notification.id}">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="announcement-content">
                            ${notification.content}
                        </div>
                        <div class="expand-indicator">
                            <button class="expand-btn" data-id="${notification.id}">
                                <i class="fa fa-chevron-down mr-1"></i>
                                <span class="expand-text">查看更多</span>
                            </button>
                        </div>
                        <div class="announcement-footer">
                            <span class="announcement-time">
                                <i class="fa fa-clock-o mr-1"></i>
                                ${new Date(notification.created_at).toLocaleString('zh-CN')}
                            </span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-300">
                                    ${priority === 'high' ? '高优先级' : priority === 'medium' ? '中优先级' : priority === 'low' ? '低优先级' : '普通'}
                                </span>
                                ${!isRead ? '<button class="mark-read-btn text-xs text-primary hover:text-primary/80 transition-colors duration-200" data-id="' + notification.id + '">标记已读</button>' : '<span class="text-xs text-gray-500">已读</span>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 添加关闭按钮事件监听
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('.close-btn').dataset.id;
                    // 标记为已读
                    markAsRead(id);
                    e.target.closest('.announcement-card').remove();
                    showNotification('通知已关闭', false);
                });
            });
            
            // 添加标记已读按钮事件监听
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    markAsRead(id);
                    // 更新UI
                    const notificationCard = e.target.closest('.announcement-card');
                    notificationCard.classList.add('opacity-90');
                    e.target.replaceWith('<span class="text-xs text-gray-500">已读</span>');
                    const unreadDot = notificationCard.querySelector('.read-status.unread');
                    if (unreadDot) {
                        unreadDot.remove();
                    }
                    showNotification('通知已标记为已读', false);
                });
            });
            
            // 添加展开/收起按钮事件监听
            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const announcementCard = e.target.closest('.announcement-card');
                    const isExpanded = announcementCard.classList.toggle('expanded');
                    const expandText = announcementCard.querySelector('.expand-text');
                    const expandIcon = announcementCard.querySelector('.fa-chevron-down');
                    
                    if (isExpanded) {
                        expandText.textContent = '收起';
                        expandIcon.classList.remove('fa-chevron-down');
                        expandIcon.classList.add('fa-chevron-up');
                    } else {
                        expandText.textContent = '查看更多';
                        expandIcon.classList.remove('fa-chevron-up');
                        expandIcon.classList.add('fa-chevron-down');
                    }
                });
            });
            
            // 检查内容是否需要展开按钮
            setTimeout(() => {
                document.querySelectorAll('.announcement-card').forEach(card => {
                    const content = card.querySelector('.announcement-content');
                    const indicator = card.querySelector('.expand-indicator');
                    
                    if (content.scrollHeight <= content.clientHeight) {
                        indicator.style.display = 'none';
                    }
                });
            }, 100);
        }
        
        // 标记通知为已读
        function markAsRead(notificationId) {
            const readNotifications = JSON.parse(localStorage.getItem('readNotifications') || '[]');
            if (!readNotifications.includes(notificationId)) {
                readNotifications.push(notificationId);
                localStorage.setItem('readNotifications', JSON.stringify(readNotifications));
            }
        }
        
        // 检查新通知
        async function checkNewNotifications() {
            const lastFetchTime = localStorage.getItem('lastNotificationFetch');
            const notifications = await fetchNotifications();
            
            if (notifications.length > 0) {
                // 找出新的通知（创建时间在最后一次获取时间之后）
                const newNotifications = lastFetchTime 
                    ? notifications.filter(n => new Date(n.created_at) > new Date(lastFetchTime))
                    : notifications;
                
                // 显示新通知
                newNotifications.forEach(notification => {
                    showNotification(`${notification.title}: ${notification.content}`, false);
                });
                
                // 更新最后获取时间
                localStorage.setItem('lastNotificationFetch', new Date().toISOString());
            }
            
            // 渲染所有通知
            renderNotifications(notifications);
        }
        
        // 清除缓存
        function clearCache() {
            localStorage.removeItem('lastNotificationFetch');
            showNotification('缓存已清除', false);
        }
        
        // 主题切换
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            showNotification(`已切换到${newTheme === 'dark' ? '深色' : '浅色'}模式`, false);
        }
        
        // 页面加载时初始化
        window.addEventListener('load', async () => {
            // 初始化主题
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // 初始化Supabase
            await initSupabase();
            
            // 获取并显示通知
            await checkNewNotifications();
            
            // 设置定时检查（每5分钟）
            setInterval(checkNewNotifications, 5 * 60 * 1000);
        });
        
        // 添加事件监听
        document.getElementById('fetch-btn').addEventListener('click', checkNewNotifications);
        document.getElementById('clear-btn').addEventListener('click', clearCache);
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    </script>
</body>
</html>