<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky 事件 管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="./libs/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <script src="./libs/@supabase/supabase-js/dist/umd/supabase.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        priority: {
                            high: '#ef4444',
                            medium: '#f59e0b',
                            low: '#10b981',
                            none: '#64748b'
                        },
                        primary: '#60a5fa',
                        secondary: '#94a3b8',
                        dark: {
                            bg: '#1e293b',
                            card: '#334155',
                            hover: '#475569',
                            text: '#f8fafc',
                            textSecondary: '#cbd5e1'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .task-transition {
                transition: all 0.5s ease-in-out;
            }
            .hover-expand {
                transition: max-height 0.5s ease-in-out;
            }
            .context-menu {
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .modal-backdrop {
                backdrop-filter: blur(2px);
            }
            .app-compact {
                padding: 1.5rem;
                min-height: auto !important;
                width: auto !important;
                max-width: 280px;
            }
            .app-expanded {
                padding: 2rem;
                width: auto !important;
                max-width: 520px;
            }
            .task-item {
                cursor: pointer;
            }
            .day-checkbox {
                width: 1.5rem;
                height: 1.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .recurrence-option {
                @apply p-3 border border-gray-600 rounded-lg cursor-pointer transition-all hover:border-primary;
            }
            .recurrence-option.selected {
                @apply border-primary bg-primary/10;
            }
            .ongoing-indicator {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }
            .time-input-group {
                @apply flex items-center gap-3;
            }
            .time-input {
                @apply w-20 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .time-select {
                @apply flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .countdown {
                @apply text-xs font-medium px-2 py-0.5 rounded-lg bg-primary/10 text-primary;
            }
            /* 排序样式 */
            .sortable {
                cursor: pointer;
                user-select: none;
                position: relative;
            }
            .sortable:hover {
                background-color: rgba(0, 0, 0, 0.1);
            }
            .notification {
                @apply fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full;
            }
            .notification.show {
                @apply translate-x-0;
            }
            .notification.error {
                @apply bg-red-500;
            }
            .login-container {
                @apply flex items-center justify-center min-h-screen bg-dark-bg;
            }
            .login-container.hidden {
                display: none !important;
            }
            .hidden {
                display: none !important;
            }
            .login-card {
                @apply bg-dark-card rounded-2xl shadow-xl p-8 max-w-md w-full border border-gray-700;
            }
            .admin-container {
                @apply p-6 max-w-7xl mx-auto;
            }
            .data-table {
                @apply w-full bg-dark-card rounded-xl shadow-lg border border-gray-700 overflow-hidden;
            }
            .data-table th {
                @apply bg-dark-hover text-left py-2 px-4 text-sm font-semibold text-dark-textSecondary;
            }
            .data-table td {
                @apply py-2 px-4 text-sm border-t border-gray-700;
            }
            .action-btn {
                @apply p-2 rounded-lg text-sm transition-colors;
            }
            .edit-btn {
                @apply text-primary hover:bg-primary/10;
            }
            /* 状态样式 */
            .status-ongoing {
                background-color: var(--ongoing-color, #10b981);
            }
            .status-not-started {
                background-color: var(--upcoming-color, #60a5fa);
            }
            .status-ended {
                background-color: var(--completed-color, #64748b);
            }
            .delete-btn {
                @apply text-red-500 hover:bg-red-500/10;
            }
            .save-btn {
                @apply bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors;
            }
            .cancel-btn {
                @apply bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors;
            }
        }
    </style>
    
    <!-- 主题变量定义 -->
    <style>
        :root {
            /* 暗黑主题变量 */
            --bg-color: #1e293b;
            --card-color: #334155;
            --card-alt-color: #2d3748;
            --text-color: #f8fafc;
            --text-secondary: #cbd5e1;
            --hover-color: #475569;
            --border-color: #4b5563;
            --primary-color: #60a5fa;
            --priority-high: #ef4444;
            --priority-medium: #f59e0b;
            --priority-low: #10b981;
            --priority-none: #64748b;
            --ongoing-color: #10b981;
            --upcoming-color: #3b82f6;
            --completed-color: #64748b;
        }

        [data-theme="light"] {
            --bg-color: #f5f5f5;
            --card-color: #ffffff;
            --card-alt-color: #f8fafc;
            --text-color: #1e293b;
            --text-secondary: #64748b;
            --hover-color: #f1f5f9;
            --border-color: #e2e8f0;
            --primary-color: #3b82f6;
            --priority-high: #dc2626;
            --priority-medium: #d97706;
            --priority-low: #059669;
            --priority-none: #6b7280;
            --ongoing-color: #059669;
            --upcoming-color: #3b82f6;
            --completed-color: #6b7280;
        }

        /* 应用主题变量 */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .bg-dark-bg {
            background-color: var(--bg-color) !important;
        }

        .bg-dark-card {
            background-color: var(--card-color) !important;
        }

        .bg-dark-card-alt {
            background-color: var(--card-alt-color) !important;
        }

        .text-dark-text {
            color: var(--text-color) !important;
        }

        .text-dark-textSecondary {
            color: var(--text-secondary) !important;
        }

        .bg-dark-hover:hover {
            background-color: var(--hover-color) !important;
        }

        .border-gray-700 {
            border-color: var(--border-color) !important;
        }

        /* 管理容器样式 */
        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 表格样式优化 */
        table {
            width: 100%;
        }
        
        .data-table {
            overflow-x: auto;
        }
        
        /* 优先级标签样式 */
        .priority-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        
        .priority-high {
            background-color: var(--priority-high);
            color: white;
        }
        
        .priority-medium {
            background-color: var(--priority-medium);
            color: white;
        }
        
        .priority-low {
            background-color: var(--priority-low);
            color: white;
        }
        
        .priority-none {
            background-color: var(--priority-none);
            color: white;
        }
    </style>
</head>
<body class="bg-dark-bg min-h-screen">
    <!-- 登录界面 -->
    <div id="login-container" class="login-container">
        <div class="login-card">
            <div class="flex justify-center mb-4">
                <img src="icons/logo.png" alt="Sky Admin Logo" class="w-24 h-24 object-contain">
            </div>
            <h2 class="text-2xl font-bold text-center mb-6 text-dark-text">Sky 事件 管理 </h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-dark-textSecondary mb-1">密码</label>
                    <input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition-colors">
                    登录
                </button>
            </form>
            <p id="login-error" class="mt-4 text-center text-red-500 text-sm hidden">密码错误</p>
        </div>
    </div>
    
    <!-- 管理后台界面 -->
    <div id="admin-container" class="admin-container hidden">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold text-dark-text">Sky 事件 管理</h1>
                <a href="163/admin.html" class="p-2 rounded-lg transition-colors" title="切换到光遇管理">
                    <img src="icons/163.png" alt="切换到光遇管理" style="width: 48px; height: 48px; object-fit: contain;">
                </a>
            </div>
            <div class="flex gap-3">
                <button id="add-task-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fa fa-plus"></i>
                    添加事件
                </button>
                <button id="logout-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                    退出
                </button>
            </div>
        </div>
        
        <!-- 数据表格 -->
        <div class="data-table mb-6">
            <table class="w-full border-collapse">
                <thead class="bg-dark-card/50">
                    <tr>
                        <th class="py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;">序号</th>
                        <th class="sortable py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;" data-sort-key="id">ID</th>
                        <th class="sortable py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;" data-sort-key="name">事件名称</th>
                        <th class="sortable py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;" data-sort-key="priority">优先级</th>
                        <th class="sortable py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;" data-sort-key="startDate">开始时间</th>
                        <th class="sortable py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;" data-sort-key="duration">持续时间</th>
                        <th class="py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;">地点</th>
                        <th class="sortable py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;" data-sort-key="displayThreshold">显示阈值</th>
                        <th class="py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;">重复类型</th>
                        <th class="py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;">状态</th>
                        <th class="py-2 px-4 text-center text-dark-textSecondary font-medium text-sm" style="text-align: center;">操作</th>
                    </tr>
                </thead>
                <tbody id="tasks-table-body">
                    <!-- 数据将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 添加/编辑事件模态框 -->
    <div id="task-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-semibold text-dark-text">添加新事件</h3>
                <button id="close-modal" class="text-dark-textSecondary hover:text-dark-text">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="task-form">
                <input type="hidden" id="task-id">
                
                <div class="mb-4">
                    <label for="task-name" class="block text-sm font-medium text-dark-textSecondary mb-1">事件名称</label>
                    <input type="text" id="task-name" name="task-name" required class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div class="mb-4">
                    <label for="task-priority" class="block text-sm font-medium text-dark-textSecondary mb-1">优先级</label>
                    <select id="task-priority" name="task-priority" required class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="high">高 (红色)</option>
                        <option value="medium" selected>中 (黄色)</option>
                        <option value="low">低 (绿色)</option>
                        <option value="none">无 (灰色)</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="display-threshold" class="block text-sm font-medium text-dark-textSecondary mb-1">提前提醒时间</label>
                    <div class="flex gap-3">
                        <input type="number" id="display-threshold" name="display-threshold" min="1" value="10" class="flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <select id="display-threshold-unit" name="display-threshold-unit" class="flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="minute">分钟</option>
                            <option value="hour">小时</option>
                            <option value="day">天</option>
                            <option value="week">周</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">开始时间</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <input type="date" id="start-date" name="start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <input type="time" id="start-time" name="start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">持续时间</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <input type="number" id="task-duration" name="duration" min="0" value="60" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <select id="duration-unit" name="duration-unit" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="minute">分钟</option>
                                <option value="hour">小时</option>
                                <option value="day">天</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="location" class="block text-sm font-medium text-dark-textSecondary mb-1">地点</label>
                    <input type="text" id="location" name="location" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入事件地点">
                </div>
                
                <div class="mb-4">
                    <label for="notes" class="block text-sm font-medium text-dark-textSecondary mb-1">备注</label>
                    <textarea id="notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入事件备注"></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="recurrence-type" class="block text-sm font-medium text-dark-textSecondary mb-1">重复方式</label>
                    <select id="recurrence-type" name="recurrence-type" required class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="none">不重复</option>
                        <option value="daily">每天</option>
                        <option value="weekly">每周</option>
                        <option value="monthly">每月</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                
                <!-- 每周重复选项 -->
                <div id="weekly-options" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">选择星期几</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" name="weekday" value="1" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                            <span>周一</span>
                        </label>
                        <label class="flex items-center gap-1">
                            <input type="checkbox" name="weekday" value="2" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                            <span>周二</span>
                        </label>
                        <label class="flex items-center gap-1">
                            <input type="checkbox" name="weekday" value="3" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                            <span>周三</span>
                        </label>
                        <label class="flex items-center gap-1">
                            <input type="checkbox" name="weekday" value="4" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                            <span>周四</span>
                        </label>
                        <label class="flex items-center gap-1">
                            <input type="checkbox" name="weekday" value="5" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                            <span>周五</span>
                        </label>
                        <label class="flex items-center gap-1">
                            <input type="checkbox" name="weekday" value="6" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                            <span>周六</span>
                        </label>
                        <label class="flex items-center gap-1">
                            <input type="checkbox" name="weekday" value="7" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                            <span>周日</span>
                        </label>
                    </div>
                </div>
                
                <!-- 每月重复选项 -->
                <div id="monthly-options" class="mb-4 hidden">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-dark-textSecondary mb-2">选择日期</label>
                        <div class="grid grid-cols-7 gap-2">
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthday" value="1" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>1</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthday" value="8" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>8</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthday" value="15" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>15</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthday" value="22" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>22</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-textSecondary mb-2">或选择星期几</label>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthweekday" value="1" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>周一</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthweekday" value="2" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>周二</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthweekday" value="3" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>周三</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthweekday" value="4" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>周四</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthweekday" value="5" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>周五</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthweekday" value="6" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>周六</span>
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="checkbox" name="monthweekday" value="7" class="rounded border-gray-600 bg-dark-bg text-primary focus:ring-primary">
                                <span>周日</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 自定义重复选项 -->
                <div id="custom-options" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">间隔设置</label>
                    <div class="flex gap-3">
                        <input type="number" id="interval-count" name="interval-count" min="1" value="1" class="flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <select id="interval-unit" name="interval-unit" class="flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="hour">小时</option>
                            <option value="day">天</option>
                            <option value="week">周</option>
                            <option value="month">月</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-task-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-colors">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 通知组件 -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
    </div>
    
    <!-- 确认删除模态框 -->
    <div id="confirm-delete-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-dark-text">确认删除</h3>
                <button id="close-delete-modal" class="text-dark-textSecondary hover:text-dark-text">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <p class="text-dark-textSecondary mb-6">您确定要删除这个事件吗？此操作无法撤销。</p>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 border border-gray-600 rounded-lg text-dark-text hover:bg-dark-hover transition-colors">取消</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    确认删除
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Supabase 配置
        const supabaseUrl = 'https://prusinqhwaduefiuqkwt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydXNpbnFod2FkdWVmaXVxa3d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTI5OTYsImV4cCI6MjA3OTU4ODk5Nn0.X__p8sP8ZdaOBGsbFWnhAdgLnjTXN-Y8YMVL5csVQ2Y';
        // 创建Supabase客户端实例，添加错误处理以应对CDN加载失败
        let supabase;
        try {
            // 检查window.supabase是否存在
            if (window.supabase) {
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            } else {
                // 如果CDN加载失败，设置supabase为null
                supabase = null;
                console.log('Supabase CDN加载失败，将使用本地存储模式运行');
            }
        } catch (error) {
            // 捕获任何初始化错误
            supabase = null;
            console.error('Supabase初始化失败:', error);
        }
        
        // 登录密码（简单示例，实际应用中应使用更安全的认证方式）
        const ADMIN_PASSWORD = 'admin123'; // 可以修改为更复杂的密码
        
        // 当前登录状态
        let isLoggedIn = false;
        
        // 超时退出相关变量
        const SESSION_TIMEOUT = 15 * 60 * 1000; // 15分钟超时
        let sessionTimer = null;
        
        // 任务数据
        let tasks = [];
        
        // DOM 元素
        const loginContainer = document.getElementById('login-container');
        const adminContainer = document.getElementById('admin-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const tasksTableBody = document.getElementById('tasks-table-body');
        const addTaskBtn = document.getElementById('add-task-btn');
        const taskModal = document.getElementById('task-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelTaskBtn = document.getElementById('cancel-task-btn');
        const taskForm = document.getElementById('task-form');
        const modalTitle = document.getElementById('modal-title');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        // 确认删除模态框元素
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const closeDeleteModalBtn = document.getElementById('close-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        let currentTaskIdToDelete = null;
        
        // 显示通知
        function showNotification(message, isError = false) {
            notificationText.textContent = message;
            
            if (isError) {
                notification.classList.add('error');
            } else {
                notification.classList.remove('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 重置会话计时器
        function resetSessionTimer() {
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            sessionTimer = setTimeout(() => {
                autoLogout();
            }, SESSION_TIMEOUT);
        }
        
        // 自动退出登录
        function autoLogout() {
            isLoggedIn = false;
            localStorage.removeItem('adminLoggedIn');
            adminContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            loginForm.reset();
            loginError.classList.add('hidden');
            showNotification('登录超时，已自动退出', false);
        }
        
        // 检查登录状态
        function checkLogin() {
            isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (isLoggedIn) {
                loginContainer.classList.add('hidden');
                adminContainer.classList.remove('hidden');
                loadTasks();
                // 启动会话计时器
                resetSessionTimer();
                // 添加用户交互事件监听器
                addSessionEventListeners();
            }
        }
        
        // 添加用户交互事件监听器，用于重置计时器
        function addSessionEventListeners() {
            const events = ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'];
            events.forEach(event => {
                document.addEventListener(event, resetSessionTimer);
            });
        }
        
        // 登录验证
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            if (password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                localStorage.setItem('adminLoggedIn', 'true');
                loginContainer.classList.add('hidden');
                adminContainer.classList.remove('hidden');
                await loadTasks();
                // 启动会话计时器
                resetSessionTimer();
                // 添加用户交互事件监听器
                addSessionEventListeners();
            } else {
                loginError.classList.remove('hidden');
            }
        });
        
        // 退出登录
        logoutBtn.addEventListener('click', () => {
            isLoggedIn = false;
            localStorage.removeItem('adminLoggedIn');
            adminContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            loginForm.reset();
            loginError.classList.add('hidden');
            // 清除会话计时器
            if (sessionTimer) {
                clearTimeout(sessionTimer);
                sessionTimer = null;
            }
        });
        
        // 页面加载时检查登录状态
        window.addEventListener('DOMContentLoaded', () => {
            checkLogin();
        });
        
        // 从localStorage加载数据
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('timeProjectReminderTasks');
                if (savedData) {
                    return JSON.parse(savedData);
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
            return null;
        }

        // 从 Supabase 加载任务
        // 合并数据（基于时间戳的冲突解决）
        function mergeData(localData, remoteData) {
            // 确保数据数组有效
            const local = localData || [];
            const remote = remoteData || [];
            
            // 如果只有远程数据，直接返回
            if (local.length === 0) {
                return remote;
            }
            
            // 如果只有本地数据，直接返回
            if (remote.length === 0) {
                return local;
            }
            
            // 创建映射表，方便查找任务
            const localTasksMap = new Map(local.map(task => [task.id, task]));
            const remoteTasksMap = new Map(remote.map(task => [task.id, task]));
            
            const mergedTasks = [];
            const processedIds = new Set();
            
            // 遍历所有远程任务ID，确保远程数据优先
            for (const [id, remoteTask] of remoteTasksMap.entries()) {
                if (processedIds.has(id)) continue;
                
                const localTask = localTasksMap.get(id);
                
                if (!localTask) {
                    // 本地没有，使用远程数据
                    mergedTasks.push(remoteTask);
                } else {
                    // 本地和远程都有，比较时间戳，使用更新的版本
                    const localUpdatedAt = new Date(localTask.updated_at || 0);
                    const remoteUpdatedAt = new Date(remoteTask.updated_at || 0);
                    
                    if (remoteUpdatedAt > localUpdatedAt) {
                        // 远程更新，使用远程数据
                        mergedTasks.push(remoteTask);
                        console.log(`任务 ${id} 使用远程数据，远程时间: ${remoteUpdatedAt}，本地时间: ${localUpdatedAt}`);
                    } else {
                        // 本地更新，使用本地数据
                        mergedTasks.push(localTask);
                        console.log(`任务 ${id} 使用本地数据，远程时间: ${remoteUpdatedAt}，本地时间: ${localUpdatedAt}`);
                    }
                }
                
                processedIds.add(id);
            }
            
            // 添加本地独有的任务
            for (const [id, localTask] of localTasksMap.entries()) {
                if (!processedIds.has(id)) {
                    mergedTasks.push(localTask);
                    console.log(`任务 ${id} 仅本地存在，添加到合并结果`);
                }
            }
            
            return mergedTasks;
        }
        
        // 保存数据到 Supabase
        async function saveData(data, retry = 0) {
            try {
                // 确保数据数组有效
                const validData = data || [];
                
                // 更新每个任务的时间戳，确保本地修改被正确标记
                const updatedData = validData.map(task => ({
                    ...task,
                    updated_at: new Date().toISOString() // 始终使用当前时间作为更新时间
                }));
                
                // 保存数据到localStorage（直接调用localStorage.setItem，避免递归）
                localStorage.setItem('timeProjectReminderTasks', JSON.stringify(updatedData));
                
                if (!supabase) {
                    console.log('Supabase 未初始化，仅保存到本地存储');
                    showNotification('数据已保存到本地', false);
                    return;
                }
                
                // 处理数据，确保格式正确
                const processedData = updatedData.map(task => ({
                    ...task,
                    // 确保recurrence是一个对象，防止NOT NULL约束错误
                    recurrence: task.recurrence || { type: 'none', duration: 1, durationUnit: 'hour' }
                }));
                
                try {
                    // 使用upsert操作更新或插入数据
                    const { error } = await supabase
                        .from('tasks')
                        .upsert(processedData, { onConflict: 'id' });
                    
                    if (error) {
                        console.error('Supabase 保存失败:', error);
                        showNotification('数据同步失败: ' + error.message, true);
                    } else {
                        showNotification('数据已成功同步到云端', false);
                    }
                } catch (fetchError) {
                    // 处理网络错误，避免影响本地保存
                    console.error('Supabase 网络请求失败:', fetchError);
                    showNotification('数据已保存到本地，但云端同步失败（网络问题）', true);
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                showNotification('保存数据失败: ' + error.message, true);
            }
        }
        
        async function loadTasks() {
            try {
                // 检查 supabase 是否初始化
                if (!supabase) {
                    console.log('Supabase 未初始化，尝试从localStorage加载数据');
                    const localData = loadFromLocalStorage();
                    tasks = localData || [];
                    renderTasksTable();
                    showNotification('Supabase 未初始化，使用本地存储数据', false);
                    return;
                }
                
                showNotification('正在从云端加载最新数据...', false);
                
                const { data: remoteData, error } = await supabase
                    .from('tasks')
                    .select('*');
                
                if (error) {
                    console.error('Supabase 加载失败:', error);
                    // 云端加载失败时，仅作为后备使用本地数据
                    const localData = loadFromLocalStorage();
                    tasks = localData || [];
                    renderTasksTable();
                    showNotification('数据加载失败，使用本地存储数据作为后备', true);
                } else {
                    // 后端直接使用云端数据，忽略本地缓存
                    console.log('成功从云端加载数据，共', remoteData.length, '个任务');
                    tasks = remoteData || [];
                    // 将云端数据保存到localStorage作为备份
                    await saveData(tasks);
                    renderTasksTable();
                    showNotification('数据已成功从云端同步', false);
                }
            } catch (error) {
                console.error('加载任务失败:', error);
                showNotification('加载任务失败: ' + error.message, true);
            }
        }
        
        // 排序配置
        let sortConfig = {
            key: null,
            direction: 1
        };
        
        // 渲染任务表格
        function renderTasksTable() {
            tasksTableBody.innerHTML = '';
            
            // 排序任务
            const sortedTasks = [...tasks].sort((a, b) => {
                let aVal, bVal;
                
                // 如果没有排序键，不排序
                if (!sortConfig.key) {
                    return 0;
                }
                
                switch (sortConfig.key) {
                    case 'id':
                        aVal = parseInt(a.id);
                        bVal = parseInt(b.id);
                        return (aVal - bVal) * sortConfig.direction;
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        return aVal.localeCompare(bVal) * sortConfig.direction;
                    case 'priority':
                        const priorityOrder = { high: 3, medium: 2, low: 1, none: 0 };
                        aVal = priorityOrder[a.priority] || 0;
                        bVal = priorityOrder[b.priority] || 0;
                        return (aVal - bVal) * sortConfig.direction;
                    case 'startDate':
                        aVal = new Date(`${a.startDate} ${a.startTime}`).getTime();
                        bVal = new Date(`${b.startDate} ${b.startTime}`).getTime();
                        return (aVal - bVal) * sortConfig.direction;
                    case 'duration':
                        aVal = parseFloat(a.duration) || 0;
                        bVal = parseFloat(b.duration) || 0;
                        return (aVal - bVal) * sortConfig.direction;
                    case 'displayThreshold':
                        aVal = a.displayThreshold;
                        bVal = b.displayThreshold;
                        return (aVal - bVal) * sortConfig.direction;
                    default:
                        return 0;
                }
            });
            
            sortedTasks.forEach((task, index) => {
                const row = document.createElement('tr');
                row.className = `hover:bg-dark-hover/30 transition-colors ${index % 2 === 0 ? 'bg-dark-card' : 'bg-dark-card-alt'}`;
                
                // 获取优先级文本
                const priorityText = {
                    high: '高',
                    medium: '中',
                    low: '低',
                    none: '无'
                }[task.priority] || '无';
                
                // 获取重复类型文本
                const recurrenceText = {
                    none: '不重复',
                    daily: '每天',
                    weekly: '每周',
                    monthly: '每月',
                    custom: '自定义'
                }[task.recurrence.type] || '不重复';
                
                // 持续时间显示
                const durationUnitNames = {
                    'minute': '分钟',
                    'hour': '小时',
                    'day': '天',
                    'week': '周'
                };
                const durationText = `${task.recurrence.duration}${durationUnitNames[task.recurrence.durationUnit]}`;
                
                // 显示阈值单位转换
                const thresholdUnitNames = {
                    'minute': '分钟',
                    'hour': '小时',
                    'day': '天',
                    'week': '周'
                };
                const thresholdText = `${task.displayThreshold}${thresholdUnitNames[task.displayThresholdUnit]}`;
                
                // 转换时间单位为毫秒
                function convertToMilliseconds(value, unit) {
                    const units = {
                        minute: 60 * 1000,
                        hour: 60 * 60 * 1000,
                        day: 24 * 60 * 60 * 1000,
                        week: 7 * 24 * 60 * 60 * 1000
                    };
                    return value * (units[unit] || units.minute);
                }
                
                // 计算事件的下次发生时间
                function getNextOccurrence(task, now) {
                    const [startYear, startMonth, startDay] = task.startDate.split('-').map(Number);
                    const [startHour, startMinute] = task.startTime.split(':').map(Number);
                    const initialStart = new Date(startYear, startMonth - 1, startDay, startHour, startMinute);
                    
                    // 对于非重复事件，直接返回初始开始时间
                    if (task.recurrence.type === "none") {
                        return initialStart;
                    }
                    
                    let intervalMs;
                    switch(task.recurrence.type) {
                        case "daily":
                            intervalMs = 24 * 60 * 60 * 1000;
                            break;
                        case "weekly":
                            intervalMs = 7 * 24 * 60 * 60 * 1000;
                            break;
                        case "custom":
                            intervalMs = convertToMilliseconds(task.recurrence.count, task.recurrence.unit);
                            break;
                        default:
                            intervalMs = 24 * 60 * 60 * 1000;
                    }
                    
                    const timeDiff = now - initialStart;
                    const intervals = Math.floor(timeDiff / intervalMs);
                    const lastOccurrence = new Date(initialStart.getTime() + intervals * intervalMs);
                    
                    const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                    
                    // 如果当前时间在最后一次发生的持续时间内，返回最后一次发生时间
                    if (now <= lastOccurrence.getTime() + durationMs) {
                        return lastOccurrence;
                    }
                    
                    // 否则返回下次发生时间
                    return new Date(lastOccurrence.getTime() + intervalMs);
                }
                
                // 计算时间差的显示文本
                function formatTimeDiff(ms) {
                    const days = Math.floor(ms / (24 * 60 * 60 * 1000));
                    const hours = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                    const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
                    
                    if (days > 0) {
                        return `${days}天后`;
                    } else if (hours > 0) {
                        return `${hours}小时后`;
                    } else {
                        return `${minutes}分钟后`;
                    }
                }
                
                // 计算事件状态
                const now = new Date();
                const nextOccurrence = getNextOccurrence(task, now);
                const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                const startTime = nextOccurrence;
                const endTime = new Date(nextOccurrence.getTime() + durationMs);
                
                let status = '未开始';
                let statusClass = 'status-not-started';
                
                if (now >= startTime && now <= endTime) {
                    status = '进行中';
                    statusClass = 'status-ongoing';
                } else if (task.recurrence.type === "none" && now > endTime) {
                    status = '已结束';
                    statusClass = 'status-ended';
                } else {
                    // 对于循环事件，显示距离下次开始的时间
                    const timeUntilNext = startTime - now;
                    status = `${formatTimeDiff(timeUntilNext)}开始`;
                    statusClass = 'status-not-started';
                }
                
                row.innerHTML = `
                    <td class="text-dark-textSecondary py-2 px-4 text-center">${index + 1}</td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center">${task.id}</td>
                    <td class="text-dark-text font-medium py-2 px-4 text-center">${task.name}</td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center"><span class="priority-tag priority-${task.priority || 'none'}">${priorityText}</span></td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center">${task.startDate} ${task.startTime}</td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center">${durationText}</td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center">${task.location || '-'}</td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center">${thresholdText}</td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center">${recurrenceText}</td>
                    <td class="text-dark-textSecondary py-2 px-4 text-center">
                        <span class="${statusClass} text-white text-xs px-2 py-1 rounded-full">
                            ${status}
                        </span>
                    </td>
                    <td class="py-2 px-4 text-center">
                        <div class="relative inline-block">
                            <button class="action-btn edit-btn" onclick="editTask(${task.id})" title="编辑">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="action-btn dropdown-btn" onclick="toggleActionDropdown(${task.id})" title="更多操作">
                                <i class="fa fa-ellipsis-v"></i>
                            </button>
                            <div id="action-dropdown-${task.id}" class="absolute right-0 mt-2 bg-dark-card rounded-lg shadow-xl z-10 hidden border border-gray-700">
                                <button class="block w-full text-left px-4 py-2 text-sm text-dark-text hover:bg-dark-hover/50 transition-colors" onclick="showConfirmDeleteModal(${task.id})"><i class="fa fa-trash mr-2"></i>删除</button>
                            </div>
                        </div>
                    </td>
                `;
                
                tasksTableBody.appendChild(row);
            });
        }
        
        // 添加新任务
        addTaskBtn.addEventListener('click', () => {
            taskForm.reset();
            document.getElementById('task-id').value = '';
            document.getElementById('task-duration').value = 60;
            document.getElementById('duration-unit').value = 'minute';
            document.getElementById('interval-count').value = 1;
            document.getElementById('interval-unit').value = 'day';
            
            // 重置所有重复选项
            document.querySelectorAll('input[name="weekday"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="monthday"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="monthweekday"]').forEach(cb => cb.checked = false);
            
            // 隐藏所有重复选项面板
            weeklyOptions.classList.add('hidden');
            monthlyOptions.classList.add('hidden');
            customOptions.classList.add('hidden');
            
            modalTitle.textContent = '添加新事件';
            taskModal.classList.remove('hidden');
        });
        
        // 关闭模态框
        closeModalBtn.addEventListener('click', () => {
            taskModal.classList.add('hidden');
        });
        
        cancelTaskBtn.addEventListener('click', () => {
            taskModal.classList.add('hidden');
        });
        
        // 编辑任务
        window.editTask = function(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('display-threshold').value = task.displayThreshold;
            document.getElementById('display-threshold-unit').value = task.displayThresholdUnit;
            document.getElementById('start-date').value = task.startDate;
            document.getElementById('start-time').value = task.startTime;
            document.getElementById('task-duration').value = task.recurrence?.duration || 60;
            document.getElementById('duration-unit').value = task.recurrence?.durationUnit || 'minute';
            document.getElementById('location').value = task.location || '';
            document.getElementById('notes').value = task.notes || '';
            document.getElementById('recurrence-type').value = task.recurrence.type;
            
            // 重置所有重复选项
            document.querySelectorAll('input[name="weekday"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="monthday"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="monthweekday"]').forEach(cb => cb.checked = false);
            
            // 根据任务的重复类型设置相应的选项
            const recurrenceType = task.recurrence.type;
            showRecurrenceOptions(recurrenceType);
            
            switch(recurrenceType) {
                case "weekly":
                    if (task.recurrence.weekdays) {
                        task.recurrence.weekdays.forEach(day => {
                            const checkbox = document.querySelector(`input[name="weekday"][value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    break;
                case "monthly":
                    if (task.recurrence.weekdays) {
                        task.recurrence.weekdays.forEach(day => {
                            const checkbox = document.querySelector(`input[name="monthweekday"][value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    } else if (task.recurrence.days) {
                        task.recurrence.days.forEach(day => {
                            const checkbox = document.querySelector(`input[name="monthday"][value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    break;
                case "custom":
                    document.getElementById('interval-count').value = task.recurrence.count || 1;
                    document.getElementById('interval-unit').value = task.recurrence.unit || 'day';
                    break;
            }
            
            modalTitle.textContent = '编辑事件';
            taskModal.classList.remove('hidden');
        };
        
        // 显示确认删除模态框
        window.showConfirmDeleteModal = function(id) {
            currentTaskIdToDelete = id;
            confirmDeleteModal.classList.remove('hidden');
        };
        
        // 隐藏确认删除模态框
        function hideConfirmDeleteModal() {
            confirmDeleteModal.classList.add('hidden');
            currentTaskIdToDelete = null;
        }
        
        // 确认删除任务
        async function confirmDeleteTask() {
            if (!currentTaskIdToDelete) return;
            
            try {
                // 检查 supabase 是否初始化
                if (!supabase) {
                    // 直接从本地任务列表中删除
                    tasks = tasks.filter(t => t.id !== currentTaskIdToDelete);
                    // 保存到localStorage
                    await saveData(tasks);
                    // 更新表格
                    renderTasksTable();
                    showNotification('事件删除成功', false);
                } else {
                    // 从Supabase删除
                    const { error } = await supabase
                        .from('tasks')
                        .delete()
                        .eq('id', currentTaskIdToDelete);
                    
                    if (error) {
                        console.log('Supabase 删除失败，从本地存储中删除:', error);
                        // 直接从本地任务列表中删除
                        tasks = tasks.filter(t => t.id !== currentTaskIdToDelete);
                        // 保存到localStorage
                        await saveData(tasks);
                        // 更新表格
                        renderTasksTable();
                        showNotification('事件已在本地删除', false);
                    } else {
                        // 从本地任务列表中删除
                        tasks = tasks.filter(t => t.id !== currentTaskIdToDelete);
                        // 更新表格
                        renderTasksTable();
                        showNotification('事件删除成功', false);
                    }
                }
            } catch (error) {
                console.error('删除任务失败:', error);
                // 从本地存储中删除任务
                tasks = tasks.filter(t => t.id !== currentTaskIdToDelete);
                await saveData(tasks);
                renderTasksTable();
                showNotification('事件已在本地删除', false);
            } finally {
                hideConfirmDeleteModal();
            }
        };
        
        // 绑定确认删除事件
        closeDeleteModalBtn.addEventListener('click', hideConfirmDeleteModal);
        cancelDeleteBtn.addEventListener('click', hideConfirmDeleteModal);
        confirmDeleteBtn.addEventListener('click', confirmDeleteTask);
        // 点击模态框背景关闭
        confirmDeleteModal.querySelector('.modal-backdrop').addEventListener('click', hideConfirmDeleteModal);
        
        // 获取重复选项元素
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');
        const customOptions = document.getElementById('custom-options');
        const recurrenceTypeSelect = document.getElementById('recurrence-type');
        
        // 显示对应的重复选项面板
        function showRecurrenceOptions(type) {
            weeklyOptions.classList.add('hidden');
            monthlyOptions.classList.add('hidden');
            customOptions.classList.add('hidden');
            
            if (type === 'weekly') {
                weeklyOptions.classList.remove('hidden');
            } else if (type === 'monthly') {
                monthlyOptions.classList.remove('hidden');
            } else if (type === 'custom') {
                customOptions.classList.remove('hidden');
            }
        }
        
        // 监听重复类型变化，显示对应的选项面板
        recurrenceTypeSelect.addEventListener('change', (e) => {
            showRecurrenceOptions(e.target.value);
        });
        
        // 保存任务
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 获取任务ID，确保空字符串返回null而不是NaN
            const taskIdValue = document.getElementById('task-id').value;
            const id = taskIdValue ? parseInt(taskIdValue) || null : null;
            console.log('当前任务ID:', id, typeof id); // 添加调试信息
            const name = document.getElementById('task-name').value;
            const priority = document.getElementById('task-priority').value;
            const displayThreshold = parseInt(document.getElementById('display-threshold').value);
            const displayThresholdUnit = document.getElementById('display-threshold-unit').value;
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const duration = parseInt(document.getElementById('task-duration').value);
            const durationUnit = document.getElementById('duration-unit').value;
            const location = document.getElementById('location').value;
            const notes = document.getElementById('notes').value;
            const recurrenceType = document.getElementById('recurrence-type').value;
            
            // 构建任务数据，与index.html保持一致
            const taskData = {
                id: id,
                name: name,
                priority: priority,
                displayThreshold: parseInt(displayThreshold) || 10,
                displayThresholdUnit: displayThresholdUnit || "minute",
                startDate: startDate,
                startTime: startTime,
                duration: duration,
                durationUnit: durationUnit,
                location: location,
                notes: notes,
                recurrenceType: recurrenceType,
                // 处理重复选项
                weekdays: Array.from(document.querySelectorAll('input[name="weekday"]:checked')).map(cb => Number(cb.value)),
                monthdays: Array.from(document.querySelectorAll('input[name="monthday"]:checked')).map(cb => Number(cb.value)),
                monthweekdays: Array.from(document.querySelectorAll('input[name="monthweekday"]:checked')).map(cb => Number(cb.value)),
                intervalCount: parseInt(document.getElementById('interval-count').value) || 1,
                intervalUnit: document.getElementById('interval-unit').value
            };
            
            try {
                // 检查 supabase 是否初始化
                if (!supabase) {
                    // 使用本地模式保存任务
                    if (id) {
                        // 更新现有任务，与index.html的updateExistingTask函数逻辑保持一致
                        const taskIndex = tasks.findIndex(t => t.id === id);
                        if (taskIndex !== -1) {
                            const duration = parseInt(taskData.duration) || 10;
                            const durationUnit = taskData.durationUnit || "minute";
                            
                            tasks[taskIndex].name = taskData.name;
                            tasks[taskIndex].startDate = taskData.startDate;
                            tasks[taskIndex].startTime = taskData.startTime;
                            tasks[taskIndex].displayThreshold = taskData.displayThreshold;
                            tasks[taskIndex].displayThresholdUnit = taskData.displayThresholdUnit;
                            tasks[taskIndex].priority = taskData.priority;
                            tasks[taskIndex].duration = duration;
                            tasks[taskIndex].durationUnit = durationUnit;
                            tasks[taskIndex].location = taskData.location;
                            tasks[taskIndex].notes = taskData.notes;
                            tasks[taskIndex].recurrence.duration = duration;
                            tasks[taskIndex].recurrence.durationUnit = durationUnit;
                            tasks[taskIndex].recurrence.type = taskData.recurrenceType;
                            
                            // 清除旧的重复规则
                            delete tasks[taskIndex].recurrence.weekdays;
                            delete tasks[taskIndex].recurrence.days;
                            delete tasks[taskIndex].recurrence.count;
                            delete tasks[taskIndex].recurrence.unit;
                            
                            // 根据重复类型添加相应的规则
                            switch(taskData.recurrenceType) {
                                case "weekly":
                                    tasks[taskIndex].recurrence.weekdays = taskData.weekdays.length > 0 ? taskData.weekdays : [1];
                                    break;
                                case "monthly":
                                    if (taskData.monthweekdays.length > 0) {
                                        tasks[taskIndex].recurrence.weekdays = taskData.monthweekdays;
                                    } else if (taskData.monthdays.length > 0) {
                                        tasks[taskIndex].recurrence.days = taskData.monthdays;
                                    } else {
                                        tasks[taskIndex].recurrence.days = [1];
                                    }
                                    break;
                                case "custom":
                                    tasks[taskIndex].recurrence.count = taskData.intervalCount;
                                    tasks[taskIndex].recurrence.unit = taskData.intervalUnit;
                                    break;
                            }
                        }
                    } else {
                        // 添加新任务，与index.html的addNewTask函数逻辑保持一致
                        const duration = parseInt(taskData.duration) || 10;
                        const durationUnit = taskData.durationUnit || "minute";
                        
                        const newTask = {
                            name: taskData.name,
                            startDate: taskData.startDate || new Date().toISOString().split('T')[0],
                            startTime: taskData.startTime || new Date().toTimeString().split(':').slice(0, 2).join(':'),
                            displayThreshold: taskData.displayThreshold,
                            displayThresholdUnit: taskData.displayThresholdUnit,
                            priority: taskData.priority,
                            duration: duration,
                            durationUnit: durationUnit,
                            location: taskData.location,
                            notes: taskData.notes,
                            id: Date.now(),
                            recurrence: {
                                duration: duration,
                                durationUnit: durationUnit,
                                type: taskData.recurrenceType
                            }
                        };
                        
                        // 根据重复类型添加相应的规则
                        switch(taskData.recurrenceType) {
                            case "weekly":
                                newTask.recurrence.weekdays = taskData.weekdays.length > 0 ? taskData.weekdays : [1];
                                break;
                            case "monthly":
                                if (taskData.monthweekdays.length > 0) {
                                    newTask.recurrence.weekdays = taskData.monthweekdays;
                                } else if (taskData.monthdays.length > 0) {
                                    newTask.recurrence.days = taskData.monthdays;
                                } else {
                                    newTask.recurrence.days = [1];
                                }
                                break;
                            case "custom":
                                newTask.recurrence.count = taskData.intervalCount;
                                newTask.recurrence.unit = taskData.intervalUnit;
                                break;
                        }
                        
                        tasks.push(newTask);
                    }
                    
                    // 保存到localStorage
                    await saveData(tasks);
                    renderTasksTable();
                    taskModal.classList.add('hidden');
                    showNotification('事件已在本地更新');
                    return;
                }
                
                // 构建与index.html一致的taskData格式，用于Supabase
                const now = new Date().toISOString();
                const supabaseTaskData = {
                    name: taskData.name,
                    priority: taskData.priority,
                    displayThreshold: taskData.displayThreshold,
                    displayThresholdUnit: taskData.displayThresholdUnit,
                    startDate: taskData.startDate,
                    startTime: taskData.startTime,
                    duration: taskData.duration,
                    durationUnit: taskData.durationUnit,
                    location: taskData.location,
                    notes: taskData.notes,
                    recurrence: {
                        type: taskData.recurrenceType,
                        duration: taskData.duration,
                        durationUnit: taskData.durationUnit
                    },
                    updated_at: now
                };
                
                // 只有在更新现有任务时才添加id字段
                if (id) {
                    supabaseTaskData.id = id;
                } else {
                    // 新任务添加created_at字段
                    supabaseTaskData.created_at = now;
                }
                
                // 根据重复类型添加相应的规则
                switch(taskData.recurrenceType) {
                    case "weekly":
                        supabaseTaskData.recurrence.weekdays = taskData.weekdays.length > 0 ? taskData.weekdays : [1];
                        break;
                    case "monthly":
                        if (taskData.monthweekdays.length > 0) {
                            supabaseTaskData.recurrence.weekdays = taskData.monthweekdays;
                        } else if (taskData.monthdays.length > 0) {
                            supabaseTaskData.recurrence.days = taskData.monthdays;
                        } else {
                            supabaseTaskData.recurrence.days = [1];
                        }
                        break;
                    case "custom":
                        supabaseTaskData.recurrence.count = taskData.intervalCount;
                        supabaseTaskData.recurrence.unit = taskData.intervalUnit;
                        break;
                }
                
                let result;
                if (id) {
                    // 更新现有任务
                    result = await supabase
                        .from('tasks')
                        .update(supabaseTaskData)
                        .eq('id', id);
                    
                    if (result.error) {
                        console.log('Supabase 更新失败，使用本地存储更新:', result.error);
                        // 使用本地模式更新任务
                        const taskIndex = tasks.findIndex(t => t.id === id);
                        if (taskIndex !== -1) {
                            const duration = parseInt(taskData.duration) || 10;
                            const durationUnit = taskData.durationUnit || "minute";
                            const now = new Date().toISOString();
                            
                            tasks[taskIndex].name = taskData.name;
                            tasks[taskIndex].startDate = taskData.startDate;
                            tasks[taskIndex].startTime = taskData.startTime;
                            tasks[taskIndex].displayThreshold = taskData.displayThreshold;
                            tasks[taskIndex].displayThresholdUnit = taskData.displayThresholdUnit;
                            tasks[taskIndex].priority = taskData.priority;
                            tasks[taskIndex].duration = duration;
                            tasks[taskIndex].durationUnit = durationUnit;
                            tasks[taskIndex].location = taskData.location;
                            tasks[taskIndex].notes = taskData.notes;
                            tasks[taskIndex].recurrence.duration = duration;
                            tasks[taskIndex].recurrence.durationUnit = durationUnit;
                            tasks[taskIndex].recurrence.type = taskData.recurrenceType;
                            tasks[taskIndex].updated_at = now;
                            
                            // 清除旧的重复规则
                            delete tasks[taskIndex].recurrence.weekdays;
                            delete tasks[taskIndex].recurrence.days;
                            delete tasks[taskIndex].recurrence.count;
                            delete tasks[taskIndex].recurrence.unit;
                            
                            // 根据重复类型添加相应的规则
                            switch(taskData.recurrenceType) {
                                case "weekly":
                                    tasks[taskIndex].recurrence.weekdays = taskData.weekdays.length > 0 ? taskData.weekdays : [1];
                                    break;
                                case "monthly":
                                    if (taskData.monthweekdays.length > 0) {
                                        tasks[taskIndex].recurrence.weekdays = taskData.monthweekdays;
                                    } else if (taskData.monthdays.length > 0) {
                                        tasks[taskIndex].recurrence.days = taskData.monthdays;
                                    } else {
                                        tasks[taskIndex].recurrence.days = [1];
                                    }
                                    break;
                                case "custom":
                                    tasks[taskIndex].recurrence.count = taskData.intervalCount;
                                    tasks[taskIndex].recurrence.unit = taskData.intervalUnit;
                                    break;
                            }
                            
                            // 保存到localStorage
                            await saveData(tasks);
                            showNotification('事件已在本地更新', false);
                        }
                    } else {
                        // 更新本地数据
                        const index = tasks.findIndex(t => t.id === id);
                        if (index !== -1) {
                            tasks[index] = { ...tasks[index], ...taskData };
                        }
                        showNotification('事件已更新');
                    }
                } else {
                    // 添加新任务 - 不传递id，让Supabase自动生成，并返回生成的id
                    result = await supabase
                        .from('tasks')
                        .insert([supabaseTaskData])
                        .select('id');
                    
                    if (result.error) {
                        console.log('Supabase 添加失败，使用本地存储添加:', result.error);
                        // 使用本地模式添加任务，与index.html的addNewTask函数逻辑保持一致
                        const duration = parseInt(taskData.duration) || 10;
                        const durationUnit = taskData.durationUnit || "minute";
                        const now = new Date().toISOString();
                        
                        const newTask = {
                            name: taskData.name,
                            startDate: taskData.startDate || new Date().toISOString().split('T')[0],
                            startTime: taskData.startTime || new Date().toTimeString().split(':').slice(0, 2).join(':'),
                            displayThreshold: taskData.displayThreshold,
                            displayThresholdUnit: taskData.displayThresholdUnit || "minute",
                            priority: taskData.priority,
                            duration: duration,
                            durationUnit: durationUnit,
                            location: taskData.location,
                            notes: taskData.notes,
                            id: Date.now(),
                            created_at: now,
                            updated_at: now,
                            recurrence: {
                                duration: duration,
                                durationUnit: durationUnit,
                                type: taskData.recurrenceType
                            }
                        };
                        
                        // 根据重复类型添加相应的规则
                        switch(taskData.recurrenceType) {
                            case "weekly":
                                newTask.recurrence.weekdays = taskData.weekdays.length > 0 ? taskData.weekdays : [1];
                                break;
                            case "monthly":
                                if (taskData.monthweekdays.length > 0) {
                                    newTask.recurrence.weekdays = taskData.monthweekdays;
                                } else if (taskData.monthdays.length > 0) {
                                    newTask.recurrence.days = taskData.monthdays;
                                } else {
                                    newTask.recurrence.days = [1];
                                }
                                break;
                            case "custom":
                                newTask.recurrence.count = taskData.intervalCount;
                                newTask.recurrence.unit = taskData.intervalUnit;
                                break;
                        }
                        
                        tasks.push(newTask);
                        // 保存到localStorage
                        await saveData(tasks);
                        showNotification('事件已在本地添加', false);
                    } else {
                        // 更新本地数据，使用Supabase生成的id
                        if (result.data && result.data.length > 0) {
                            const newTask = { ...supabaseTaskData, id: result.data[0].id };
                            tasks.push(newTask);
                            showNotification('事件已添加');
                        } else {
                            // 如果无法获取生成的ID，使用本地模式添加
                            console.log('无法获取Supabase生成的ID，使用本地存储添加');
                            const duration = parseInt(taskData.duration) || 10;
                            const durationUnit = taskData.durationUnit || "minute";
                            
                            const newTask = {
                                name: taskData.name,
                                startDate: taskData.startDate || new Date().toISOString().split('T')[0],
                                startTime: taskData.startTime || new Date().toTimeString().split(':').slice(0, 2).join(':'),
                                displayThreshold: taskData.displayThreshold,
                                displayThresholdUnit: taskData.displayThresholdUnit || "minute",
                                priority: taskData.priority,
                                duration: duration,
                                durationUnit: durationUnit,
                                location: taskData.location,
                                notes: taskData.notes,
                                id: Date.now(),
                                recurrence: {
                                    duration: duration,
                                    durationUnit: durationUnit,
                                    type: taskData.recurrenceType
                                }
                            };
                            
                            // 根据重复类型添加相应的规则
                            switch(taskData.recurrenceType) {
                                case "weekly":
                                    newTask.recurrence.weekdays = taskData.weekdays.length > 0 ? taskData.weekdays : [1];
                                    break;
                                case "monthly":
                                    if (taskData.monthweekdays.length > 0) {
                                        newTask.recurrence.weekdays = taskData.monthweekdays;
                                    } else if (taskData.monthdays.length > 0) {
                                        newTask.recurrence.days = taskData.monthdays;
                                    } else {
                                        newTask.recurrence.days = [1];
                                    }
                                    break;
                                case "custom":
                                    newTask.recurrence.count = taskData.intervalCount;
                                    newTask.recurrence.unit = taskData.intervalUnit;
                                    break;
                            }
                            
                            tasks.push(newTask);
                            await saveData(tasks);
                            showNotification('事件已在本地添加', false);
                        }
                    }
                }
                
                // 更新localStorage，确保与前端同步
                await saveData(tasks);
                renderTasksTable();
                taskModal.classList.add('hidden');
            } catch (error) {
                console.error('保存任务失败:', error);
                showNotification('保存任务失败: ' + error.message, true);
            }
        });
        
        // 切换操作下拉菜单
        window.toggleActionDropdown = function(taskId) {
            const dropdown = document.getElementById(`action-dropdown-${taskId}`);
            // 关闭其他所有下拉菜单
            document.querySelectorAll('[id^="action-dropdown-"]').forEach(el => {
                if (el.id !== `action-dropdown-${taskId}`) {
                    el.classList.add('hidden');
                }
            });
            dropdown.classList.toggle('hidden');
        };
        
        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-btn') && !e.target.closest('[id^="action-dropdown-"]')) {
                document.querySelectorAll('[id^="action-dropdown-"]').forEach(el => {
                    el.classList.add('hidden');
                });
            }
        });
        
        // 绑定排序事件
        document.addEventListener('click', (e) => {
            const th = e.target.closest('th.sortable');
            if (!th) return;
            
            const sortKey = th.dataset.sortKey;
            if (sortKey === sortConfig.key) {
                // 切换排序方向
                sortConfig.direction *= -1;
            } else {
                // 新的排序键，默认升序
                sortConfig.key = sortKey;
                sortConfig.direction = 1;
            }
            
            // 更新排序指示器 - 不显示任何图标
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            th.classList.add(sortConfig.direction === 1 ? 'sort-asc' : 'sort-desc');
            
            // 重新渲染表格
            renderTasksTable();
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start-date').value = today;
        });
    </script>
</body>
</html>