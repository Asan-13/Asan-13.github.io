<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顶部滚动通知条</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="libs/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <script src="libs/@supabase/supabase-js/dist/umd/supabase.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #6b7280;
            --background-color: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
        }
        
        [data-theme="dark"] {
            --primary-color: #60a5fa;
            --secondary-color: #9ca3af;
            --background-color: #111827;
            --text-color: #f3f4f6;
            --border-color: #374151;
        }
        
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .scroll-container {
            @apply flex items-center gap-8 animate-scroll;
        }
        
        .animate-scroll {
            animation: scroll 20s linear infinite;
        }
        
        .notification-bar {
            @apply fixed top-0 left-0 right-0 z-50 bg-primary text-white py-2 px-4 shadow-lg transition-all duration-300;
        }
        
        .notification-item {
            @apply flex items-center gap-3 whitespace-nowrap;
        }
        
        .notification-content {
            @apply font-medium;
        }
        
        .notification-time {
            @apply text-xs opacity-80;
        }
        
        .notification-priority {
            @apply text-xs font-bold px-2 py-1 rounded-full;
        }
        
        .priority-high {
            @apply bg-red-500;
        }
        
        .priority-medium {
            @apply bg-yellow-500;
        }
        
        .priority-low {
            @apply bg-green-500;
        }
        
        .close-btn {
            @apply text-white hover:text-gray-200 transition-colors;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900" data-theme="light">
    <div id="notification-bar" class="notification-bar hidden">
        <div class="container mx-auto flex items-center justify-between">
            <div class="overflow-hidden">
                <div class="scroll-container" id="scroll-container">
                    <!-- 通知内容将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="toggle-bar" class="text-sm hover:underline">
                    <i class="fa fa-refresh mr-1"></i> 刷新
                </button>
                <button id="close-bar" class="close-btn">
                    <i class="fa fa-times text-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://pyzqfcdttqomqmdmympr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5enFmY2R0dHFvbXFtZG15bXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDQwMTUxMTQsImV4cCI6MjAxOTU5MTExNH0.zHcI03y51xZ8lC_9w9iK7tR3w7Bkf6vR5w8j_1z2y3x4v5b6n7m8';
        
        // 初始化Supabase客户端
        let supabase;
        try {
            if (typeof window !== 'undefined') {
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else if (window.createClient) {
                    supabase = window.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else if (typeof createClient !== 'undefined') {
                    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                    throw new Error('Supabase client not found');
                }
            }
        } catch (error) {
            console.error('Supabase初始化失败:', error);
            // 显示错误信息
            showNotification('Supabase连接失败，请检查配置', 'error');
        }
        
        // 模拟通知数据
        const mockNotifications = [
            {
                id: 15,
                title: '系统维护通知',
                content: '系统将于今晚23:00-次日01:00进行维护，期间服务可能中断',
                priority: 'high',
                created_at: new Date().toISOString(),
                start_time: new Date(Date.now() - 3600000).toISOString(),
                end_time: new Date(Date.now() + 86400000).toISOString()
            },
            {
                id: 16,
                title: '新功能上线',
                content: '我们推出了新的用户积分系统，快来体验吧！',
                priority: 'medium',
                created_at: new Date().toISOString(),
                start_time: new Date(Date.now() - 7200000).toISOString(),
                end_time: new Date(Date.now() + 172800000).toISOString()
            },
            {
                id: 17,
                title: '优惠活动',
                content: '本月购买会员享受8折优惠，仅限新用户',
                priority: 'low',
                created_at: new Date().toISOString(),
                start_time: new Date(Date.now() - 10800000).toISOString(),
                end_time: new Date(Date.now() + 259200000).toISOString()
            },
            {
                id: 18,
                title: '安全提醒',
                content: '请定期更改密码以保证账户安全',
                priority: 'medium',
                created_at: new Date().toISOString(),
                start_time: new Date(Date.now() - 14400000).toISOString(),
                end_time: new Date(Date.now() + 345600000).toISOString()
            },
            {
                id: 19,
                title: '数据备份完成',
                content: '上周的数据备份已完成，备份文件已存储到云端',
                priority: 'low',
                created_at: new Date().toISOString(),
                start_time: new Date(Date.now() - 18000000).toISOString(),
                end_time: new Date(Date.now() + 432000000).toISOString()
            },
            {
                id: 20,
                title: '版本更新',
                content: '应用已更新到最新版本，修复了多个bug',
                priority: 'high',
                created_at: new Date().toISOString(),
                start_time: new Date(Date.now() - 21600000).toISOString(),
                end_time: new Date(Date.now() + 518400000).toISOString()
            }
        ];
        
        // 获取通知数据
        async function fetchNotifications() {
            try {
                if (!supabase) {
                    console.error('Supabase客户端未初始化，使用模拟数据');
                    return mockNotifications;
                }
                
                const { data, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .gte('id', 15)
                    .lte('id', 20)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('获取Supabase数据失败，使用模拟数据:', error);
                    showNotification('使用模拟数据展示通知', 'info');
                    return mockNotifications;
                }
                
                // 如果没有数据，使用模拟数据
                if (!data || data.length === 0) {
                    console.log('Supabase没有数据，使用模拟数据');
                    return mockNotifications;
                }
                
                return data;
            } catch (error) {
                console.error('获取通知失败，使用模拟数据:', error);
                showNotification('使用模拟数据展示通知', 'info');
                return mockNotifications;
            }
        }
        
        // 检查通知是否应该显示
        function shouldShowNotification(notification) {
            const now = new Date();
            
            // 检查开始时间
            if (notification.start_time) {
                const startTime = new Date(notification.start_time);
                if (startTime > now) {
                    return false;
                }
            }
            
            // 检查结束时间
            if (notification.end_time) {
                const endTime = new Date(notification.end_time);
                if (endTime < now) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 渲染通知
        function renderNotifications(notifications) {
            const container = document.getElementById('scroll-container');
            container.innerHTML = '';
            
            // 过滤应该显示的通知
            const activeNotifications = notifications.filter(shouldShowNotification);
            
            if (activeNotifications.length === 0) {
                container.innerHTML = '<div class="notification-item"><span class="notification-content">暂无通知</span></div>';
                return;
            }
            
            // 创建通知项
            activeNotifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = 'notification-item';
                
                // 设置优先级样式
                let priorityClass = 'priority-low';
                let priorityText = '低';
                
                if (notification.priority === 'high') {
                    priorityClass = 'priority-high';
                    priorityText = '高';
                } else if (notification.priority === 'medium') {
                    priorityClass = 'priority-medium';
                    priorityText = '中';
                }
                
                item.innerHTML = `
                    <span class="notification-priority ${priorityClass}">${priorityText}</span>
                    <span class="notification-content">${notification.content}</span>
                    <span class="notification-time">${formatTime(notification.created_at)}</span>
                `;
                
                container.appendChild(item);
            });
        }
        
        // 格式化时间
        function formatTime(timeString) {
            const date = new Date(timeString);
            return date.toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 显示通知条
        function showNotificationBar() {
            const bar = document.getElementById('notification-bar');
            bar.classList.remove('hidden');
        }
        
        // 隐藏通知条
        function hideNotificationBar() {
            const bar = document.getElementById('notification-bar');
            bar.classList.add('hidden');
        }
        
        // 切换通知条显示状态
        function toggleNotificationBar() {
            const bar = document.getElementById('notification-bar');
            bar.classList.toggle('hidden');
        }
        
        // 显示简单通知
        function showNotification(message, type = 'info') {
            // 创建一个简单的通知元素
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 px-4 py-2 rounded shadow-lg ${type === 'error' ? 'bg-red-500' : 'bg-primary'} text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // 初始化
        async function init() {
            try {
                const notifications = await fetchNotifications();
                renderNotifications(notifications);
                
                // 如果有活动通知，显示通知条
                const activeNotifications = notifications.filter(shouldShowNotification);
                if (activeNotifications.length > 0) {
                    showNotificationBar();
                }
            } catch (error) {
                console.error('初始化失败:', error);
                showNotification('初始化失败，请稍后重试', 'error');
            }
        }
        
        // 事件监听
        document.addEventListener('DOMContentLoaded', () => {
            init();
            
            // 关闭按钮
            document.getElementById('close-bar').addEventListener('click', hideNotificationBar);
            
            // 刷新按钮
            document.getElementById('toggle-bar').addEventListener('click', async () => {
                const notifications = await fetchNotifications();
                renderNotifications(notifications);
                showNotificationBar();
            });
        });
    </script>
</body>
</html>