<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>光·遇 事件</title>
    <script src="https://cdn.tailwindcss.com"></script>
<link href="../libs/font-awesome/css/font-awesome.min.css" rel="stylesheet">
<script src="../libs/@supabase/supabase-js/dist/umd/supabase.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 - 暗黑模式 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        priority: {
                            high: '#ef4444',    // 红色表示高优先级
                            medium: '#f59e0b',  // 黄色表示中优先级
                            low: '#10b981',     // 绿色表示低优先级
                            none: '#64748b'     // 灰色表示无优先级
                        },
                        primary: '#60a5fa',   // 稍浅的蓝色，适合暗黑模式
                        secondary: '#94a3b8', // 稍浅的灰色，适合暗黑模式
                        dark: {
                            bg: '#1e293b',      // 主背景色
                            card: '#334155',    // 卡片背景色
                            hover: '#475569',   // 悬停状态颜色
                            text: '#f8fafc',    // 主要文本色
                            textSecondary: '#cbd5e1' // 次要文本色
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .task-transition {
                transition: all 0.5s ease-in-out;
            }
            .hover-expand {
                transition: max-height 0.5s ease-in-out;
            }
            .context-menu {
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .modal-backdrop {
                backdrop-filter: blur(2px);
            }
            .app-compact {
                padding: 1.5rem;
                min-height: auto !important;
                width: auto !important;
                max-width: 280px;
            }
            .app-expanded {
                padding: 2rem;
                width: auto !important;
                max-width: 520px;
            }
            .task-item {
                cursor: pointer;
            }
            .day-checkbox {
                width: 1.5rem;
                height: 1.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .recurrence-option {
                @apply p-3 border border-gray-600 rounded-lg cursor-pointer transition-all hover:border-primary;
            }
            .recurrence-option.selected {
                @apply border-primary bg-primary/10;
            }
            .ongoing-indicator {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }
            .time-input-group {
                @apply flex items-center gap-3;
            }
            .time-input {
                @apply w-20 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .time-select {
                @apply flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .countdown {
                @apply text-xs font-medium px-2 py-0.5 rounded-lg;
                background-color: rgba(var(--countdown-color-rgb), 0.2);
                color: var(--countdown-color);
            }
            .download-btn {
                @apply fixed bottom-6 right-6 bg-primary hover:bg-primary/90 text-white p-3 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-40;
            }
            .download-tooltip {
                @apply absolute right-full mr-3 px-3 py-1 rounded-lg text-sm opacity-0 invisible transition-all duration-300 whitespace-nowrap;
            }
            .download-container:hover .download-tooltip {
                @apply opacity-100 visible;
            }
            .notification {
                @apply fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full;
            }
            .notification.show {
                @apply translate-x-0;
            }
            .notification.error {
                @apply bg-red-500;
            }
            .save-btn {
                @apply fixed bottom-6 left-6 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-40;
            }
            .save-tooltip {
                @apply absolute left-full ml-3 px-3 py-1 rounded-lg text-sm opacity-0 invisible transition-all duration-300 whitespace-nowrap;
            }
            .save-container:hover .save-tooltip {
                @apply opacity-100 visible;
            }
            /* 保存状态指示器 */
            .save-status {
                @apply fixed bottom-6 left-20 bg-dark-card text-dark-text px-3 py-1 rounded-lg text-sm z-40;
            }
            /* 新增：优化文字间距和排版 */
            .task-title {
                @apply tracking-wide;
            }
            .task-meta {
                @apply tracking-tight mt-1.5;
            }
            .task-meta-item {
                @apply mr-3 last:mr-0;
            }
            /* 新增：进行中红色文字样式 */
            .ongoing-text {
                @apply font-medium;
                color: var(--ongoing-color) !important;
            }
            
            /* 破晓红石事件地点名称样式 - 提高优先级 */
            .dawn-redstone-location {
                color: var(--primary-color) !important;
            }
            
            /* 浅色模式下破晓红石地点名称颜色 - 确保优先级 */
            body [data-theme="light"] .dawn-redstone-location,
            [data-theme="light"] .task-title .dawn-redstone-location,
            [data-theme="light"] .task-meta .dawn-redstone-location,
            [data-theme="light"] .dawn-redstone-location {
                color: #FF6B8B !important;
            }
            
            /* 深色模式下破晓红石地点名称颜色 */
            body [data-theme="dark"] .dawn-redstone-location,
            [data-theme="dark"] .task-title .dawn-redstone-location,
            [data-theme="dark"] .task-meta .dawn-redstone-location,
            [data-theme="dark"] .dawn-redstone-location {
                color: #60a5fa !important;
            }
            /* 锁定状态指示器 */
            .lock-indicator {
                @apply absolute top-4 right-4 text-dark-textSecondary hover:text-primary transition-colors cursor-pointer;
            }
            .lock-indicator.locked {
                @apply text-primary;
            }
            /* 空白区域样式 - 用于点击锁定 */
            .empty-hover-area {
                cursor: pointer;
                @apply hover:bg-dark-hover/30 transition-colors rounded-lg;
            }
            
            /* 未来事件标题在浅色模式下的悬浮背景色 - 统一浅粉色 */
            [data-theme="light"] .empty-hover-area:hover {
                background-color: #FFF0F3 !important;
            }
            
            @media (prefers-color-scheme: light) {
                :root:not([data-theme]) .empty-hover-area:hover {
                    background-color: #FFF0F3 !important;
                }
            }
            /* 修复列表显示问题：添加滚动条和最大高度限制 */
            .scrollable-list {
                max-height: 300px;
                overflow-y: auto;
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-color) var(--bg-color);
            }
            .scrollable-list::-webkit-scrollbar {
                width: 6px;
            }
            .scrollable-list::-webkit-scrollbar-track {
                background: var(--bg-color);
                border-radius: 3px;
            }
            .scrollable-list::-webkit-scrollbar-thumb {
                background-color: var(--scrollbar-color);
                border-radius: 3px;
            }
            /* 预览卡片样式 - 紧凑优化版本 */
            .preview-card {
                @apply fixed bg-dark-card rounded-xl shadow-2xl border-2 border-primary/50 p-3 max-w-xs z-50 transform transition-all duration-200 scale-95 opacity-0 pointer-events-none;
                backdrop-filter: blur(10px);
                min-width: 260px;
            }
            .preview-card.show {
                @apply scale-100 opacity-100 pointer-events-auto;
            }
            .preview-card::before {
                content: '';
                @apply absolute -top-2 left-4 w-4 h-4 bg-primary/50 transform rotate-45;
            }
            .preview-content {
                @apply space-y-1.5;
            }
            .preview-header {
                @apply flex justify-between items-center mb-2 pb-2 border-b border-gray-700;
            }
            .preview-name {
                @apply font-medium text-dark-text flex items-center text-sm;
            }
            .preview-status {
                @apply text-xs text-primary flex items-center;
            }
            .preview-details {
                @apply text-xs text-dark-textSecondary space-y-1;
            }
            .preview-row {
                @apply flex justify-between items-center;
            }
            .preview-icon {
                @apply w-3 h-3 mr-1.5 opacity-70 flex items-center justify-center;
            }
            .preview-label {
                @apply flex items-center mr-2;
            }
            .preview-value {
                @apply text-dark-text text-right;
            }
            .preview-highlight {
                animation: glow 2s ease-in-out infinite alternate;
            }
            @keyframes glow {
                from {
                    box-shadow: 0 0 5px theme('colors.primary'), 0 0 10px theme('colors.primary');
                }
                to {
                    box-shadow: 0 0 10px theme('colors.primary'), 0 0 20px theme('colors.primary');
                }
            }
            /* 丝滑跟随效果 */
            .preview-smooth {
                transition: transform 0.1s ease-out, opacity 0.2s ease-out;
            }
            /* 手机端优化 */
            @media (max-width: 640px) {
                /* 调整主题切换按钮和魔法图标更靠左 */
                .theme-toggle-container {
                    left: 6px !important;
                }
                
                .app-expanded {
                    padding: 1rem;
                    max-width: 100%;
                    margin: 0.5rem;
                    min-height: auto !important;
                }
                .app-compact {
                    padding: 1rem;
                    max-width: 100%;
                    margin: 0.5rem;
                }
                .preview-card {
                    max-width: 85vw;
                    min-width: 0;
                    left: 7.5vw !important;
                    right: 7.5vw;
                    transform-origin: center;
                }
                .preview-card::before {
                    display: none;
                }
                .task-meta {
                    @apply flex flex-col gap-1;
                }
                .task-meta-item {
                    @apply mr-0;
                }
                .time-input-group {
                    @apply flex-col items-stretch;
                }
                .time-input, .time-select {
                    @apply w-full;
                }
                .download-btn, .save-btn {
                    @apply bottom-4 p-2.5;
                }
                .download-btn {
                    @apply right-4;
                }
                .save-btn {
                    @apply left-4;
                }
                .save-status {
                    @apply bottom-4 left-16;
                }
                .modal-content {
                    @apply max-h-[90vh] overflow-y-auto;
                }
                .task-item {
                    @apply p-3;
                }
                .task-title {
                    @apply text-sm;
                }
                .task-meta {
                    @apply text-xs;
                }
            }
        }
    </style>
    
    <style>
        /* 主题变量定义 - 与index.html保持一致 */
        :root {
            /* 默认深色主题 */
            --bg-color: #1e293b;
            --card-color: #334155;
            --text-color: #f8fafc;
            --text-secondary: #cbd5e1;
            --hover-color: #475569;
            --border-color: #64748b;
            --primary-color: #60a5fa;
            --priority-high: #ef4444;
            --priority-medium: #f59e0b;
            --priority-low: #10b981;
            --priority-none: #64748b;
        }
        
        /* 添加CSS变量到根元素，确保所有元素都能访问 */
        :root {
            /* 默认深色主题 */
            --bg-color: #1e293b;
            --card-color: #334155;
            --text-color: #f8fafc;
            --text-secondary: #cbd5e1;
            --hover-color: #475569;
            --border-color: #64748b;
            --primary-color: #60a5fa;
            --priority-high: #ef4444;
            --priority-medium: #f59e0b;
            --priority-low: #10b981;
            --priority-none: #64748b;
        }
        
        /* 浅色主题覆盖 */
        [data-theme="light"] {
            /* 樱花配色 - 浅色主题 */
            --bg-color: #FFF5F7 !important;
            --card-color: #FFFFFF !important;
            --text-color: #3D1A2D !important;
            --text-secondary: #8A4A62 !important;
            --hover-color: #FFF0F3 !important;
            --border-color: #FFD6E0 !important;
            --primary-color: #FFB7C5 !important;
            --scrollbar-color: #FFB7C5 !important;
            --ongoing-color: #FF6B8B !important;
            --countdown-color: #60a5fa !important;
            --countdown-color-rgb: 96, 165, 250 !important;
            --priority-high: #FF6B8B !important;
            --priority-medium: #FFA7C4 !important;
            --priority-low: #FFD6E0 !important;
            --priority-none: #D8BFD8 !important;
        }
        
        [data-theme="dark"] {
            --bg-color: #1e293b !important;
            --card-color: #334155 !important;
            --text-color: #f8fafc !important;
            --text-secondary: #cbd5e1 !important;
            --hover-color: #475569 !important;
            --border-color: #64748b !important;
            --primary-color: #60a5fa !important;
            --scrollbar-color: #60a5fa !important;
            --ongoing-color: #ef4444 !important;
            --countdown-color: #60a5fa !important;
            --countdown-color-rgb: 96, 165, 250 !important;
            --priority-high: #ef4444 !important;
            --priority-medium: #f59e0b !important;
            --priority-low: #10b981 !important;
            --priority-none: #64748b !important;
        }
        

        
        [data-theme="light"] .countdown {
            color: #FF6B8B !important;
        }
        
        /* 词条提示器样式 - 深色主题 */
            html[data-theme="dark"] .download-tooltip,
            html[data-theme="dark"] .save-tooltip {
                background-color: #334155 !important;
                color: #f8fafc !important;
            }
            
            /* 词条提示器样式 - 浅色主题 */
            html[data-theme="light"] .download-tooltip,
            html[data-theme="light"] .save-tooltip {
                background-color: #FF6B8B !important;
                color: #ffffff !important;
            }
        
        /* 主题切换按钮 */
        .theme-toggle {
            z-index: 40;
            transition: all 0.3s ease;
        }
        
        /* 应用主题变量 - 覆盖所有相关元素 */
        body {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            overflow-x: hidden; /* 去除横向滚动条 */
            overflow-y: auto; /* 允许竖向滚动 */
        }
        
        /* 按钮样式 - 深色主题 */
        html[data-theme="dark"] .download-btn,
        html[data-theme="dark"] .save-btn {
            background-color: #60a5fa !important;
            color: white !important;
        }
        
        /* 按钮样式 - 浅色主题 */
        html[data-theme="light"] .download-btn,
        html[data-theme="light"] .save-btn {
            background-color: #FFA7C4 !important;
            color: white !important;
        }
        
        /* 全局隐藏滚动条但保留滚动功能 */
        html, body {
            scrollbar-width: none; /* Firefox：隐藏竖向滚动条 */
            overflow-x: hidden; /* 去除横向滚动条 */
        }
        
        html::-webkit-scrollbar, body::-webkit-scrollbar {
            display: none; /* Chrome, Edge, Safari：隐藏所有滚动条 */
        }
        
        /* 覆盖所有卡片背景 */
        #app-container,
        .preview-card,
        .modal-content,
        .context-menu {
            background-color: var(--card-color) !important;
        }
        
        /* 背景色类 - 用于页面背景和加载指示器 */
        .bg-dark-bg {
            background-color: var(--bg-color) !important;
        }
        
        /* 主题切换按钮 - 确保背景色为白色 */
        .theme-toggle {
            background-color: var(--card-color) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        /* 覆盖所有文本颜色 */
        .text-dark-text,
        h1, h2, h3, h4, h5, h6,
        p,
        span,
        label,
        .task-title,
        .task-meta,
        .task-time,
        .modal-title {
            color: var(--text-color) !important;
        }
        
        /* 覆盖所有次要文本颜色 */
        .text-dark-textSecondary,
        .task-meta span,
        .task-time,
        .save-status {
            color: var(--text-secondary) !important;
        }
        
        /* 通知元素样式 - 深色主题 */
            html[data-theme="dark"] .notification {
                background-color: #60a5fa !important;
                color: white !important;
            }
            
            /* 通知元素样式 - 浅色主题 */
            html[data-theme="light"] .notification {
                background-color: #FFA7C4 !important;
                color: white !important;
            }
            
            .notification.error {
                background-color: #ef4444 !important;
                color: white !important;
            }
        
        /* 任务激活状态 */
        .future-task-item.active {
            @apply bg-primary bg-opacity-10 border-primary;
        }
        
        /* 覆盖所有悬停背景 */
        .bg-dark-hover,
        .bg-dark-hover:hover,
        .task-item:hover,
        .task-item.selected,
        .future-task-item:hover,
        button:hover,
        .recurrence-option.selected {
            background-color: var(--hover-color) !important;
        }
        
        /* 覆盖所有边框颜色 */
        .border-gray-600,
        .border-gray-700,
        #app-container,
        .preview-card,
        .modal-content,
        .task-item,
        input,
        select,
        textarea,
        .time-input-group {
            border-color: var(--border-color) !important;
        }
        
        /* 覆盖所有主色 */
        .bg-primary,
        button[type="submit"],
        .download-btn,
        .download-btn:hover,
        .save-btn:hover {
            background-color: var(--primary-color) !important;
        }
        
        /* 保存按钮样式 - 浅色主题下使用浅绿色 */
        [data-theme="light"] .save-btn {
            background-color: #10b981 !important;
        }
        
        [data-theme="dark"] .save-btn {
            background-color: var(--priority-low) !important;
        }
        
        /* 加载指示器样式 - 深色主题 */
        html[data-theme="dark"] .loading-indicator {
            color: #60a5fa !important;
        }
        
        /* 加载指示器样式 - 浅色主题 */
        html[data-theme="light"] .loading-indicator {
            color: #FFA7C4 !important;
        }
        .text-primary,
        .text-primary span:not(.ongoing-text):not(.countdown) {
            color: var(--countdown-color) !important;
        }
        

        
        /* 覆盖优先级颜色 */
        .text-priority-high,
            .priority-high {
                color: var(--priority-high) !important;
            }
            .bg-priority-high {
                background-color: var(--priority-high) !important;
            }
        
        .text-priority-medium,
        .priority-medium {
            color: var(--priority-medium) !important;
        }
        
        .text-priority-low,
        .priority-low {
            color: var(--priority-low) !important;
        }
        
        /* 覆盖背景色类 */
        .bg-dark-bg {
            background-color: var(--bg-color) !important;
        }
        
        /* 确保预览卡片应用主题变量 */
        #preview-card {
            background-color: var(--card-color) !important;
            color: var(--text-color) !important;
        }
        
        /* 确保预览卡片内容应用主题变量 */
        .preview-details,
        .preview-row {
            color: var(--text-secondary) !important;
        }
        
        .preview-value {
            color: var(--text-color) !important;
        }
        
        /* 系统主题检测备用 - 与index.html保持一致 */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme]) {
                --bg-color: #1e293b;
                --card-color: #334155;
                --text-color: #f8fafc;
                --text-secondary: #cbd5e1;
                --hover-color: #475569;
                --border-color: #64748b;
                --primary-color: #60a5fa;
                --priority-high: #ef4444;
                --priority-medium: #f59e0b;
                --priority-low: #10b981;
                --priority-none: #64748b;
            }
        }
        
        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) {
                /* 樱花配色 - 浅色主题 */
                --bg-color: #FFF5F7;
                --card-color: #FFFFFF;
                --text-color: #3D1A2D;
                --text-secondary: #8A4A62;
                --hover-color: #FFF0F3;
                --border-color: #FFD6E0;
                --primary-color: #FFB7C5;
                --priority-high: #FF6B8B;
                --priority-medium: #FFA7C4;
                --priority-low: #FFD6E0;
                --priority-none: #D8BFD8;
            }
        }
    </style>
    <script>
        // 主题初始化 - 在DOM加载前设置主题，避免颜色闪烁
        (function() {
            const storedTheme = localStorage.getItem('theme');
            const initialTheme = storedTheme || 'light'; // 默认使用浅色主题
            document.documentElement.setAttribute('data-theme', initialTheme);
        })();
    </script>
</head>
<body class="bg-dark-bg min-h-screen flex items-center justify-center p-4 font-inter text-dark-text m-0">
    <!-- 主题切换按钮 -->
    <div class="theme-toggle-container fixed top-4 left-4 z-40 flex flex-col items-center">
        <button id="theme-toggle" class="theme-toggle p-2 rounded-lg bg-dark-card border border-gray-700 text-dark-text hover:bg-dark-hover transition-colors shadow-lg" title="切换主题">
            <img src="./icons/moon.png" id="theme-icon" alt="切换主题" style="width: 16px; height: 16px;" />
        </button>
        
        <!-- 间隔区域 -->
        <div class="h-8"></div>
        
        <!-- 魔法图标显示区域 -->
        <div id="magic-icons-container" class="space-y-2 flex flex-col items-center">
            <!-- 魔法图标将通过JavaScript动态添加 -->
        </div>
    </div>
    
    <!-- 加载指示器 -->
    <div id="loading-indicator" class="fixed inset-0 flex items-center justify-center bg-dark-bg z-50 transition-opacity duration-500">
        <div class="loading-indicator text-2xl font-bold animate-pulse">光·遇 事件 时间</div>
    </div>
    
    <div id="app-container" class="bg-dark-card rounded-2xl shadow-lg task-transition border border-gray-700 w-auto max-w-md app-expanded relative opacity-0 translate-y-4 transition-all duration-800">
        <div id="lock-indicator" class="lock-indicator" title="跳转到HHS页面">
            <a href="hhs.html" target="_self" class="text-dark-textSecondary hover:text-primary transition-colors" id="hhs-link">
                <img src="./icons/hs.png" alt="Lock" style="width: 20px; height: 20px;">
            </a>
        </div>
        
        <!-- 延迟预加载切换国际服和破晓日历页面 -->
        <script>
            // 页面加载完成后延迟3秒预加载相关页面
            window.addEventListener('load', () => {
                setTimeout(() => {
                    // 预加载切换国际服页面
                    const linkHome = document.createElement('link');
                    linkHome.rel = 'prefetch';
                    linkHome.href = '../index.html';
                    document.head.appendChild(linkHome);
                    
                    // 预加载破晓日历页面
                    const linkHHS = document.createElement('link');
                    linkHHS.rel = 'prefetch';
                    linkHHS.href = 'HHS.html';
                    document.head.appendChild(linkHHS);
                }, 3000); // 3秒后预加载
            });
        </script>
        
        <!-- 添加返回首页图标链接 -->
        <div id="home-icon" class="lock-indicator" style="right: auto; left: 1rem;" title="切换国际服">
            <a href="../index.html" target="_self" class="text-dark-textSecondary hover:text-primary transition-colors">
                <img src="./icons/zg.svg" alt="Home" style="width: 20px; height: 20px;">
            </a>
        </div>
        
        <!-- 当前时间显示（始终显示） -->
        <div id="current-time" class="text-center text-2xl font-semibold text-dark-text mb-4"></div>
        
        <!-- 项目轮播容器 -->
        <div id="tasks-container" class="relative min-h-[80px] overflow-hidden">
            <div id="task-carousel" class="transition-transform duration-500 ease-in-out">
                <!-- 项目将通过JavaScript动态添加 -->
            </div>
        </div>
        
        <!-- 未来事件标题（始终显示） -->
        <div class="text-sm text-dark-textSecondary mb-2 font-medium text-center empty-hover-area p-2">
            未来事件
        </div>
        
        <!-- 全部项目（鼠标悬停时显示） -->
        <div id="all-tasks" class="mt-0 max-h-0 overflow-hidden hover-expand">
            <!-- 修复：添加scrollable-list类以启用滚动 -->
            <div id="all-tasks-list" class="space-y-2.5 text-sm scrollable-list"></div>
        </div>
        
        <!-- 轮播控制按钮已删除 -->
        <div id="controls-container" class="flex justify-center mt-4 space-x-2 transition-all duration-300 hidden">
        </div>
    </div>

    <!-- 预览卡片 - 紧凑优化排版 -->
    <div id="preview-card" class="preview-card preview-smooth">
        <div class="preview-content">
            <div class="preview-header">
                <div class="preview-name">
                    <span id="preview-priority" class="w-2 h-2 rounded-full mr-2"></span>
                    <span id="preview-name" class="truncate"></span>
                </div>
                <div id="preview-status" class="preview-status"></div>
            </div>
            <div class="preview-details">
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-repeat preview-icon"></i>
                        <span>重复</span>
                    </span>
                    <span id="preview-recurrence" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-clock-o preview-icon"></i>
                        <span>时长</span>
                    </span>
                    <span id="preview-duration" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-calendar preview-icon"></i>
                        <span>日期</span>
                    </span>
                    <span id="preview-date" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-hourglass-start preview-icon"></i>
                        <span>时间</span>
                    </span>
                    <span id="preview-time" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-bell preview-icon"></i>
                        <span>提醒</span>
                    </span>
                    <span id="preview-alert" class="preview-value"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 - 通用菜单 -->
    <div id="main-context-menu" class="context-menu hidden absolute bg-dark-card rounded-lg shadow-lg p-2 w-48 border border-gray-700">
        <div id="add-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer">
            <i class="fa fa-plus mr-2 text-primary"></i>添加新事件
        </div>
    </div>

    <!-- 任务右键菜单 -->
    <div id="task-context-menu" class="context-menu hidden absolute bg-dark-card rounded-lg shadow-lg p-2 w-48 border border-gray-700">
        <div id="edit-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer">
            <i class="fa fa-pencil mr-2 text-primary"></i>编辑事件
        </div>
        <div id="delete-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer">
            <i class="fa fa-trash mr-2 text-red-500"></i>删除事件
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="confirm-delete-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-dark-text">确认删除</h3>
                <button id="close-delete-modal" class="text-dark-textSecondary hover:text-dark-text">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <p class="text-dark-textSecondary mb-6">您确定要删除这个事件吗？此操作无法撤销。</p>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 border border-gray-600 rounded-lg text-dark-text hover:bg-dark-hover transition-colors">取消</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑任务模态框 -->
    <div id="task-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-semibold text-dark-text">添加新事件</h3>
                <button id="close-modal" class="text-dark-textSecondary hover:text-dark-text">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="task-form">
                <input type="hidden" id="task-id">
                
                <div class="mb-4">
                    <label for="task-name" class="block text-sm font-medium text-dark-textSecondary mb-1">事件名称</label>
                    <input type="text" id="task-name" name="task-name" required="" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div class="mb-4">
                    <label for="task-priority" class="block text-sm font-medium text-dark-textSecondary mb-1">优先级</label>
                    <select id="task-priority" name="task-priority" required="" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="high">高 (红色)</option>
                        <option value="medium" selected="">中 (黄色)</option>
                        <option value="low">低 (绿色)</option>
                        <option value="none">无 (灰色) - 仅显示在任务列表</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="display-threshold" class="block text-sm font-medium text-dark-textSecondary mb-1">提前提醒时间</label>
                    <div class="time-input-group">
                        <input type="number" id="display-threshold" name="display-threshold" min="1" value="10" class="time-input">
                        <select id="display-threshold-unit" name="display-threshold-unit" class="time-select">
                            <option value="minute">分钟</option>
                            <option value="hour">小时</option>
                            <option value="day">天</option>
                            <option value="week">周</option>
                        </select>
                    </div>
                    <p class="text-xs text-primary mt-1">事件开始前多久显示提醒</p>
                </div>
                
                <!-- 开始日期时间将集成到每个重复类型的选项面板中 -->
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">重复方式</label>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="recurrence-option selected" data-type="none">
                            <div class="font-medium">不重复</div>
                            <div class="text-xs text-dark-textSecondary">仅一次</div>
                        </div>
                        <div class="recurrence-option" data-type="daily">
                            <div class="font-medium">每天</div>
                            <div class="text-xs text-dark-textSecondary">每天同一时间</div>
                        </div>
                        <div class="recurrence-option" data-type="daily_times">
                            <div class="font-medium">每日特定时间</div>
                            <div class="text-xs text-dark-textSecondary">每天多个时间点</div>
                        </div>
                        <div class="recurrence-option" data-type="weekly">
                            <div class="font-medium">每周</div>
                            <div class="text-xs text-dark-textSecondary">每周特定日期</div>
                        </div>
                        <div class="recurrence-option" data-type="monthly">
                            <div class="font-medium">每月</div>
                            <div class="text-xs text-dark-textSecondary">每月特定日期</div>
                        </div>
                        <div class="recurrence-option" data-type="interval">
                            <div class="font-medium">间隔重复</div>
                            <div class="text-xs text-dark-textSecondary">按固定间隔重复</div>
                        </div>
                        <div class="recurrence-option" data-type="monthly_interval">
                            <div class="font-medium">每月间隔</div>
                            <div class="text-xs text-dark-textSecondary">每月特定日期+间隔</div>
                        </div>
                    </div>
                    <input type="hidden" id="recurrence-type" value="none">
                </div>
                
                <!-- 不重复选项 -->
                <div id="none-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <input type="date" id="none-start-date" name="none-start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="none-start-date" class="text-xs text-dark-textSecondary">日期</label>
                        </div>
                        <div>
                            <input type="time" id="none-start-time" name="none-start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="none-start-time" class="text-xs text-dark-textSecondary">时间</label>
                        </div>
                    </div>
                </div>

                <!-- 每天重复选项 -->
                <div id="daily-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <input type="date" id="daily-start-date" name="daily-start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="daily-start-date" class="text-xs text-dark-textSecondary">日期</label>
                        </div>
                        <div>
                            <input type="time" id="daily-start-time" name="daily-start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="daily-start-time" class="text-xs text-dark-textSecondary">时间</label>
                        </div>
                    </div>
                </div>

                <!-- 每日特定时间选项 -->
                <div id="daily-times-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <input type="date" id="daily_times-start-date" name="daily_times-start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="daily_times-start-date" class="text-xs text-dark-textSecondary">日期</label>
                        </div>
                        <div>
                            <input type="time" id="daily_times-start-time" name="daily_times-start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="daily_times-start-time" class="text-xs text-dark-textSecondary">开始时间</label>
                        </div>
                    </div>
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">每日特定时间点</label>
                    <div id="daily-times-container" class="space-y-2 mb-2">
                        <!-- 时间输入框将通过JavaScript动态添加 -->
                    </div>
                    <button type="button" id="add-time-btn" class="w-full px-3 py-2 border border-dashed border-gray-600 rounded-lg text-dark-textSecondary hover:bg-dark-hover transition-colors flex items-center justify-center">
                        <i class="fa fa-plus mr-2"></i>添加时间点
                    </button>
                    <p class="text-xs text-primary mt-1">每天在这些时间点重复事件</p>
                </div>
                
                <!-- 每周重复选项 -->
                <div id="weekly-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <input type="date" id="weekly-start-date" name="weekly-start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="weekly-start-date" class="text-xs text-dark-textSecondary">日期</label>
                        </div>
                        <div>
                            <input type="time" id="weekly-start-time" name="weekly-start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="weekly-start-time" class="text-xs text-dark-textSecondary">时间</label>
                        </div>
                    </div>
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">每周重复日期</label>
                    <div class="flex flex-wrap gap-2 mb-1">
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="1" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">一</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="2" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">二</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="3" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">三</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="4" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">四</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="5" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">五</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="6" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">六</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="0" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">日</span>
                        </label>
                    </div>
                </div>
                
                <!-- 每月重复选项 -->
                <div id="monthly-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <input type="date" id="monthly-start-date" name="monthly-start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="monthly-start-date" class="text-xs text-dark-textSecondary">日期</label>
                        </div>
                        <div>
                            <input type="time" id="monthly-start-time" name="monthly-start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="monthly-start-time" class="text-xs text-dark-textSecondary">时间</label>
                        </div>
                    </div>
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">每月重复日期</label>
                    <div class="flex flex-wrap gap-2 mb-1">
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="1" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">1</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="2" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">2</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="3" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">3</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="4" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">4</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="5" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">5</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="6" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">6</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="7" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">7</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="8" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">8</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="9" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">9</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="10" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">10</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="13" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">13</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="21" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">21</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="29" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">29</span>
                        </label>
                        <!-- 更多日期可以根据需要添加 -->
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-medium text-dark-textSecondary mb-1">或按星期几</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="1" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">一</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="2" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">二</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="3" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">三</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="4" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">四</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="5" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">五</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="6" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">六</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="0" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">日</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 自定义重复选项 -->
                <!-- 间隔重复选项 -->
                <div id="interval-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">开始时间</label>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <input type="date" id="interval-start-date" name="interval-start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <input type="time" id="interval-start-time" name="interval-start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">结束时间</label>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <input type="date" id="interval-end-date" name="interval-end-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <input type="time" id="interval-end-time" name="interval-end-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">间隔设置</label>
                    <div class="time-input-group">
                        <input type="number" id="interval-count" name="interval-count" min="1" value="1" class="time-input">
                        <select id="interval-unit" name="interval-unit" class="time-select">
                            <option value="minute">分钟</option>
                            <option value="hour">小时</option>
                            <option value="day">天</option>
                            <option value="week">周</option>
                            <option value="month">月</option>
                        </select>
                    </div>
                </div>

                <!-- 每月特定日期+当天间隔重复选项 -->
                <div id="monthly_interval-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">开始时间</label>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <input type="date" id="monthly_interval-start-date" name="monthly_interval-start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="monthly_interval-start-date" class="text-xs text-dark-textSecondary">日期</label>
                        </div>
                        <div>
                            <input type="time" id="monthly_interval-start-time" name="monthly_interval-start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="monthly_interval-start-time" class="text-xs text-dark-textSecondary">时间</label>
                        </div>
                    </div>
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">选择日期</label>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="1" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">1</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="2" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">2</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="3" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">3</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="4" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">4</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="5" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">5</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="6" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">6</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="7" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">7</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="8" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">8</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="9" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">9</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="10" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">10</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="11" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">11</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="12" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">12</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="13" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">13</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="14" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">14</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="15" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">15</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="16" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">16</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="17" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">17</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="18" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">18</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="19" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">19</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="20" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">20</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="21" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">21</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="22" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">22</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="23" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">23</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="24" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">24</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="25" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">25</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="26" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">26</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="27" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">27</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="28" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">28</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="29" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">29</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="30" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">30</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthly_interval-day" value="31" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">31</span>
                        </label>
                    </div>
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">间隔设置</label>
                    <div class="time-input-group">
                        <input type="number" id="monthly_interval-count" name="monthly_interval-count" min="1" value="1" class="time-input">
                        <select id="monthly_interval-unit" name="monthly_interval-unit" class="time-select">
                            <option value="minute">分钟</option>
                            <option value="hour">小时</option>
                            <option value="day">天</option>
                        </select>
                    </div>
                </div>

                <div id="custom-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">重复间隔</label>
                    <div class="time-input-group">
                        <input type="number" id="interval-count" name="interval-count" min="1" value="1" class="time-input">
                        <select id="interval-unit" name="interval-unit" class="time-select">
                            <option value="minute">分钟</option>
                            <option value="hour">小时</option>
                            <option value="day">天</option>
                            <option value="week">周</option>
                            <option value="month">月</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="task-duration" class="block text-sm font-medium text-dark-textSecondary mb-1">持续时间</label>
                    <div class="time-input-group">
                        <input type="number" id="task-duration" name="task-duration" min="1" value="10" class="time-input">
                        <select id="duration-unit" name="duration-unit" class="time-select">
                            <option value="minute">分钟</option>
                            <option value="hour">小时</option>
                            <option value="day">天</option>
                            <option value="week">周</option>
                            <option value="month">月</option>
                        </select>
                    </div>
                    <p class="text-xs text-primary mt-1">事件进行的时长，将作为进行中事件的倒计时基准</p>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-task" class="px-4 py-2 border border-gray-600 rounded-lg text-dark-text hover:bg-dark-hover transition-colors">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        保存事件
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 下载按钮 -->
    <div class="download-container relative">
        <button id="download-btn" class="download-btn">
            <i class="fa fa-download隐藏"></i>
        </button>
        <span class="download-tooltip">保存当前事件到HTML文件</span>
    </div>

    <!-- 手动保存按钮 -->
    <div class="save-container relative">
        <button id="manual-save-btn" class="save-btn">
            <i class="fa fa-save隐藏"></i>
        </button>
        <span class="save-tooltip">手动保存当前数据</span>
    </div>

    <!-- 保存状态指示器 -->
    <div id="save-status" class="save-status hidden">
        <span id="save-status-text">保存中...</span>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="notification">数据已保存</div>

    <script>
        // Supabase 配置
        let supabaseUrl = localStorage.getItem('supabaseUrl_163') || 'https://prusinqhwaduefiuqkwt.supabase.co';
        let supabaseKey = localStorage.getItem('supabaseKey_163') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydXNpbnFod2FkdWVmaXVxa3d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTI5OTYsImV4cCI6MjA3OTU4ODk5Nn0.X__p8sP8ZdaOBGsbFWnhAdgLnjTXN-Y8YMVL5csVQ2Y';
        let supabase;
        
        // 初始化 Supabase
        function initSupabase() {
            try {
                // 检查域名是否有效（避免无效域名导致的网络请求错误）
                // 只需要检查是否包含 supabase.co 即可，不再硬编码特定的无效域名
                // 检查Supabase是否已加载，支持多种方式：
                // 1. window.createClient (UMD版本)
                // 2. window.supabase.createClient (另一种UMD暴露方式)
                // 3. createClient (ES模块版本)
                let createClientFunc = null;
                if (typeof window.createClient === 'function') {
                    createClientFunc = window.createClient;
                } else if (typeof window.supabase?.createClient === 'function') {
                    createClientFunc = window.supabase.createClient;
                } else if (typeof createClient === 'function') {
                    createClientFunc = createClient;
                }
                
                if (!createClientFunc) {
                    supabase = null;
                    console.error('Supabase库未加载，将使用本地存储模式运行');
                    return false;
                }
                
                // 检查域名是否有效
                const isValidDomain = supabaseUrl && supabaseUrl.includes('.supabase.co');
                if (!isValidDomain) {
                    supabase = null;
                    console.error('Supabase域名无效，将使用本地存储模式运行');
                    return false;
                }
                
                // 检查API密钥是否有效
                if (!supabaseKey || supabaseKey.length < 30) {
                    supabase = null;
                    console.error('Supabase API密钥无效，将使用本地存储模式运行');
                    return false;
                }
                
                // 创建Supabase客户端
                supabase = createClientFunc(supabaseUrl, supabaseKey);
                console.log('Supabase初始化成功');
                
                // 测试连接
                testSupabaseConnection();
                return true;
            } catch (error) {
                supabase = null;
                console.error('Supabase初始化失败:', error);
                return false;
            }
        }
        
        // 初始调用
        initSupabase();
        
        // 如果初始调用失败，添加一个延迟重试机制
        if (!supabase) {
            console.log('初始Supabase初始化失败，将在1秒后重试...');
            setTimeout(() => {
                console.log('重试Supabase初始化...');
                initSupabase();
            }, 1000);
        }
        
        // 测试Supabase连接
        async function testSupabaseConnection() {
            if (!supabase) return false;
            
            try {
                // 尝试获取表名列表，验证连接是否有效
                const { data, error } = await supabase
                    .from('tasks_163')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.error('Supabase连接测试失败:', error.message);
                    return false;
                }
                
                console.log('Supabase连接测试成功');
                return true;
            } catch (error) {
                console.error('Supabase连接测试异常:', error);
                return false;
            }
        }
        
        // 用于存储外部数据的变量 - 从localStorage加载或使用默认值
        let externalData = null;
        
        // 保存状态管理
        const saveState = {
            isSaving: false,
            lastSaved: null,
            saveAttempts: 0,
            maxAttempts: 3
        };
        
        // 任务列表锁定状态
        let isListLocked = false;
        
        // 预览卡片状态
        let previewTimeout = null;
        let currentPreviewTaskId = null;
        let isPreviewVisible = false;
        let mouseX = 0;
        let mouseY = 0;
        
        // 存储当前显示的可见任务，用于预览卡片数据同步
        let currentVisibleTasks = [];
        let currentAllTasks = [];
        
        // 尝试从localStorage加载数据 - 使用163专用键名，避免与主页面冲突
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('timeProjectReminderTasks_163');
                if (savedData) {
                    return JSON.parse(savedData);
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                showNotification('加载数据失败: ' + e.message, true);
            }
            return null;
        }
        
        // 从 Supabase 加载任务数据
        async function loadFromSupabase() {
            try {
                // 检查 supabase 是否初始化
                if (!supabase) {
                    console.log('Supabase 未初始化，不加载本地缓存');
                    showNotification('Supabase 未初始化', false);
                    return null;
                }
                
                // 强制从 Supabase 获取最新数据
                const { data, error } = await supabase
                    .from('tasks_163')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) {
                    // Supabase请求失败时，记录错误并返回null，不加载本地缓存
                    console.error('从Supabase加载数据失败:', error);
                    showNotification('从Supabase加载数据失败', false);
                    return null;
                }
                
                if (data && data.length > 0) {
                    // 将Supabase数据转换为应用所需格式
                    const tasks = data;
                    // 不再将Supabase数据保存到localStorage作为备份
                    console.log('成功从Supabase获取最新数据，共', tasks.length, '条记录');
                    return tasks;
                } else {
                    // 如果Supabase中没有数据，不尝试从localStorage加载
                    console.log('Supabase中没有数据，不加载本地缓存');
                    return null;
                }
            } catch (error) {
                console.error('从Supabase加载数据异常:', error);
                // 异常情况下不尝试从localStorage加载
                showNotification('从Supabase加载数据异常', true);
                return null;
            }
        }
        
        // 保存数据到localStorage和Supabase - 核心保存函数
        function saveToLocalStorage(data, retry = 0) {
            // 如果正在保存中，等待后重试
            if (saveState.isSaving) {
                if (retry < saveState.maxAttempts) {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            saveToLocalStorage(data, retry + 1)
                                .then(resolve)
                                .catch(resolve);
                        }, 300);
                    });
                }
                return Promise.resolve(false);
            }
            
            // 标记为正在保存
            saveState.isSaving = true;
            showSaveStatus(true);
            
            return new Promise(async resolve => {
                try {
                    // 验证数据格式
                    if (!data || !Array.isArray(data)) {
                        throw new Error('无效的数据格式');
                    }
                    
                    // 1. 保存到本地存储作为基础
                    localStorage.setItem('timeProjectReminderTasks_163', JSON.stringify(data));
                    
                    // 2. 如果Supabase可用，尝试保存到Supabase
                    if (supabase) {
                        try {
                            // 处理数据，确保只包含Supabase表中存在的字段
            const processedData = data.map(task => {
                // 创建一个新的任务对象，只包含必要的字段
                // 为recurrence添加默认值，防止违反NOT NULL约束
                const processedTask = {
                    id: task.id,
                    name: task.name,
                    startDate: task.startDate,
                    startTime: task.startTime,
                    displayThreshold: task.displayThreshold,
                    displayThresholdUnit: task.displayThresholdUnit,
                    priority: task.priority,
                    recurrence: task.recurrence || ''
                    // 注意：不直接包含duration、durationUnit和type字段
                };
                return processedTask;
            });
                            
                            // 使用upsert操作更新或插入数据，保留其他设备的编辑
                            if (processedData.length > 0) {
                                await supabase.from('tasks_163')
                                    .upsert(processedData, { onConflict: 'id' });
                            }
                        } catch (supabaseError) {
                            console.warn('Supabase保存失败，仅保留本地存储:', supabaseError);
                            // 不影响整体保存结果，继续执行
                        }
                    }
                    
                    // 更新保存状态
                    saveState.lastSaved = new Date();
                    saveState.saveAttempts = 0;
                    saveState.isSaving = false;
                    
                    // 显示成功状态
                    showSaveStatus(false, true);
                    showNotification('数据已成功保存');
                    resolve(true);
                } catch (e) {
                    console.error('保存数据失败:', e);
                    
                    // 处理保存失败
                    saveState.saveAttempts++;
                    saveState.isSaving = false;
                    
                    // 显示失败状态
                    showSaveStatus(false, false);
                    showNotification('保存失败: ' + e.message, true);
                    
                    // 如果达到最大尝试次数，提示用户导出数据
                    if (saveState.saveAttempts >= saveState.maxAttempts) {
                        if (confirm('多次保存失败，是否导出数据以防止丢失？')) {
                            downloadAsHtml();
                        }
                    }
                    
                    resolve(false);
                }
            });
        }
        
        // 显示保存状态指示器
        function showSaveStatus(isSaving, success = false) {
            const statusEl = document.getElementById('save-status');
            const statusTextEl = document.getElementById('save-status-text');
            
            if (isSaving) {
                statusTextEl.textContent = '保存中...';
                statusEl.classList.remove('hidden', 'text-green-500', 'text-red-500');
                statusEl.classList.add('text-primary');
            } else {
                if (success) {
                    statusTextEl.textContent = '保存成功';
                    statusEl.classList.remove('hidden', 'text-primary', 'text-red-500');
                    statusEl.classList.add('text-green-500');
                    
                    // 2秒后隐藏成功状态
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 2000);
                } else {
                    statusTextEl.textContent = '保存失败';
                    statusEl.classList.remove('hidden', 'text-primary', 'text-green-500');
                    statusEl.classList.add('text-red-500');
                }
            }
        }
        
        // 显示通知
        function showNotification(message, isError = false) {
            let notification = document.getElementById('notification');
            // 如果通知元素不存在，创建一个
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.className = 'notification';
                document.body.appendChild(notification);
            }
            if (notification) {
                notification.textContent = message;
                
                // 添加或移除错误类
                if (isError) {
                    notification.classList.add('error');
                } else {
                    notification.classList.remove('error');
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }
        
        // 显示大蜡位置图片
        function showLargeWaxImages(imageList, locationName, folderName) {
            // 创建图片模态框
            let modalHTML = `
                <div id="large-wax-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4" style="opacity: 0; transition: opacity 0.3s ease-in;">
                    <!-- 标题 - 固定在屏幕上方并添加背景标签 -->
                    <div class="fixed top-4 left-0 right-0 text-center z-20">
                        <div class="text-white bg-black bg-opacity-70 px-3 py-1 rounded-full shadow-lg inline-block font-bold">${locationName}</div>
                    </div>
                    
                    <div class="relative" style="transform: scale(0.9); transition: transform 0.3s ease-in;">
                        <!-- 图片容器 - 自适应图片大小 -->
                        <div id="large-wax-image-container" class="relative bg-white rounded-3xl overflow-hidden shadow-2xl bg-opacity-10 backdrop-blur-sm inline-block" style="touch-action: manipulation; cursor: grab; border-radius: 24px;">
                            <img id="large-wax-image" src="./images/${folderName}/${imageList[0]}" 
                                 alt="大蜡位置" 
                                 class="w-auto h-auto max-w-[90vw] max-h-[90vh] object-contain transition-all duration-300" 
                                 onerror="this.src='./icons/dl.png'; this.alt='图片加载失败';" style="opacity: 0; transition: opacity 0.3s ease-in 0.1s;" />
                        </div>
                    </div>
                    
                    <!-- 左右翻页按钮 - 根据图片数量和当前位置显示 -->
                    ${imageList.length > 1 ? `
                        <button id="large-wax-prev" class="fixed left-4 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-70 hover:bg-opacity-90 p-2 sm:p-3 rounded-full shadow-lg z-20 transition-all opacity-0 invisible" style="transition: opacity 0.3s ease-in;">
                            <i class="fa fa-chevron-left text-2xl sm:text-3xl font-bold"></i>
                        </button>
                        <button id="large-wax-next" class="fixed right-4 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-70 hover:bg-opacity-90 p-2 sm:p-3 rounded-full shadow-lg z-20 transition-all opacity-100 visible" style="transition: opacity 0.3s ease-in;">
                            <i class="fa fa-chevron-right text-2xl sm:text-3xl font-bold"></i>
                        </button>
                    ` : ''}
                    
                    <!-- 分页信息 - 固定在屏幕下方 -->
                    <div id="large-wax-pagination" class="fixed bottom-4 left-0 right-0 text-white bg-black bg-opacity-70 px-2 py-0.5 text-sm rounded-full shadow-lg mx-auto max-w-fit z-20">
                        ${imageList.length > 1 ? `1/${imageList.length}` : ''}
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 初始化图片索引
            let currentIndex = 0;
            
            // 获取DOM元素
            const modal = document.getElementById('large-wax-modal');
            const image = document.getElementById('large-wax-image');
            const pagination = document.getElementById('large-wax-pagination');
            const imageContainer = document.getElementById('large-wax-image-container');
            const modalContent = modal.querySelector('.relative');
            const prevButton = document.getElementById('large-wax-prev');
            const nextButton = document.getElementById('large-wax-next');
            
            // 添加显示动画
            // 触发重排
            void modal.offsetWidth;
            
            // 设置最终状态
            modal.style.opacity = '1';
            modalContent.style.transform = 'scale(1)';
            image.style.opacity = '1';
            
            // 初始化按钮状态
            changeImage(currentIndex);
            
            // 图片加载完成后更新边缘限制
            image.addEventListener('load', () => {
                // 应用边缘限制
                const { x: limitedX, y: limitedY } = applyEdgeLimits(translateX, translateY);
                translateX = limitedX;
                translateY = limitedY;
                updateTransform();
            });
            
            // 关闭模态框 - 添加淡出过渡效果
            function closeModal() {
                modal.style.opacity = '0';
                modalContent.style.transform = 'scale(0.9)';
                image.style.opacity = '0';
                
                // 等待动画完成后再移除元素
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
            
            // 切换图片 - 添加淡入淡出过渡效果
            function changeImage(newIndex) {
                if (newIndex >= 0 && newIndex < imageList.length) {
                    // 添加淡出效果
                    image.style.opacity = '0';
                    image.style.transition = 'opacity 0.3s ease-out';
                    
                    // 使用setTimeout确保淡出动画完成后再加载新图片
                    setTimeout(() => {
                        currentIndex = newIndex;
                        image.src = `./images/${folderName}/${imageList[currentIndex]}?t=${Date.now()}`; // 加时间戳防止缓存
                        
                        // 图片加载完成后添加淡入效果
                        image.onload = () => {
                            image.style.transition = 'opacity 0.3s ease-in';
                            image.style.opacity = '1';
                            
                            // 图片加载完成后应用边缘限制
                            const { x: limitedX, y: limitedY } = applyEdgeLimits(translateX, translateY);
                            translateX = limitedX;
                            translateY = limitedY;
                            updateTransform();
                        };
                        
                        if (pagination) {
                            // 确保显示正确的图片数量
                            pagination.textContent = `${currentIndex + 1}/${imageList.length}`;
                        }
                        
                        // 更新左右翻页按钮的显示状态
                        if (prevButton) {
                            if (currentIndex > 0) {
                                prevButton.classList.remove('opacity-0', 'invisible');
                                prevButton.classList.add('opacity-100', 'visible');
                            } else {
                                prevButton.classList.remove('opacity-100', 'visible');
                                prevButton.classList.add('opacity-0', 'invisible');
                            }
                        }
                        
                        if (nextButton) {
                            if (currentIndex < imageList.length - 1) {
                                nextButton.classList.remove('opacity-0', 'invisible');
                                nextButton.classList.add('opacity-100', 'visible');
                            } else {
                                nextButton.classList.remove('opacity-100', 'visible');
                                nextButton.classList.add('opacity-0', 'invisible');
                            }
                        }
                    }, 300);
                }
            }
            
            // 点击模态框背景或图片容器关闭
            modal.addEventListener('click', (e) => {
                // 点击任何地方都可以关闭模态框
                closeModal();
            });
            
            // 防止点击图片时传播到模态框关闭
            imageContainer.addEventListener('click', (e) => {
                e.stopPropagation();
                // 不再通过点击图片切换，使用专门的翻页按钮
            });
            
            // 添加左右翻页按钮点击事件
            if (prevButton) {
                prevButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止点击按钮关闭模态框
                    changeImage(currentIndex - 1);
                });
            }
            
            if (nextButton) {
                nextButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止点击按钮关闭模态框
                    changeImage(currentIndex + 1);
                });
            }
            
            // 键盘导航
            document.addEventListener('keydown', function handleKeydown(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleKeydown);
                } else if (e.key === 'ArrowLeft' && imageList.length > 1) {
                    changeImage(currentIndex - 1);
                } else if (e.key === 'ArrowRight' && imageList.length > 1) {
                    changeImage(currentIndex + 1);
                }
            });
            
            // 缩放和拖动功能
            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let lastDistance = 0;
            let isPinching = false;
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let initialTranslateX = 0;
            let initialTranslateY = 0;
            
            // 计算边缘限制
            function calculateEdgeLimits() {
                // 获取容器的原始尺寸（不考虑缩放）
                const originalWidth = imageContainer.offsetWidth;
                const originalHeight = imageContainer.offsetHeight;
                
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const edgeMargin = 40; // 固定边距值，不随缩放变化，从20像素增大到40像素
                
                // 计算缩放后的容器尺寸
                const scaledWidth = originalWidth * scale;
                const scaledHeight = originalHeight * scale;
                
                // 计算最大拖动范围
                let maxTranslateX = 0;
                let maxTranslateY = 0;
                
                // 计算X轴最大拖动距离
                if (scaledWidth > viewportWidth - 2 * edgeMargin) {
                    // 计算图片需要显示的区域（考虑边距）
                    const displayWidth = viewportWidth - 2 * edgeMargin;
                    // 图片超出显示区域的部分
                    const overflowX = scaledWidth - displayWidth;
                    // 最大拖动距离是超出部分的一半，除以缩放比例（因为translate会被scale影响）
                    maxTranslateX = (overflowX / 2) / scale;
                }
                
                // 计算Y轴最大拖动距离
                if (scaledHeight > viewportHeight - 2 * edgeMargin) {
                    // 计算图片需要显示的区域（考虑边距）
                    const displayHeight = viewportHeight - 2 * edgeMargin;
                    // 图片超出显示区域的部分
                    const overflowY = scaledHeight - displayHeight;
                    // 最大拖动距离是超出部分的一半，除以缩放比例（因为translate会被scale影响）
                    maxTranslateY = (overflowY / 2) / scale;
                }
                
                return { maxTranslateX, maxTranslateY };
            }
            
            // 应用边缘限制
            function applyEdgeLimits(newTranslateX, newTranslateY) {
                const { maxTranslateX, maxTranslateY } = calculateEdgeLimits();
                
                // 限制拖动范围，确保图片边缘与屏幕边缘保持边距
                const limitedX = Math.max(-maxTranslateX, Math.min(maxTranslateX, newTranslateX));
                const limitedY = Math.max(-maxTranslateY, Math.min(maxTranslateY, newTranslateY));
                
                return { x: limitedX, y: limitedY };
            }
            
            // 更新容器变换
            function updateTransform() {
                imageContainer.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
            }
            
            // 触摸开始事件
            imageContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    // 双指缩放
                    isPinching = true;
                    lastDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                } else if (e.touches.length === 1) {
                    // 单指触摸（拖动或滑动）
                    // 记录起始位置，无论是否缩放
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    initialTranslateX = translateX;
                    initialTranslateY = translateY;
                    
                    // 如果已经缩放，允许拖动
                    if (scale > 1) {
                        isDragging = true;
                    }
                }
            });
            
            // 触摸移动事件
            imageContainer.addEventListener('touchmove', (e) => {
                if (isPinching && e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    const delta = currentDistance - lastDistance;
                    const newScale = scale + delta * 0.005; // 增大缩放系数，从0.001改为0.005，提高缩放灵敏度
                    
                    // 限制缩放范围在1-5之间
                    scale = Math.max(1, Math.min(5, newScale));
                    
                    // 当缩放回原始大小（scale=1）时，重置位置到中心
                    if (scale === 1) {
                        translateX = 0;
                        translateY = 0;
                    } else {
                        // 缩放时也应用边缘限制
                        const { x: limitedX, y: limitedY } = applyEdgeLimits(translateX, translateY);
                        translateX = limitedX;
                        translateY = limitedY;
                    }
                    
                    updateTransform();
                    lastDistance = currentDistance;
                } else if (e.touches.length === 1) {
                    // 单指移动
                    if (scale > 1 && isDragging) {
                        e.preventDefault();
                        const currentX = e.touches[0].clientX;
                        const currentY = e.touches[0].clientY;
                        
                        // 计算新的位置，根据当前缩放比例调整拖动距离，使放大后拖动感觉和放大前相似
                        let dragX = (currentX - startX) / scale;
                        let dragY = (currentY - startY) / scale;
                        let newTranslateX = initialTranslateX + dragX;
                        let newTranslateY = initialTranslateY + dragY;
                        
                        // 应用边缘限制
                        const { x: limitedX, y: limitedY } = applyEdgeLimits(newTranslateX, newTranslateY);
                        
                        // 更新位置
                        translateX = limitedX;
                        translateY = limitedY;
                        
                        updateTransform();
                    }
                    // 不阻止默认行为，以便在非缩放状态下可以滑动切换图片
                }
            });
            
            // 触摸结束事件
            imageContainer.addEventListener('touchend', (e) => {
                // 检查是否是单指触摸结束
                if (e.changedTouches.length === 1) {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    
                    // 计算滑动距离
                    const deltaX = endX - startX;
                    const deltaY = endY - startY;
                    
                    // 判断是否是左右滑动手势（水平滑动距离大于垂直滑动距离，且滑动距离足够大）
                    if (Math.abs(deltaX) > Math.abs(deltaY) * 2 && Math.abs(deltaX) > 30) {
                        // 只有在原始缩放比例（未缩放）时才允许滑动切换图片
                        if (scale === 1) {
                            if (deltaX > 0) {
                                // 向右滑动，查看上一张图片
                                changeImage(currentIndex - 1);
                            } else {
                                // 向左滑动，查看下一张图片
                                changeImage(currentIndex + 1);
                            }
                        }
                    }
                }
                
                // 重置触摸状态
                isPinching = false;
                isDragging = false;
                lastDistance = 0;
            });
            
            // 鼠标按下事件（拖动开始）
            imageContainer.addEventListener('mousedown', (e) => {
                if (scale > 1) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTranslateX = translateX;
                    initialTranslateY = translateY;
                    imageContainer.style.cursor = 'grabbing';
                    e.preventDefault(); // 防止默认行为
                }
            });
            
            // 鼠标移动事件（拖动中）
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault(); // 防止页面滚动和选择文本
                    
                    const currentX = e.clientX;
                    const currentY = e.clientY;
                    
                    // 计算新的位置，根据当前缩放比例调整拖动距离，使放大后拖动感觉和放大前相似
                    let dragX = (currentX - startX) / scale;
                    let dragY = (currentY - startY) / scale;
                    let newTranslateX = initialTranslateX + dragX;
                    let newTranslateY = initialTranslateY + dragY;
                    
                    // 应用边缘限制
                    const { x: limitedX, y: limitedY } = applyEdgeLimits(newTranslateX, newTranslateY);
                    
                    // 更新位置
                    translateX = limitedX;
                    translateY = limitedY;
                    
                    // 使用requestAnimationFrame提高性能
                    requestAnimationFrame(() => {
                        updateTransform();
                    });
                }
            });
            
            // 鼠标释放事件（拖动结束）
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    imageContainer.style.cursor = 'grab';
                }
            });
            
            // 双击重置缩放和位置
            imageContainer.addEventListener('dblclick', () => {
                scale = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
            });
            
            // 鼠标滚轮缩放功能
            imageContainer.addEventListener('wheel', (e) => {
                e.preventDefault(); // 防止页面滚动
                
                // 根据滚轮方向调整缩放比例
                const delta = e.deltaY * -0.001; // 负号使滚轮向上为放大
                const newScale = scale + delta;
                
                // 限制缩放范围在1-5之间（与触摸缩放保持一致）
                scale = Math.max(1, Math.min(5, newScale));
                
                // 当缩放回原始大小（scale=1）时，重置位置到中心
                if (scale === 1) {
                    translateX = 0;
                    translateY = 0;
                } else {
                    // 缩放时也应用边缘限制
                    const { x: limitedX, y: limitedY } = applyEdgeLimits(translateX, translateY);
                    translateX = limitedX;
                    translateY = limitedY;
                }
                
                // 更新容器缩放
                updateTransform();
            });
        }
        
        // 获取今天的日期字符串
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 破晓红石地点推算函数
        function getDawnRedstoneLocation(date, dayOfWeek) {
            const dayOfMonth = date.getDate();
            
            // 暮土系 (日期: 1,6,11,16,21,26,31)
            if ([1, 6, 11, 16, 21, 26, 31].includes(dayOfMonth)) {
                if (dayOfWeek === 5) return "暮土-黑水港湾";
                if (dayOfWeek === 6) return "暮土-巨兽荒原";
                if (dayOfWeek === 0) return "暮土-失落方舟";
            }
            
            // 禁阁系 (日期: 2,7,12,17,22,27)
            if ([2, 7, 12, 17, 22, 27].includes(dayOfMonth)) {
                if ([5, 6, 0].includes(dayOfWeek)) return "禁阁-星漠海滩";
            }
            
            // 云野系 (日期: 3,8,13,18,23,28)
            if ([3, 8, 13, 18, 23, 28].includes(dayOfMonth)) {
                if (dayOfWeek === 5) return "云野-云顶浮石";
                if (dayOfWeek === 6) return "云野-幽光山洞";
                if (dayOfWeek === 0) return "云野-圣岛";
            }
            
            // 雨林系 (日期: 4,9,14,19,24,29)
            if ([4, 9, 14, 19, 24, 29].includes(dayOfMonth)) {
                if (dayOfWeek === 5) return "雨林-大树屋";
                if (dayOfWeek === 6) return "雨林-雨林神庙";
                if (dayOfWeek === 0) return "雨林-秘密花园";
            }
            
            // 霞谷系 (日期: 5,10,15,20,25,30)
            if ([5, 10, 15, 20, 25, 30].includes(dayOfMonth)) {
                if ([5, 6].includes(dayOfWeek)) return "霞谷-圆梦村";
                if (dayOfWeek === 0) return "霞谷-雪隐峰";
            }
            
            return "未知地点";
        }
        
        // 修复：破晓红石事件特殊规则函数
        function isDawnRedstoneActive(now) {
            const currentDate = now.getDate();
            const currentDay = now.getDay();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinute;
            
            // 当月的每个周日固定时间段循环事件
            if (currentDay === 0) {
                const timeSlots = [
                    { start: 7*60+8, end: 8*60+0 },
                    { start: 13*60+8, end: 14*60+0 },
                    { start: 19*60+8, end: 20*60+0 }
                ];
                
                for (let slot of timeSlots) {
                    if (currentTime >= slot.start && currentTime < slot.end) {
                        const startTime = new Date(now);
                        startTime.setHours(Math.floor(slot.start/60), slot.start%60, 0, 0);
                        const endTime = new Date(now);
                        endTime.setHours(Math.floor(slot.end/60), slot.end%60, 0, 0);
                        return { 
                            startTime, 
                            endTime,
                            location: getDawnRedstoneLocation(now, currentDay)
                        };
                    }
                }
            }
            
            // 当月的1号到15号内的每个周六固定时间段循环事件
            if (currentDay === 6 && currentDate >= 1 && currentDate <= 15) {
                const timeSlots = [
                    { start: 10*60+8, end: 11*60+0 },
                    { start: 14*60+8, end: 15*60+0 },
                    { start: 22*60+8, end: 23*60+0 }
                ];
                
                for (let slot of timeSlots) {
                    if (currentTime >= slot.start && currentTime < slot.end) {
                        const startTime = new Date(now);
                        startTime.setHours(Math.floor(slot.start/60), slot.start%60, 0, 0);
                        const endTime = new Date(now);
                        endTime.setHours(Math.floor(slot.end/60), slot.end%60, 0, 0);
                        return { 
                            startTime, 
                            endTime,
                            location: getDawnRedstoneLocation(now, currentDay)
                        };
                    }
                }
            }
            
            // 当月的16号到当月底内的每个周五固定时间段循环事件
            if (currentDay === 5 && currentDate >= 16) {
                const timeSlots = [
                    { start: 11*60+8, end: 12*60+0 },
                    { start: 17*60+8, end: 18*60+0 },
                    { start: 23*60+8, end: 24*60+0 }
                ];
                
                for (let slot of timeSlots) {
                    let startTime, endTime;
                    
                    if (slot.end === 24*60) {
                        startTime = new Date(now);
                        startTime.setHours(Math.floor(slot.start/60), slot.start%60, 0, 0);
                        endTime = new Date(now);
                        endTime.setDate(endTime.getDate() + 1);
                        endTime.setHours(0, 0, 0, 0);
                    } else {
                        startTime = new Date(now);
                        startTime.setHours(Math.floor(slot.start/60), slot.start%60, 0, 0);
                        endTime = new Date(now);
                        endTime.setHours(Math.floor(slot.end/60), slot.end%60, 0, 0);
                    }
                    
                    if (now >= startTime && now < endTime) {
                        return { 
                            startTime, 
                            endTime,
                            location: getDawnRedstoneLocation(now, currentDay)
                        };
                    }
                }
            }
            
            return null;
        }
        
        // 修复：计算破晓红石事件的下一次发生时间
        function getNextDawnRedstoneOccurrence(now) {
            const currentActiveInfo = isDawnRedstoneActive(now);
            if (currentActiveInfo) {
                return {
                    startTime: currentActiveInfo.startTime,
                    location: currentActiveInfo.location
                };
            }
            
            const today = new Date(now);
            today.setHours(0, 0, 0, 0);
            
            const currentDate = now.getDate();
            const currentDay = now.getDay();
            
            const timeSlots = getDawnRedstoneTimeSlots(currentDate, currentDay);
            for (let slot of timeSlots) {
                const slotTime = new Date(today);
                slotTime.setHours(Math.floor(slot.start/60), slot.start%60, 0, 0);
                
                if (slotTime > now) {
                    return {
                        startTime: slotTime,
                        location: getDawnRedstoneLocation(slotTime, slotTime.getDay())
                    };
                }
            }
            
            for (let i = 1; i <= 7; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() + i);
                const checkDay = checkDate.getDay();
                const checkDateNum = checkDate.getDate();
                
                const daySlots = getDawnRedstoneTimeSlots(checkDateNum, checkDay);
                if (daySlots.length > 0) {
                    const firstSlot = daySlots[0];
                    const firstSlotTime = new Date(checkDate);
                    firstSlotTime.setHours(Math.floor(firstSlot.start/60), firstSlot.start%60, 0, 0);
                    return {
                        startTime: firstSlotTime,
                        location: getDawnRedstoneLocation(firstSlotTime, firstSlotTime.getDay())
                    };
                }
            }
            
            const defaultTime = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            return {
                startTime: defaultTime,
                location: getDawnRedstoneLocation(defaultTime, defaultTime.getDay())
            };
        }
        
        // 获取指定日期的破晓红石时间段
        function getDawnRedstoneTimeSlots(date, day) {
            const slots = [];
            
            if (day === 0) {
                slots.push(
                    { start: 7*60+8, end: 8*60+0 },
                    { start: 13*60+8, end: 14*60+0 },
                    { start: 19*60+8, end: 20*60+0 }
                );
            }
            
            if (day === 6 && date >= 1 && date <= 15) {
                slots.push(
                    { start: 10*60+8, end: 11*60+0 },
                    { start: 14*60+8, end: 15*60+0 },
                    { start: 22*60+8, end: 23*60+0 }
                );
            }
            
            if (day === 5 && date >= 16) {
                slots.push(
                    { start: 11*60+8, end: 12*60+0 },
                    { start: 17*60+8, end: 18*60+0 },
                    { start: 23*60+8, end: 24*60+0 }
                );
            }
            
            return slots;
        }
        
        // 事件数据 - 修复空间站配置
        // 硬编码任务数据常量
        const hardcodedTasksData = [
            {
                id: 1,
                name: "奶奶饭",
                startDate: getTodayDate(),
                startTime: "08:00",
                displayThreshold: 10,
                displayThresholdUnit: "minute",
                priority: "medium",
                recurrence: {
                    type: "daily_times",
                    customTimes: ["08:00", "10:00", "12:00", "16:00", "18:00", "20:00", "22:00"],
                    duration: 30,
                    durationUnit: "minute"
                }
            },
            {
                id: 2,
                name: "圣岛贝壳",
                startDate: getTodayDate(),
                startTime: "00:00",
                displayThreshold: 3,
                displayThresholdUnit: "minute",
                priority: "low",
                recurrence: {
                    type: "custom",
                    count: 30,
                    unit: "minute",
                    duration: 20,
                    durationUnit: "minute"
                }
            },
            {
                id: 3,
                name: "献祭 重置",
                startDate: getTodayDate(),
                startTime: "00:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "weekly",
                    weekdays: [0],
                    duration: 1,
                    durationUnit: "day"
                }
            },
            {
                id: 4,
                name: "每日 重置",
                startDate: getTodayDate(),
                startTime: "00:00",
                displayThreshold: 30,
                displayThresholdUnit: "minute",
                priority: "high",
                recurrence: {
                    type: "daily",
                    duration: 5,
                    durationUnit: "minute"
                }
            },
            {
                id: 5,
                name: "AURORA",
                startDate: getTodayDate(),
                startTime: "00:00",
                displayThreshold: 30,
                displayThresholdUnit: "minute",
                priority: "low",
                recurrence: {
                    type: "custom",
                    count: 4,
                    unit: "hour",
                    duration: 50,
                    durationUnit: "minute"
                }
            },
            {
                id: 6,
                name: "先祖复刻",
                startDate: "2025-10-16",
                startTime: "06:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "custom",
                    count: 2,
                    unit: "week",
                    duration: 102,
                    durationUnit: "hour"
                }
            },
            {
                id: 7,
                name: "空间站",
                startDate: "2024-01-01", // 修复：使用固定的开始日期
                startTime: "00:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "monthly",
                    days: [5, 13, 21, 29],
                    duration: 1,
                    durationUnit: "day"
                }
            },
            {
                id: 8,
                name: "破晓 红石",
                startDate: getTodayDate(),
                startTime: "07:08",
                displayThreshold: 3,
                displayThresholdUnit: "hour",
                priority: "high",
                recurrence: {
                    type: "custom_complex",
                    pattern: "dawn_redstone",
                    duration: 52,
                    durationUnit: "minute"
                }
            },
            {
                id:10,
                name: "迁徙季",
                startDate: "2025-10-24",
                startTime: "10:00", 
                displayThreshold: 3,
                displayThresholdUnit: "day",
                priority: "none",
                recurrence: {
                    type: "none",
                    duration: 77,
                    durationUnit: "day"
                }
            },
            {
                id: 11,
                name: "万圣节",
                startDate: "2025-10-31",
                startTime: "00:00", 
                displayThreshold: 3,
                displayThresholdUnit: "day",
                priority: "none",
                recurrence: {
                    type: "none",
                    duration: 3,
                    durationUnit: "week"
                }
            },
            {
                id: 12,
                name: "狼人杀 活动",
                startDate: "2025-11-19",
                startTime: "00:00", 
                displayThreshold: 3,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "none",
                    duration: 2,
                    durationUnit: "week"
                }
            },
            {
                id: 13,
                name: "全图大蜡",
                startDate: "2025-11-14",
                startTime: "00:00", 
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "none",
                    duration: 1,
                    durationUnit: "week"
                }
            },

            {
                id: 15,
                name: "双倍魔法",
                startDate: "2025-11-07",
                startTime: "00:00", 
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "none",
                    duration: 1,
                    durationUnit: "week"
                }
            },
            {
                id: 17,
                name: "染料商店",
                startDate: getTodayDate(),
                startTime: "00:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "weekly",
                    weekdays: [1],
                    duration: 1,
                    durationUnit: "day"
                }
            },
            {
                id: 16,
                name: "复刻 公布",
                startDate: "2025-10-28",
                startTime: "12:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "custom",
                    count: 2,
                    unit: "week",
                    duration: 1,
                    durationUnit: "day"
                }
            },
            {
                id: 9,
                name: "家具 轮换",
                startDate: getTodayDate(),
                startTime: "00:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "weekly",
                    weekdays: [4],
                    duration: 1,
                    durationUnit: "day"
                }
            },
            {
                id: 18,
                name: "烟花大会",
                startDate: "2025-12-01",
                startTime: "00:00",
                displayThreshold: 3,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "monthly_times",
                    days: [2],
                    customTimes: ["00:00", "04:00", "08:00", "12:00", "16:00", "20:00"],
                    duration: 20,
                    durationUnit: "minute"
                }
            },
        ];
        
        // 初始化tasks为硬编码数据
        let tasks = [...hardcodedTasksData];

        // 当前操作的事件ID
        let currentTaskId = null;

        // DOM元素
        const currentTimeEl = document.getElementById('current-time');
        const taskCarousel = document.getElementById('task-carousel');
        const allTasksEl = document.getElementById('all-tasks');
        const allTasksListEl = document.getElementById('all-tasks-list');
        const appContainer = document.getElementById('app-container');
        const controlsContainer = document.getElementById('controls-container');
        const mainContextMenu = document.getElementById('main-context-menu');
        const taskContextMenu = document.getElementById('task-context-menu');
        const addTaskOption = document.getElementById('add-task-option');
        const editTaskOption = document.getElementById('edit-task-option');
        const deleteTaskOption = document.getElementById('delete-task-option');
        const taskModal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModal = document.getElementById('close-modal');
        const cancelTask = document.getElementById('cancel-task');
        const taskForm = document.getElementById('task-form');
        const taskIdInput = document.getElementById('task-id');
        const displayThresholdInput = document.getElementById('display-threshold');
        const displayThresholdUnitInput = document.getElementById('display-threshold-unit');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const closeDeleteModal = document.getElementById('close-delete-modal');
        const cancelDelete = document.getElementById('cancel-delete');
        const confirmDelete = document.getElementById('confirm-delete');
        const recurrenceTypeInput = document.getElementById('recurrence-type');
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');
        const noneOptions = document.getElementById('none-options');
        const dailyOptions = document.getElementById('daily-options');
        const customOptions = document.getElementById('custom-options');
        const dailyTimesOptions = document.getElementById('daily-times-options');
        const intervalOptions = document.getElementById('interval-options');
        const monthlyIntervalOptions = document.getElementById('monthly_interval-options');
        const dailyTimesContainer = document.getElementById('daily-times-container');
        const addTimeBtn = document.getElementById('add-time-btn');
        const intervalCountInput = document.getElementById('interval-count');
        const intervalUnitInput = document.getElementById('interval-unit');
        const taskDurationInput = document.getElementById('task-duration');
        const durationUnitInput = document.getElementById('duration-unit');
        const weekdayCheckboxes = document.querySelectorAll('input[name="weekday"]');
        const monthdayCheckboxes = document.querySelectorAll('input[name="monthday"]');
        const monthweekdayCheckboxes = document.querySelectorAll('input[name="monthweekday"]');
        const recurrenceOptions = document.querySelectorAll('.recurrence-option');
        const downloadBtn = document.getElementById('download-btn');
        const manualSaveBtn = document.getElementById('manual-save-btn');
        const lockIndicator = document.getElementById('lock-indicator');
        const emptyHoverArea = document.querySelector('.empty-hover-area');
        const previewCard = document.getElementById('preview-card');
        
        // 初始化日期和时间为今天和当前时间
        document.addEventListener('DOMContentLoaded', async () => {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(':').slice(0, 2).join(':');
            
            // 根据当前选择的重复类型设置对应的开始日期和时间输入框
            const selectedRecurrenceType = document.querySelector('.recurrence-option.selected')?.getAttribute('data-type') || 'none';
            const currentStartDateInput = document.getElementById(`${selectedRecurrenceType}-start-date`);
            const currentStartTimeInput = document.getElementById(`${selectedRecurrenceType}-start-time`);
            
            if (currentStartDateInput) currentStartDateInput.value = dateStr;
            if (currentStartTimeInput) currentStartTimeInput.value = timeStr;
            
            // 初始化重复选项点击事件
            recurrenceOptions.forEach(option => {
                option.addEventListener('click', () => {
                    recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    const type = option.getAttribute('data-type');
                    if (recurrenceTypeInput) recurrenceTypeInput.value = type;
                    showRecurrenceOptions(type);
                });
            });
            
            // 初始化添加时间点按钮
            addTimeBtn.addEventListener('click', addTimeInput);
            
            // 检查是否有外部数据并加载
            // 优先从Supabase加载数据
            const supabaseData = await loadFromSupabase();
            if (supabaseData) {
                // 合并硬编数据和云端数据，以id为准
                // 1. 创建一个以id为键的映射表
                const mergedTasksMap = new Map();
                
                // 2. 先添加硬编数据到映射表
                hardcodedTasksData.forEach(task => {
                    mergedTasksMap.set(task.id, task);
                });
                
                // 3. 再添加云端数据，相同id会覆盖硬编数据
                supabaseData.forEach(task => {
                    mergedTasksMap.set(task.id, task);
                });
                
                // 4. 转换回数组
                tasks = Array.from(mergedTasksMap.values());
                showNotification('云端数据加载成功', false);
            } else {
                // 如果Supabase加载失败，尝试从localStorage加载
                const savedData = loadFromLocalStorage();
                if (savedData) {
                    // 合并硬编数据和localStorage数据
                    const mergedTasksMap = new Map();
                    hardcodedTasksData.forEach(task => {
                        mergedTasksMap.set(task.id, task);
                    });
                    savedData.forEach(task => {
                        mergedTasksMap.set(task.id, task);
                    });
                    tasks = Array.from(mergedTasksMap.values());
                } else {
                    // 保存初始任务列表
                    saveToLocalStorage(tasks);
                }
            }
            
            // 初始化下载按钮事件
            downloadBtn.addEventListener('click', downloadAsHtml);
            
            // 初始化手动保存按钮事件
        manualSaveBtn.addEventListener('click', async () => {
            if (await validatePassword()) {
                await saveToLocalStorage(tasks);
            } else {
                showNotification('密码错误，保存失败', true);
            }
        });
            
            // 添加自动刷新机制，每60秒从Supabase加载一次最新数据
            setInterval(async () => {
                const latestData = await loadFromSupabase();
                if (latestData) {
                    // 合并硬编数据和最新云端数据
                    const mergedTasksMap = new Map();
                    
                    // 1. 先添加硬编数据到映射表
                    hardcodedTasksData.forEach(task => {
                        mergedTasksMap.set(task.id, task);
                    });
                    
                    // 2. 再添加云端数据，相同id会覆盖硬编数据
                    latestData.forEach(task => {
                        mergedTasksMap.set(task.id, task);
                    });
                    
                    const mergedTasks = Array.from(mergedTasksMap.values());
                    
                    if (JSON.stringify(mergedTasks) !== JSON.stringify(tasks)) {
                        tasks = mergedTasks;
                        renderTasks();
                        showNotification('数据已自动更新', false);
                    }
                }
            }, 60000); // 60秒刷新一次
            
            // 初始化悬停空白区域点击事件用于锁定
            // 删除锁定功能，lockIndicator现在是静态链接
        // emptyHoverArea.addEventListener('click', toggleListLock);
            
            // 点击其他地方隐藏预览卡片
            document.addEventListener('click', (e) => {
                if (!previewCard.contains(e.target) && !e.target.closest('.future-task-item')) {
                    hidePreviewCard();
                }
            });
            
            // 跟踪鼠标移动以实现丝滑跟随
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                if (isPreviewVisible) {
                    updatePreviewCardPosition(mouseX, mouseY);
                }
            });
            
            // 验证本地存储是否可用
            testLocalStorageAvailability();
            
            // 初始化显示
            updateCurrentTime();
            updateTasks();
        });
        
        // 添加时间输入框
        function addTimeInput(timeValue = "") {
            const timeId = 'daily-time-' + Date.now();
            const timeInput = document.createElement('div');
            timeInput.className = 'flex items-center gap-2';
            timeInput.innerHTML = `
                <input type="time" value="${timeValue}" class="flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                <button type="button" class="remove-time-btn px-2 py-2 text-red-500 hover:text-red-400 transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            `;
            
            const removeBtn = timeInput.querySelector('.remove-time-btn');
            removeBtn.addEventListener('click', () => {
                timeInput.remove();
            });
            
            dailyTimesContainer.appendChild(timeInput);
        }
        
        // 获取所有每日特定时间
        function getDailyTimes() {
            const timeInputs = dailyTimesContainer.querySelectorAll('input[type="time"]');
            const times = [];
            timeInputs.forEach(input => {
                if (input.value) {
                    times.push(input.value);
                }
            });
            return times.sort();
        }
        
        // 显示预览卡片 - 使用现有数据，无需重新计算
        function showPreviewCard(task, x, y) {
            // 从当前显示的任务数据中获取信息
            let currentTask = currentAllTasks.find(t => t.id === task.id);
            
            if (!currentTask) return;
            
            // 生成重复方式文本
            let recurrenceText = "";
            if (currentTask.recurrence.type === "custom_complex" && currentTask.recurrence.pattern === "dawn_redstone") {
                recurrenceText = "红石规则";
            } else if (currentTask.recurrence.type === "daily_times" && currentTask.recurrence.customTimes) {
                // 简化时间显示：将"08:00"格式转换为"8点"
                let simplifiedTimes = currentTask.recurrence.customTimes.map(time => {
                    const hour = parseInt(time.split(':')[0]);
                    return `${hour}点`;
                });
                recurrenceText = `每天 ${simplifiedTimes.join(', ')}`;
            } else {
                const unitNames = {
                    "minute": "分钟",
                    "hour": "小时",
                    "day": "天",
                    "week": "周",
                    "month": "月"
                };
                switch(currentTask.recurrence.type) {
                    case "none":
                        recurrenceText = "不重复";
                        break;
                    case "daily":
                        recurrenceText = "每天";
                        break;
                    case "daily_times":
                        // 简化时间显示：将"08:00"格式转换为"8点"
                        simplifiedTimes = currentTask.recurrence.customTimes?.map(time => {
                            const hour = parseInt(time.split(':')[0]);
                            return `${hour}点`;
                        }) || [];
                        recurrenceText = `每天 ${simplifiedTimes.join(', ')}`;
                        break;
                    case "weekly":
                        const dayNames = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
                        const selectedDays = currentTask.recurrence.weekdays?.map(day => dayNames[day]).join(', ') || "";
                        recurrenceText = `每周${selectedDays}`;
                        break;
                    case "monthly":
                        const monthDayNames = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
                        if (currentTask.recurrence.weekdays && currentTask.recurrence.weekdays.length > 0) {
                            const selectedWeekDays = currentTask.recurrence.weekdays?.map(day => monthDayNames[day]).join(', ') || "";
                            recurrenceText = `每月${selectedWeekDays}`;
                        } else if (currentTask.recurrence.days && currentTask.recurrence.days.length > 0) {
                            const selectedDays = currentTask.recurrence.days?.join(', ') || "";
                            recurrenceText = `每月${selectedDays}日`;
                        }
                        break;
                    case "monthly_times":
                        const monthDays = currentTask.recurrence.days?.join(', ') || "";
                        // 简化时间显示：将"08:00"格式转换为"8点"
                        simplifiedTimes = currentTask.recurrence.customTimes?.map(time => {
                            const hour = parseInt(time.split(':')[0]);
                            return `${hour}点`;
                        }) || [];
                        recurrenceText = `每月${monthDays}日 ${simplifiedTimes.join(', ')}`;
                        break;
                    case "interval":
                        recurrenceText = `每${currentTask.recurrence.count}${unitNames[currentTask.recurrence.unit]}`;
                        break;
                    case "monthly_interval":
                        const selectedMonthDays = currentTask.recurrence.days?.join(', ') || "";
                        recurrenceText = `每月${selectedMonthDays}日 每${currentTask.recurrence.count}${unitNames[currentTask.recurrence.unit]}`;
                        break;
                    case "custom":
                        recurrenceText = `每${currentTask.recurrence.count}${unitNames[currentTask.recurrence.unit]}`;
                        break;
                }
            }
            
            // 生成持续时间文本
            const durationUnitNames = {
                "minute": "分钟",
                "hour": "小时",
                "day": "天",
                "week": "周"
            };
            const durationText = `${currentTask.recurrence.duration}${durationUnitNames[currentTask.recurrence.durationUnit]}`;
            
            // 生成时间范围文本
            const isToday = currentTask.startTime && currentTask.startTime.toLocaleDateString() === new Date().toLocaleDateString();
            const dateText = isToday ? '今天' : currentTask.startTime ? currentTask.startTime.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric', weekday: 'short'}) : '';
            const timeText = currentTask.startTime && currentTask.endTime ? 
                `${currentTask.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})} - ${currentTask.endTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}` : '';
            
            // 生成提醒文本
            const alertText = `提前${currentTask.displayThreshold} ${currentTask.displayThresholdUnit === 'minute' ? '分钟' : currentTask.displayThresholdUnit === 'hour' ? '小时' : currentTask.displayThresholdUnit === 'day' ? '天' : '周'}提醒`;
            
            // 更新预览卡片内容
            document.getElementById('preview-priority').className = `w-2 h-2 rounded-full mr-2 bg-priority-${currentTask.priority}`;
            document.getElementById('preview-name').textContent = currentTask.name;
            
            const statusIndicator = currentTask.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            const statusTextClass = currentTask.status === "ongoing" ? "ongoing-text" : "";
            document.getElementById('preview-status').innerHTML = `${statusIndicator}<span class="${statusTextClass}">${currentTask.timeText}</span>`;
            
            document.getElementById('preview-recurrence').textContent = recurrenceText;
            document.getElementById('preview-duration').textContent = `持续 ${durationText}`;
            document.getElementById('preview-date').textContent = dateText;
            document.getElementById('preview-time').textContent = timeText;
            document.getElementById('preview-alert').textContent = alertText;
            
            // 设置卡片位置
            updatePreviewCardPosition(x, y);
            
            // 显示卡片并添加高亮动画
            previewCard.classList.add('show', 'preview-highlight');
            currentPreviewTaskId = currentTask.id;
            isPreviewVisible = true;
        }
        
        // 更新预览卡片位置（丝滑跟随）
        function updatePreviewCardPosition(x, y) {
            const cardWidth = previewCard.offsetWidth;
            const cardHeight = previewCard.offsetHeight;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let finalX = x + 15;
            let finalY = y + 15;
            
            // 确保卡片不会超出视口
            if (finalX + cardWidth > viewportWidth - 10) {
                finalX = x - cardWidth - 15;
            }
            if (finalY + cardHeight > viewportHeight - 10) {
                finalY = viewportHeight - cardHeight - 10;
            }
            
            // 确保卡片不会超出视口顶部
            if (finalY < 10) {
                finalY = 10;
            }
            
            previewCard.style.left = `${finalX}px`;
            previewCard.style.top = `${finalY}px`;
        }
        
        // 隐藏预览卡片
        function hidePreviewCard() {
            previewCard.classList.remove('show', 'preview-highlight');
            currentPreviewTaskId = null;
            isPreviewVisible = false;
        }
        
        // 专门为未来事件列表添加点击预览交互 - 修复版本
        function addClickPreviewInteractionToFutureTask(element, task) {
            element.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 如果已经显示的是当前任务，则隐藏它
                if (isPreviewVisible && currentPreviewTaskId === task.id) {
                    hidePreviewCard();
                } else {
                    // 否则显示预览卡片
                    showPreviewCard(task, e.clientX, e.clientY);
                }
            });
            
            // 添加双击事件跳转到详细日历页面 - 仅针对破晓红石事件
            element.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                
                // 检查是否为破晓红石事件
                if (task.name === "破晓 红石" || 
                    (task.recurrence.type === "custom_complex" && task.recurrence.pattern === "dawn_redstone")) {
                    // 跳转到详细日历页面
                    window.location.href = 'HHS.html';
                }
            });
            
            // 保留鼠标移动时的位置更新
            element.addEventListener('mousemove', (e) => {
                if (isPreviewVisible && currentPreviewTaskId === task.id) {
                    updatePreviewCardPosition(e.clientX, e.clientY);
                }
            });
        }
        
        // 切换任务列表锁定功能已移除，lockIndicator现在是静态链接
        // function toggleListLock() {
        //     isListLocked = !isListLocked;
        //     const icon = lockIndicator.querySelector('i');
        //     
        //     if (isListLocked) {
        //         icon.classList.remove('fa-unlock');
        //         icon.classList.add('fa-lock');
        //         lockIndicator.classList.add('locked');
        //         allTasksEl.style.maxHeight = '500px';
        //         showNotification('任务列表已锁定显示');
        //     } else {
        //         icon.classList.remove('fa-lock');
        //         icon.classList.add('fa-unlock');
        //         lockIndicator.classList.remove('locked');
        //         allTasksEl.style.maxHeight = '0';
        //         showNotification('任务列表已解锁');
        //     }
        // }
        
        // 测试本地存储是否可用
        function testLocalStorageAvailability() {
            try {
                const testKey = 'test_local_storage_availability_' + Math.random();
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
            } catch (e) {
                console.error('LocalStorage is not available:', e);
                showNotification('本地存储不可用，建议使用下载功能保存数据', true);
            }
        }
        
        // 转换时间单位为毫秒
        function convertToMilliseconds(value, unit) {
            const units = {
                minute: 60 * 1000,
                hour: 60 * 60 * 1000,
                day: 24 * 60 * 60 * 1000,
                week: 7 * 24 * 60 * 60 * 1000,
                month: 30 * 24 * 60 * 60 * 1000
            };
            return value * (units[unit] || units.minute);
        }
        
        // 转换毫秒为最适合的单位
        function convertFromMilliseconds(ms) {
            if (ms >= 30 * 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (30 * 24 * 60 * 60 * 1000)), unit: 'month', text: '月' };
            } else if (ms >= 7 * 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (7 * 24 * 60 * 60 * 1000)), unit: 'week', text: '周' };
            } else if (ms >= 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (24 * 60 * 60 * 1000)), unit: 'day', text: '天' };
            } else if (ms >= 60 * 60 * 1000) {
                return { value: Math.round(ms / (60 * 60 * 1000)), unit: 'hour', text: '小时' };
            } else {
                return { value: Math.round(ms / (60 * 1000)), unit: 'minute', text: '分钟' };
            }
        }

        // 密码验证功能
        const ADMIN_PASSWORD = 'sky-13'; // 可以修改为更复杂的密码
        
        // 创建密码验证模态对话框的HTML结构
        const passwordModalHTML = `
            <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl">
                    <h3 class="text-lg font-semibold mb-4">请输入管理员密码</h3>
                    <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="密码">
                    <div class="flex justify-end space-x-2">
                        <button id="password-cancel" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">取消</button>
                        <button id="password-confirm" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">确认</button>
                    </div>
                </div>
            </div>
        `;
        
        // 将模态对话框添加到body
        document.body.insertAdjacentHTML('beforeend', passwordModalHTML);
        
        // 密码验证模态对话框相关变量
        let passwordResolve = null;
        
        // 绑定事件
        document.getElementById('password-confirm').addEventListener('click', () => {
            const password = document.getElementById('password-input').value;
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('password-input').value = '';
            passwordResolve(password === ADMIN_PASSWORD);
        });
        
        document.getElementById('password-cancel').addEventListener('click', () => {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('password-input').value = '';
            passwordResolve(false);
        });
        
        // 允许按Enter键确认
        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('password-confirm').click();
            }
        });
        
        // 验证管理员密码（使用自定义模态对话框）
        async function validatePassword() {
            return new Promise((resolve) => {
                passwordResolve = resolve;
                document.getElementById('password-modal').classList.remove('hidden');
                document.getElementById('password-input').focus();
            });
        }

        // 格式化倒计时显示
        function formatCountdown(ms) {
            if (ms < 0) return "已开始";
            
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            if (days > 0) {
                return `${days}天${hours}时`;
            } else if (hours > 0) {
                return `${hours}时${minutes}分`;
            } else if (minutes > 0) {
                return `${minutes}分${seconds}秒`;
            } else {
                return `${seconds}秒`;
            }
        }

        // 轮播状态
        let currentSlide = 0;
        let visibleTasks = [];

        // 更新当前时间显示
        function updateCurrentTime() {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 修复：增强每月重复事件的计算逻辑
        function getNextOccurrence(task, now) {
            try {
                // 处理破晓红石复杂事件
                if (task.recurrence.type === "custom_complex" && task.recurrence.pattern === "dawn_redstone") {
                    const nextTime = getNextDawnRedstoneOccurrence(now);
                    return {
                        startTime: nextTime.startTime,
                        location: nextTime.location
                    };
                }
                
                // 特殊处理每日特定时间重复
                if (task.recurrence.type === "daily_times" && task.recurrence.customTimes && task.recurrence.customTimes.length > 0) {
                    const today = new Date(now);
                    today.setHours(0, 0, 0, 0);
                    
                    for (const timeStr of task.recurrence.customTimes) {
                        const [hours, minutes] = timeStr.split(':').map(Number);
                        const candidate = new Date(today);
                        candidate.setHours(hours, minutes, 0, 0);
                        
                        if (candidate > now) {
                            return {
                                startTime: candidate,
                                location: null
                            };
                        }
                        
                        const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                        if (candidate <= now && now < candidate.getTime() + durationMs) {
                            return {
                                startTime: candidate,
                                location: null
                            };
                        }
                    }
                    
                    const firstTime = task.recurrence.customTimes[0];
                    const [firstHours, firstMinutes] = firstTime.split(':').map(Number);
                    const nextDay = new Date(today);
                    nextDay.setDate(nextDay.getDate() + 1);
                    nextDay.setHours(firstHours, firstMinutes, 0, 0);
                    return {
                        startTime: nextDay,
                        location: null
                    };
                }
                
                // 特殊处理每月特定日期特定时间重复
                if (task.recurrence.type === "monthly_times" && task.recurrence.days && task.recurrence.days.length > 0 && task.recurrence.customTimes && task.recurrence.customTimes.length > 0) {
                    const today = new Date(now);
                    const currentYear = today.getFullYear();
                    const currentMonth = today.getMonth();
                    const currentDate = today.getDate();
                    
                    // 生成当前月份和下个月需要检查的日期
                    const checkMonths = [
                        { year: currentYear, month: currentMonth },
                        { year: currentMonth === 11 ? currentYear + 1 : currentYear, month: currentMonth === 11 ? 0 : currentMonth + 1 }
                    ];
                    
                    for (const monthInfo of checkMonths) {
                        const { year, month } = monthInfo;
                        
                        // 遍历每月重复的日期
                        for (const day of task.recurrence.days) {
                            // 如果是当前月份，只检查今天及以后的日期
                            if (year === currentYear && month === currentMonth && day < currentDate) {
                                continue;
                            }
                            
                            // 遍历每日重复的时间点
                            for (const timeStr of task.recurrence.customTimes) {
                                const [hours, minutes] = timeStr.split(':').map(Number);
                                const candidate = new Date(year, month, day, hours, minutes, 0, 0);
                                
                                // 检查日期是否有效（避免2月30日等无效日期）
                                if (candidate.getDate() !== day) {
                                    continue;
                                }
                                
                                // 如果候选时间在未来，返回它
                                if (candidate > now) {
                                    return {
                                        startTime: candidate,
                                        location: null
                                    };
                                }
                                
                                // 检查当前时间是否在事件持续时间内
                                const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                                if (candidate <= now && now < candidate.getTime() + durationMs) {
                                    return {
                                        startTime: candidate,
                                        location: null
                                    };
                                }
                            }
                        }
                    }
                    
                    // 如果所有检查都没找到，返回第一个时间点的下一个月日期
                    const firstDay = task.recurrence.days[0];
                    const firstTime = task.recurrence.customTimes[0];
                    const [firstHours, firstMinutes] = firstTime.split(':').map(Number);
                    
                    let nextYear = currentYear;
                    let nextMonth = currentMonth + 2;
                    if (nextMonth > 11) {
                        nextYear += Math.floor(nextMonth / 12);
                        nextMonth = nextMonth % 12;
                    }
                    
                    const nextCandidate = new Date(nextYear, nextMonth, firstDay, firstHours, firstMinutes, 0, 0);
                    return {
                        startTime: nextCandidate,
                        location: null
                    };
                }
                
                const [startHour, startMinute] = task.startTime.split(':').map(Number);
                let nextTime = new Date(now);
                nextTime.setHours(startHour, startMinute, 0, 0);
                
                // 处理每周重复
                if (task.recurrence.type === "weekly") {
                    const todayWeekday = now.getDay();
                    let daysToAdd = 0;
                    let found = false;
                    
                    for (let i = 0; i < 7; i++) {
                        const checkDay = (todayWeekday + i) % 7;
                        if (task.recurrence.weekdays.includes(checkDay)) {
                            daysToAdd = i;
                            found = true;
                            break;
                        }
                    }
                    
                    if (!found && task.recurrence.weekdays.length > 0) {
                        daysToAdd = 7;
                    }
                    
                    nextTime.setDate(nextTime.getDate() + daysToAdd);
                    
                    const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                    const sameDay = nextTime.toDateString() === now.toDateString();
                    if (sameDay && nextTime <= now && now < nextTime.getTime() + durationMs) {
                        return {
                            startTime: new Date(nextTime),
                            location: null
                        };
                    }
                    
                    if (nextTime <= now) {
                        nextTime.setDate(nextTime.getDate() + 7);
                    }
                    
                    return {
                        startTime: nextTime,
                        location: null
                    };
                }
                
                // 修复：增强每月重复事件的计算
                if (task.recurrence.type === "monthly") {
                    // 按日期重复
                    if (task.recurrence.days && task.recurrence.days.length > 0) {
                        const today = new Date(now);
                        const currentMonth = today.getMonth();
                        const currentYear = today.getFullYear();
                        const currentDate = today.getDate();
                        
                        console.log(`计算空间站事件: 当前日期 ${currentYear}-${currentMonth+1}-${currentDate}`);
                        
                        // 首先检查今天是否是空间站日期
                        if (task.recurrence.days.includes(currentDate)) {
                            const todayEvent = new Date(currentYear, currentMonth, currentDate, startHour, startMinute);
                            const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                            
                            // 如果当前时间在事件持续时间内
                            if (todayEvent <= now && now < todayEvent.getTime() + durationMs) {
                                console.log(`空间站事件正在进行中: ${todayEvent}`);
                                return {
                                    startTime: todayEvent,
                                    location: null
                                };
                            }
                        }
                        
                        // 检查今天之后的日期
                        for (const day of task.recurrence.days) {
                            if (day > currentDate) {
                                const candidate = new Date(currentYear, currentMonth, day, startHour, startMinute);
                                if (candidate.getMonth() === currentMonth) {
                                    console.log(`找到本月空间站事件: ${candidate}`);
                                    return {
                                        startTime: candidate,
                                        location: null
                                    };
                                }
                            }
                        }
                        
                        // 如果本月没有符合条件的日期了，找下个月
                        const nextMonth = currentMonth + 1;
                        const nextYear = nextMonth > 11 ? currentYear + 1 : currentYear;
                        const adjustedMonth = nextMonth > 11 ? 0 : nextMonth;
                        
                        for (const day of task.recurrence.days) {
                            const candidate = new Date(nextYear, adjustedMonth, day, startHour, startMinute);
                            if (candidate.getMonth() === adjustedMonth) {
                                console.log(`找到下月空间站事件: ${candidate}`);
                                return {
                                    startTime: candidate,
                                    location: null
                                };
                            }
                        }
                    }
                }
                
                // 解析开始日期
                const [startYear, startMonth, startDay] = task.startDate.split('-').map(Number);
                const initialStart = new Date(startYear, startMonth - 1, startDay, startHour, startMinute);
                
                // 对于重复事件，计算最近的一次发生时间
                if (task.recurrence.type !== "none") {
                    let intervalMs;
                    switch(task.recurrence.type) {
                        case "daily":
                            intervalMs = 24 * 60 * 60 * 1000;
                            break;
                        case "custom":
                            intervalMs = convertToMilliseconds(task.recurrence.count, task.recurrence.unit);
                            break;
                        default:
                            intervalMs = 24 * 60 * 60 * 1000;
                    }
                    
                    const timeDiff = now - initialStart;
                    const intervals = Math.floor(timeDiff / intervalMs);
                    const lastOccurrence = new Date(initialStart.getTime() + intervals * intervalMs);
                    
                    const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                    
                    if (now <= lastOccurrence.getTime() + durationMs) {
                        return {
                            startTime: lastOccurrence,
                            location: null
                        };
                    }
                    
                    return {
                        startTime: new Date(lastOccurrence.getTime() + intervalMs),
                        location: null
                    };
                }
                
                if (initialStart > now) {
                    return {
                        startTime: new Date(initialStart),
                        location: null
                    };
                }
                
                return {
                    startTime: new Date(initialStart),
                    location: null
                };
            } catch (e) {
                console.error('计算下次发生时间出错:', task.name, e);
                return {
                    startTime: new Date(now.getTime() + 60 * 60 * 1000),
                    location: null
                };
            }
        }

        // 修复：增强任务状态计算，确保空间站事件正确显示
        function getTaskStatus(task, now) {
            try {
                const nextOccurrence = getNextOccurrence(task, now);
                const nextStart = nextOccurrence.startTime;
                const location = nextOccurrence.location;
                
                let durationMs, endTime;
                if (task.recurrence.type === "custom_complex" && task.recurrence.pattern === "dawn_redstone") {
                    const activeInfo = isDawnRedstoneActive(now);
                    if (activeInfo) {
                        endTime = activeInfo.endTime;
                        durationMs = endTime - activeInfo.startTime;
                    } else {
                        durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                        endTime = new Date(nextStart.getTime() + durationMs);
                    }
                } else {
                    durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                    endTime = new Date(nextStart.getTime() + durationMs);
                }
                
                // 计算显示时间范围
                const thresholdMs = convertToMilliseconds(task.displayThreshold, task.displayThresholdUnit);
                const displayStartTime = new Date(nextStart.getTime() - thresholdMs);
                const displayEndTime = new Date(endTime);
                
                // 判断状态
                const isInDisplayRange = now >= displayStartTime && now <= displayEndTime;
                const isOngoing = now >= nextStart && now < endTime;
                const timeUntilStart = nextStart - now;
                

                
                // 调试信息
                if (task.name === "空间站") {
                    console.log(`空间站事件状态计算:`);
                    console.log(`- 开始时间: ${nextStart}`);
                    console.log(`- 结束时间: ${endTime}`);
                    console.log(`- 显示开始: ${displayStartTime}`);
                    console.log(`- 显示结束: ${displayEndTime}`);
                    console.log(`- 当前时间: ${now}`);
                    console.log(`- 是否进行中: ${isOngoing}`);
                    console.log(`- 是否显示范围内: ${isInDisplayRange}`);
                }
                
                if (task.recurrence.type === "none" && now > displayEndTime) {
                    return {
                        status: "completed",
                        timeText: "已完成",
                        countdownMs: 0,
                        countdownText: "已完成",
                        minutes: Infinity,
                        startTime: null,
                        endTime: null,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime,
                        location: null
                    };
                }
                
                if (isOngoing) {
                    const timeLeft = endTime - now;
                    const converted = convertFromMilliseconds(timeLeft);
                    return {
                        status: "ongoing",
                        timeText: `正在进行`,
                        countdownMs: timeLeft,
                        countdownText: formatCountdown(timeLeft),
                        minutes: Math.ceil(timeLeft / (1000 * 60)),
                        startTime: nextStart,
                        endTime: endTime,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime,
                        location: location
                    };
                } else if (isInDisplayRange) {
                    const converted = convertFromMilliseconds(timeUntilStart);
                    return {
                        status: "upcoming",
                        timeText: `${converted.value}${converted.text}后开始`,
                        countdownMs: timeUntilStart,
                        countdownText: formatCountdown(timeUntilStart),
                        minutes: Math.ceil(timeUntilStart / (1000 * 60)),
                        startTime: nextStart,
                        endTime: endTime,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime,
                        location: location
                    };
                } else {
                    const converted = convertFromMilliseconds(timeUntilStart);
                    return {
                        status: "future",
                        timeText: `${converted.value}${converted.text}后开始`,
                        countdownMs: timeUntilStart,
                        countdownText: formatCountdown(timeUntilStart),
                        minutes: Math.ceil(timeUntilStart / (1000 * 60)),
                        startTime: nextStart,
                        endTime: endTime,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime,
                        location: location
                    };
                }
            } catch (e) {
                console.error('计算任务状态出错:', task.name, e);
                const defaultTime = new Date();
                return {
                    status: "future",
                    timeText: "时间计算中",
                    countdownMs: 0,
                    countdownText: "--",
                    minutes: Infinity,
                    startTime: defaultTime,
                    endTime: new Date(defaultTime.getTime() + 60 * 60 * 1000),
                    displayStartTime: defaultTime,
                    displayEndTime: new Date(defaultTime.getTime() + 60 * 60 * 1000),
                    location: null
                };
            }
        }

        // 过滤出需要显示的事件 - 排除优先级为"无"的事件
        function getVisibleTasks() {
            const now = new Date();
            return tasks
                .map(task => {
                    const status = getTaskStatus(task, now);
                    return {
                        ...task,
                        ...status
                    };
                })
                .filter(task => {
                    // 排除优先级为"无"的事件
                    if (task.priority === "none") {
                        return false;
                    }
                    
                    // 显示正在进行和即将开始的事件（在显示时间范围内），排除已完成的
                    return task.status !== "completed" && 
                           (task.status === "ongoing" || task.status === "upcoming");
                })
                .sort((a, b) => {
                    // 优先按优先级排序：高优先级在最上方，低优先级在最下方
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    
                    // 高优先级排在前面
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    
                    // 优先级相同的情况下，优先显示正在进行的事件
                    if (a.status === "ongoing" && b.status !== "ongoing") return -1;
                    if (a.status !== "ongoing" && b.status === "ongoing") return 1;
                    
                    // 最后按剩余时间排序
                    return a.minutes - b.minutes;
                });
        }

        // 获取所有事件（用于悬停显示）- 修复版本
        function getAllTasksWithStatus() {
            const now = new Date();
            return tasks
                .map(task => {
                    try {
                        const status = getTaskStatus(task, now);
                        return {
                            ...task,
                            ...status
                        };
                    } catch (e) {
                        console.error('计算任务状态出错:', task.name, e);
                        // 返回一个基本状态，避免预览功能失效
                        return {
                            ...task,
                            status: "future",
                            timeText: "时间计算中",
                            countdownMs: 0,
                            countdownText: "--",
                            minutes: Infinity,
                            startTime: new Date(),
                            endTime: new Date(),
                            displayStartTime: new Date(),
                            displayEndTime: new Date(),
                            location: null
                        };
                    }
                })
                .filter(task => task.status !== "completed")
                .sort((a, b) => {
                    // 按优先级排序：高优先级在最上方，低优先级在最下方，"无"优先级排在最后
                    const priorityOrder = { high: 4, medium: 3, low: 2, none: 1 };
                    
                    // 高优先级排在前面
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    
                    // 优先级相同的情况下按开始时间排序
                    return a.startTime - b.startTime;
                });
        }

        // 创建事件元素 - 统一正在进行和即将开始的UI，优化排版
        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            // 统一所有可见事件的基础样式，仅通过指示器区分状态
            const baseClass = "task-item p-4 rounded-xl mb-3 task-transition bg-dark-bg shadow-sm mx-auto max-w-md";
            
            taskEl.className = baseClass;
            taskEl.dataset.taskId = task.id;
            
            // 生成重复规则文本描述
            let recurrenceText = "";
            let simplifiedTimes;
            // 特殊处理每日特定时间重复
            if (task.recurrence.type === "daily_times" && task.recurrence.customTimes) {
                // 简化时间显示：将"08:00"格式转换为"8点"
                simplifiedTimes = task.recurrence.customTimes.map(time => {
                    const hour = parseInt(time.split(':')[0]);
                    return `${hour}点`;
                });
                recurrenceText = `每天 ${simplifiedTimes.join(', ')}`;
            } else if (task.recurrence.type === "custom_complex" && task.recurrence.pattern === "dawn_redstone") {
                recurrenceText = "红石规则";
            } else {
                switch(task.recurrence.type) {
                    case "none":
                        recurrenceText = "不重复";
                        break;
                    case "daily":
                        recurrenceText = "每天";
                        break;
                    case "weekly":
                        const dayNames = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
                        const selectedDays = task.recurrence.weekdays?.map(day => dayNames[day]).join(', ') || "";
                        recurrenceText = `每周${selectedDays}`;
                        break;
                    case "monthly":
                        if (task.recurrence.weekdays && task.recurrence.weekdays.length > 0) {
                            const monthDayNames = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
                            const selectedWeekDays = task.recurrence.weekdays?.map(day => monthDayNames[day]).join(', ') || "";
                            recurrenceText = `每月${selectedWeekDays}`;
                        } else if (task.recurrence.days && task.recurrence.days.length > 0) {
                            const selectedDays = task.recurrence.days?.join(', ') || "";
                            recurrenceText = `每月${selectedDays}日`;
                        }
                        break;
                    case "monthly_times":
                        const monthDays = task.recurrence.days?.join(', ') || "";
                        // 简化时间显示：将"08:00"格式转换为"8点"
                        simplifiedTimes = task.recurrence.customTimes?.map(time => {
                            const hour = parseInt(time.split(':')[0]);
                            return `${hour}点`;
                        }) || [];
                        recurrenceText = `每月${monthDays}日 ${simplifiedTimes.join(', ')}`;
                        break;
                    case "interval":
                    case "custom":
                        const unitNames = {
                            "minute": "分钟",
                            "hour": "小时",
                            "day": "天",
                            "week": "周",
                            "month": "月"
                        };
                        recurrenceText = `每${task.recurrence.count}${unitNames[task.recurrence.unit]}`;
                        break;
                    case "monthly_interval":
                        const selectedMonthDays = task.recurrence.days?.join(', ') || "";
                        recurrenceText = `每月${selectedMonthDays}日 每${task.recurrence.count}${unitNames[task.recurrence.unit]}`;
                        break;
                }
            }
            
            // 生成持续时间文本
            const durationUnitNames = {
                "minute": "分钟",
                "hour": "小时",
                "day": "天",
                "week": "周"
            };
            const durationText = `${task.recurrence.duration}${durationUnitNames[task.recurrence.durationUnit]}`;
            
            // 格式化日期显示
            const isToday = task.startTime.toLocaleDateString() === new Date().toLocaleDateString();
            const dateText = isToday ? '今天' : task.startTime.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric', weekday: 'short'});
            
            // 为正在进行的事件添加视觉指示器
            const ongoingIndicator = task.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            
            // 倒计时文本
            const countdownBadge = `<span class="countdown ml-2">${task.countdownText}</span>`;
            
            // 确定时间文本样式 - 正在进行的文本使用红色
            const timeTextClass = task.status === "ongoing" ? "ongoing-text" : "";
            
            // 添加地点信息 - 为破晓红石事件添加特殊类
            const isDawnRedstone = task.name === "破晓 红石";
            const locationClass = isDawnRedstone ? "text-xs font-medium mt-1 dawn-redstone-location" : "text-xs text-primary font-medium mt-1";
            const locationInfo = task.location ? `<div class="${locationClass}"><i class="fa fa-map-marker mr-1"></i>${task.location}</div>` : '';
            
            taskEl.innerHTML = `
                <div class="flex justify-between items-center task-title">
                    <div class="font-medium text-dark-text flex items-center">
                        <span class="w-2 h-2 rounded-full mr-2 bg-priority-${task.priority}"></span>
                        ${task.name}
                    </div>
                    <div class="text-sm text-primary flex items-center">
                        ${ongoingIndicator}<span class="${timeTextClass}">${task.timeText}</span>${countdownBadge}
                    </div>
                </div>
                <div class="text-xs text-dark-textSecondary task-meta flex flex-col sm:flex-row sm:justify-between gap-1">
                    <span class="task-meta-item"><i class="fa fa-repeat mr-1 opacity-70"></i>${recurrenceText}</span>
                    <span class="task-meta-item"><i class="fa fa-clock-o mr-1 opacity-70"></i>持续 ${durationText}</span>
                    <span class="task-meta-item"><i class="fa fa-calendar mr-1 opacity-70"></i>${dateText}</span>
                    <span class="task-meta-item"><i class="fa fa-hourglass-start mr-1 opacity-70"></i>${task.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})} - 
                    ${task.endTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
                </div>
                ${locationInfo}
            `;
            
            // 为事件项添加右键菜单事件
            taskEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                hideAllContextMenus();
                
                currentTaskId = task.id;
                const x = e.clientX;
                const y = e.clientY;
                
                taskContextMenu.style.left = `${x}px`;
                taskContextMenu.style.top = `${y}px`;
                taskContextMenu.classList.remove('hidden');
            });
            
            return taskEl;
        }

        // 创建缩略事件元素（用于悬停显示）- 修复版本
        function createMiniTaskElement(task) {
            const taskEl = document.createElement('div');
            // 统一缩略事件的样式
            const baseClass = "flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer future-task-item";
            
            taskEl.className = baseClass;
            taskEl.dataset.taskId = task.id;
            
            // 为正在进行的事件添加视觉指示器
            const ongoingIndicator = task.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            
            // 倒计时徽章
            const countdownBadge = task.countdownText ? `<span class="countdown ml-2">${task.countdownText}</span>` : '';
            
            // 确定时间文本样式 - 正在进行的文本使用红色
            const timeTextClass = task.status === "ongoing" ? "ongoing-text" : "";
            
            // 安全地处理时间显示
            let timeDisplay = '时间计算中';
            if (task.startTime && task.startTime instanceof Date && !isNaN(task.startTime)) {
                timeDisplay = task.status === 'ongoing' ? '进行中' : 
                             task.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            }
            
            // 添加地点信息 - 为破晓红石事件添加特殊类
            const isDawnRedstone = task.name === "破晓 红石";
            const locationClass = isDawnRedstone ? "text-xs truncate mt-0.5 dawn-redstone-location" : "text-xs text-primary truncate mt-0.5";
            const locationInfo = task.location ? `<div class="${locationClass}">${task.location}</div>` : '';
            
            taskEl.innerHTML = `
                <div class="flex items-center flex-1 min-w-0">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-${task.priority}"></span>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm truncate flex items-center">${task.name}</div>
                        <div class="text-xs text-primary flex items-center">
                            ${ongoingIndicator}<span class="${timeTextClass}">${task.timeText || '即将开始'}</span>${countdownBadge}
                        </div>
                        ${locationInfo}
                    </div>
                </div>
                <div class="text-xs text-dark-textSecondary whitespace-nowrap ml-2">
                    ${timeDisplay}
                </div>
            `;
            
            // 为未来事件列表中的任务添加点击预览交互
            addClickPreviewInteractionToFutureTask(taskEl, task);
            
            // 为缩略事件项添加右键菜单事件
            taskEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                hideAllContextMenus();
                
                currentTaskId = task.id;
                const x = e.clientX;
                const y = e.clientY;
                
                taskContextMenu.style.left = `${x}px`;
                taskContextMenu.style.top = `${y}px`;
                taskContextMenu.classList.remove('hidden');
            });
            
            return taskEl;
        }

        // 更新事件显示
        function updateTasks() {
            currentVisibleTasks = getVisibleTasks();
            currentAllTasks = getAllTasksWithStatus();
            const hasVisibleContent = currentVisibleTasks.length > 0 || currentAllTasks.length > 0;
            
            // 清空轮播容器
            taskCarousel.innerHTML = '';
            
            if (currentVisibleTasks.length === 0) {
                // 没有可见事件时显示提示
                taskCarousel.innerHTML = `
                    <div class="text-center py-4 text-dark-textSecondary">
                        目前没有即将开始的事件
                    </div>
                `;
            } else {
                // 添加所有可见事件到轮播
                currentVisibleTasks.forEach(task => {
                    const taskEl = createTaskElement(task);
                    taskCarousel.appendChild(taskEl);
                });
                
                // 重置轮播位置
                currentSlide = 0;
                updateCarouselPosition();
            }
            
            // 更新所有事件列表（悬停时显示）
            updateAllTasksList();
            
            // 调整容器大小和样式
            adjustContainerSize(hasVisibleContent);
        }

        // 更新所有事件列表 - 修复版本
        function updateAllTasksList() {
            const allTasks = getAllTasksWithStatus();
            allTasksListEl.innerHTML = '';
            
            if (allTasks.length === 0) {
                allTasksListEl.innerHTML = `
                    <div class="text-center py-4 text-dark-textSecondary text-sm">
                        暂无未来事件
                    </div>
                `;
                return;
            }
            
            allTasks.forEach(task => {
                const taskEl = createMiniTaskElement(task);
                allTasksListEl.appendChild(taskEl);
            });
        }

        // 调整容器大小和样式 - 减少底部空白
        function adjustContainerSize(hasContent) {
            if (hasContent) {
                appContainer.classList.remove('app-compact');
                appContainer.classList.add('app-expanded');
                controlsContainer.classList.remove('opacity-0', 'pointer-events-none', 'h-0');
                
                // 优化高度计算，减少额外空间
                const height = currentVisibleTasks.length > 0 ? 
                    120 + currentVisibleTasks.length * 100 : 120;
                
                appContainer.style.minHeight = `${height}px`;
            } else {
                appContainer.classList.remove('app-expanded');
                appContainer.classList.add('app-compact');
                controlsContainer.classList.add('opacity-0', 'pointer-events-none', 'h-0');
                appContainer.style.minHeight = '120px';
            }
        }

        // 更新轮播位置
        function updateCarouselPosition() {
            if (currentVisibleTasks.length <= 1) return;
            
            const slideHeight = 100;
            taskCarousel.style.transform = `translateY(-${currentSlide * slideHeight}px)`;
        }

        // 显示对应的重复选项面板
        function showRecurrenceOptions(type) {
            if (noneOptions) noneOptions.classList.add('hidden');
            if (dailyOptions) dailyOptions.classList.add('hidden');
            if (weeklyOptions) weeklyOptions.classList.add('hidden');
            if (monthlyOptions) monthlyOptions.classList.add('hidden');
            if (customOptions) customOptions.classList.add('hidden');
            if (dailyTimesOptions) dailyTimesOptions.classList.add('hidden');
            if (intervalOptions) intervalOptions.classList.add('hidden');
            if (monthlyIntervalOptions) monthlyIntervalOptions.classList.add('hidden');
            
            if (type === 'none' && noneOptions) {
                noneOptions.classList.remove('hidden');
            } else if (type === 'daily' && dailyOptions) {
                dailyOptions.classList.remove('hidden');
            } else if (type === 'weekly') {
                weeklyOptions.classList.remove('hidden');
            } else if (type === 'monthly') {
                monthlyOptions.classList.remove('hidden');
            } else if (type === 'custom') {
                customOptions.classList.remove('hidden');
            } else if (type === 'daily_times') {
                dailyTimesOptions.classList.remove('hidden');
            } else if (type === 'interval') {
                intervalOptions.classList.remove('hidden');
            } else if (type === 'monthly_interval') {
                monthlyIntervalOptions.classList.remove('hidden');
            }
        }

        // 验证表单数据
        function validateFormData(recurrenceType) {
            if (recurrenceType === 'weekly') {
                const checkedDays = Array.from(weekdayCheckboxes).filter(cb => cb.checked);
                if (checkedDays.length === 0) {
                    alert('请至少选择一个星期几');
                    return false;
                }
            } else if (recurrenceType === 'monthly') {
                const checkedDays = Array.from(monthdayCheckboxes).filter(cb => cb.checked);
                const checkedWeekDays = Array.from(monthweekdayCheckboxes).filter(cb => cb.checked);
                if (checkedDays.length === 0 && checkedWeekDays.length === 0) {
                    alert('请至少选择一个日期或星期几');
                    return false;
                }
            } else if (recurrenceType === 'custom') {
                const count = parseInt(intervalCountInput.value) || 0;
                if (count < 1) {
                    alert('间隔计数必须大于0');
                    return false;
                }
            } else if (recurrenceType === 'daily_times') {
                const times = getDailyTimes();
                if (times.length === 0) {
                    alert('请至少添加一个时间点');
                    return false;
                }
            }
            
            const threshold = parseInt(displayThresholdInput.value) || 0;
            if (threshold < 1) {
                alert('提前提醒时间必须大于0');
                return false;
            }
            
            const duration = parseInt(taskDurationInput.value) || 0;
            if (duration < 1) {
                alert('持续时间必须大于0');
                return false;
            }
            
            return true;
        }

        // 添加新事件
        async function addNewTask(taskData) {
            if (await validatePassword()) {
                const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                
                let newTask = {
                    id: newId,
                    name: taskData.name,
                    startDate: taskData.startDate || new Date().toISOString().split('T')[0],
                    startTime: taskData.startTime || new Date().toTimeString().split(':').slice(0, 2).join(':'),
                    displayThreshold: parseInt(taskData.displayThreshold) || 10,
                    displayThresholdUnit: taskData.displayThresholdUnit || "minute",
                    priority: taskData.priority,
                    recurrence: {
                        duration: parseInt(taskData.duration) || 10,
                        durationUnit: taskData.durationUnit || "minute",
                        type: taskData.recurrenceType
                    }
                };
                
                switch(taskData.recurrenceType) {
                    case "none":
                        // 不重复，不需要额外属性
                        break;
                    case "daily":
                        // 每天重复，不需要额外属性
                        break;
                    case "weekly":
                        newTask.recurrence.weekdays = taskData.weekdays ? 
                            taskData.weekdays.map(Number) : [1];
                        break;
                    case "monthly":
                        if (taskData.monthweekdays && taskData.monthweekdays.length > 0) {
                            newTask.recurrence.weekdays = taskData.monthweekdays.map(Number);
                        } else if (taskData.monthdays && taskData.monthdays.length > 0) {
                            newTask.recurrence.days = taskData.monthdays.map(Number);
                        }
                        break;
                    case "custom":
                        newTask.recurrence.count = parseInt(taskData.intervalCount) || 1;
                        newTask.recurrence.unit = taskData.intervalUnit || "day";
                        break;
                    case "interval":
                        newTask.recurrence.count = parseInt(taskData.intervalCount) || 1;
                        newTask.recurrence.unit = taskData.intervalUnit || "day";
                        break;
                    case "monthly_interval":
                        newTask.recurrence.count = parseInt(taskData.intervalCount) || 1;
                        newTask.recurrence.unit = taskData.intervalUnit || "day";
                        if (taskData.monthlyIntervalDays && taskData.monthlyIntervalDays.length > 0) {
                            newTask.recurrence.days = taskData.monthlyIntervalDays.map(Number);
                        }
                        break;
                    case "daily_times":
                        newTask.recurrence.customTimes = taskData.dailyTimes || [];
                        break;
                }
                
                tasks.push(newTask);
                const saveSuccess = await saveToLocalStorage(tasks);
                if (saveSuccess) {
                    updateTasks();
                } else {
                    tasks.pop();
                    alert('添加事件失败，请重试');
                }
            } else {
                showNotification('密码错误，无法添加任务', true);
            }
        }

        // 更新现有事件
        async function updateExistingTask(taskData) {
            if (await validatePassword()) {
                const taskIndex = tasks.findIndex(t => t.id === parseInt(taskData.id));
                if (taskIndex === -1) return;
                
                const originalTask = {...tasks[taskIndex]};
                
                // 更新任务的基本属性
                tasks[taskIndex].name = taskData.name;
                tasks[taskIndex].startDate = taskData.startDate;
                tasks[taskIndex].startTime = taskData.startTime;
                tasks[taskIndex].displayThreshold = parseInt(taskData.displayThreshold) || 10;
                tasks[taskIndex].displayThresholdUnit = taskData.displayThresholdUnit || "minute";
                tasks[taskIndex].priority = taskData.priority;
                
                // 更新重复规则，与admin.html保持一致
                tasks[taskIndex].recurrence.type = taskData.recurrenceType;
                tasks[taskIndex].recurrence.duration = parseInt(taskData.duration) || 10;
                tasks[taskIndex].recurrence.durationUnit = taskData.durationUnit || "minute";
                
                // 删除不需要的重复属性
                delete tasks[taskIndex].recurrence.weekdays;
                delete tasks[taskIndex].recurrence.days;
                delete tasks[taskIndex].recurrence.count;
                delete tasks[taskIndex].recurrence.unit;
                delete tasks[taskIndex].recurrence.customTimes;
                
                // 根据重复类型添加相应属性，与admin.html保持一致
                switch(taskData.recurrenceType) {
                    case "none":
                        // 不重复，不需要额外属性
                        break;
                    case "daily":
                        // 每天重复，不需要额外属性
                        break;
                    case "weekly":
                        tasks[taskIndex].recurrence.weekdays = taskData.weekdays ? 
                            taskData.weekdays.map(Number) : [1];
                        break;
                    case "monthly":
                        if (taskData.monthweekdays && taskData.monthweekdays.length > 0) {
                            tasks[taskIndex].recurrence.weekdays = taskData.monthweekdays.map(Number);
                        } else if (taskData.monthdays && taskData.monthdays.length > 0) {
                            tasks[taskIndex].recurrence.days = taskData.monthdays.map(Number);
                        }
                        break;
                    case "interval":
                        tasks[taskIndex].recurrence.count = parseInt(taskData.intervalCount) || 1;
                        tasks[taskIndex].recurrence.unit = taskData.intervalUnit || "day";
                        break;
                    case "monthly_interval":
                        tasks[taskIndex].recurrence.count = parseInt(taskData.intervalCount) || 1;
                        tasks[taskIndex].recurrence.unit = taskData.intervalUnit || "day";
                        if (taskData.monthlyIntervalDays && taskData.monthlyIntervalDays.length > 0) {
                            tasks[taskIndex].recurrence.days = taskData.monthlyIntervalDays.map(Number);
                        }
                        break;
                    case "daily_times":
                        tasks[taskIndex].recurrence.customTimes = taskData.dailyTimes || [];
                        break;
                }
                
                const saveSuccess = await saveToLocalStorage(tasks);
                if (saveSuccess) {
                    updateTasks();
                } else {
                    tasks[taskIndex] = originalTask;
                    alert('更新事件失败，请重试');
                }
            } else {
                showNotification('密码错误，无法编辑任务', true);
            }
        }

        // 删除事件
        async function deleteTask(taskId) {
            if (await validatePassword()) {
                const taskToDelete = tasks.find(t => t.id === taskId);
                if (!taskToDelete) return;
                
                tasks = tasks.filter(task => task.id !== taskId);
                
                const saveSuccess = await saveToLocalStorage(tasks);
                if (saveSuccess) {
                    updateTasks();
                } else {
                    tasks.push(taskToDelete);
                    alert('删除事件失败，请重试');
                }
            } else {
                showNotification('密码错误，无法删除任务', true);
            }
        }

        // 显示添加事件模态框
        function showAddTaskModal() {
            modalTitle.textContent = "添加新事件";
            taskForm.reset();
            taskIdInput.value = "";
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(':').slice(0, 2).join(':');
            
            // 根据当前选择的重复类型设置对应的开始日期和时间输入框
            const selectedRecurrenceType = document.querySelector('.recurrence-option.selected')?.getAttribute('data-type') || 'none';
            const currentStartDateInput = document.getElementById(`${selectedRecurrenceType}-start-date`);
            const currentStartTimeInput = document.getElementById(`${selectedRecurrenceType}-start-time`);
            
            if (currentStartDateInput) currentStartDateInput.value = dateStr;
            if (currentStartTimeInput) currentStartTimeInput.value = timeStr;
            if (displayThresholdInput) displayThresholdInput.value = 10;
            if (displayThresholdUnitInput) displayThresholdUnitInput.value = "minute";
            if (taskDurationInput) taskDurationInput.value = 10;
            if (durationUnitInput) durationUnitInput.value = "minute";
            
            recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.recurrence-option[data-type="none"]').classList.add('selected');
            if (recurrenceTypeInput) recurrenceTypeInput.value = "none";
            showRecurrenceOptions("none");
            
            dailyTimesContainer.innerHTML = "";
            addTimeInput();
            
            taskModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // 显示编辑事件模态框
        function showEditTaskModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            modalTitle.textContent = "编辑事件";
            if (taskIdInput) taskIdInput.value = task.id;
            
            const taskNameInput = document.getElementById('task-name');
            const taskPriorityInput = document.getElementById('task-priority');
            const taskDurationInput = document.getElementById('task-duration');
            const durationUnitInput = document.getElementById('duration-unit');
            const displayThresholdInput = document.getElementById('display-threshold');
            const displayThresholdUnitInput = document.getElementById('display-threshold-unit');
            
            if (taskNameInput) taskNameInput.value = task.name;
            if (taskPriorityInput) taskPriorityInput.value = task.priority;
            if (taskDurationInput) taskDurationInput.value = task.recurrence.duration;
            if (durationUnitInput) durationUnitInput.value = task.recurrence.durationUnit || "minute";
            if (displayThresholdInput) displayThresholdInput.value = task.displayThreshold;
            if (displayThresholdUnitInput) displayThresholdUnitInput.value = task.displayThresholdUnit || "minute";
            
            // 根据重复类型将开始日期时间填充到对应的输入框
            const recurrenceType = task.recurrence.type || "none";
            const startDate = task.startDate;
            const startTime = task.startTime;
            
            // 清除所有输入框的值
            const clearInput = (id) => {
                const input = document.getElementById(id);
                if (input) input.value = '';
            };
            
            clearInput('none-start-date');
            clearInput('none-start-time');
            clearInput('daily-start-date');
            clearInput('daily-start-time');
            clearInput('daily_times-start-date');
            clearInput('daily_times-start-time');
            clearInput('weekly-start-date');
            clearInput('weekly-start-time');
            clearInput('monthly-start-date');
            clearInput('monthly-start-time');
            clearInput('interval-start-date');
            clearInput('interval-start-time');
            clearInput('monthly_interval-start-date');
            clearInput('monthly_interval-start-time');
            
            // 根据重复类型填充对应的输入框
            const setInputValue = (id, value) => {
                const input = document.getElementById(id);
                if (input) input.value = value;
            };
            
            switch(recurrenceType) {
                case 'none':
                    setInputValue('none-start-date', startDate);
                    setInputValue('none-start-time', startTime);
                    break;
                case 'daily':
                    setInputValue('daily-start-date', startDate);
                    setInputValue('daily-start-time', startTime);
                    break;
                case 'daily_times':
                    setInputValue('daily_times-start-date', startDate);
                    setInputValue('daily_times-start-time', startTime);
                    break;
                case 'weekly':
                    setInputValue('weekly-start-date', startDate);
                    setInputValue('weekly-start-time', startTime);
                    break;
                case 'monthly':
                    setInputValue('monthly-start-date', startDate);
                    setInputValue('monthly-start-time', startTime);
                    break;
                case 'interval':
                    setInputValue('interval-start-date', startDate);
                    setInputValue('interval-start-time', startTime);
                    break;
                case 'monthly_interval':
                    setInputValue('monthly_interval-start-date', startDate);
                    setInputValue('monthly_interval-start-time', startTime);
                    break;
            }
            
            recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
            const selectedOption = document.querySelector(`.recurrence-option[data-type="${recurrenceType}"]`) || 
                                  document.querySelector('.recurrence-option[data-type="none"]');
            selectedOption.classList.add('selected');
            if (recurrenceTypeInput) recurrenceTypeInput.value = recurrenceType;
            
            // 重置所有复选框和输入框
            weekdayCheckboxes.forEach(checkbox => checkbox.checked = false);
            monthdayCheckboxes.forEach(checkbox => checkbox.checked = false);
            monthweekdayCheckboxes.forEach(checkbox => checkbox.checked = false);
            
            intervalCountInput.value = 1;
            intervalUnitInput.value = "day";
            
            dailyTimesContainer.innerHTML = "";
            
            // 根据不同重复类型填充详细设置，与admin.html保持一致
            switch(recurrenceType) {
                case "daily_times":
                    if (task.recurrence.customTimes) {
                        task.recurrence.customTimes.forEach(time => {
                            addTimeInput(time);
                        });
                    } else {
                        addTimeInput();
                    }
                    break;
                case "weekly":
                    if (task.recurrence.weekdays) {
                        task.recurrence.weekdays.forEach(day => {
                            const checkbox = document.querySelector(`input[name="weekday"][value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    break;
                case "monthly":
                    if (task.recurrence.weekdays) {
                        task.recurrence.weekdays.forEach(day => {
                            const checkbox = document.querySelector(`input[name="monthweekday"][value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    } else if (task.recurrence.days) {
                        task.recurrence.days.forEach(day => {
                            const checkbox = document.querySelector(`input[name="monthday"][value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    break;
                case "interval":
                    intervalCountInput.value = task.recurrence.count || 1;
                    intervalUnitInput.value = task.recurrence.unit || "day";
                    break;
                case "monthly_interval":
                    intervalCountInput.value = task.recurrence.count || 1;
                    intervalUnitInput.value = task.recurrence.unit || "day";
                    if (task.recurrence.days) {
                        task.recurrence.days.forEach(day => {
                            const checkbox = document.querySelector(`input[name="monthly_interval-day"][value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    break;
                case "custom":
                    intervalCountInput.value = task.recurrence.count || 1;
                    intervalUnitInput.value = task.recurrence.unit || "day";
                    break;
            }
            
            showRecurrenceOptions(recurrenceType);
            taskModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // 显示确认删除模态框
        function showConfirmDeleteModal(taskId) {
            currentTaskId = taskId;
            confirmDeleteModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // 隐藏所有右键菜单
        function hideAllContextMenus() {
            mainContextMenu.classList.add('hidden');
            taskContextMenu.classList.add('hidden');
        }

        // 隐藏事件模态框
        function hideTaskModal() {
            taskModal.classList.add('hidden');
        }

        // 隐藏确认删除模态框
        function hideConfirmDeleteModal() {
            confirmDeleteModal.classList.add('hidden');
        }

        // 点击展开/折叠未来事件列表
        function toggleFutureEvents() {
            // 切换展开/折叠状态
            if (allTasksEl.style.maxHeight === '500px') {
                allTasksEl.style.maxHeight = '0';
                // 显示词条文本提示器
                showNotification('列表已收起');
            } else {
                allTasksEl.style.maxHeight = '500px';
                // 显示词条文本提示器
                showNotification('列表已展开');
            }
        }

        // 添加点击事件监听，用于展开/折叠未来事件列表
        emptyHoverArea.addEventListener('click', toggleFutureEvents);

        // 应用容器右键菜单事件
        appContainer.addEventListener('contextmenu', (e) => {
            if (!e.target.closest('.task-item') && !e.target.closest('[data-task-id]')) {
                e.preventDefault();
                hideAllContextMenus();
                
                const x = e.clientX;
                const y = e.clientY;
                
                mainContextMenu.style.left = `${x}px`;
                mainContextMenu.style.top = `${y}px`;
                mainContextMenu.classList.remove('hidden');
            }
        });

        // 点击其他地方隐藏右键菜单
        document.addEventListener('click', hideAllContextMenus);

        // 添加事件选项点击事件
        addTaskOption.addEventListener('click', (e) => {
            e.stopPropagation();
            showAddTaskModal();
        });

        // 编辑事件选项点击事件
        editTaskOption.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentTaskId !== null) {
                showEditTaskModal(currentTaskId);
            }
        });

        // 删除事件选项点击事件
        deleteTaskOption.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentTaskId !== null) {
                showConfirmDeleteModal(currentTaskId);
            }
        });

        // 关闭模态框事件
        closeModal.addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });
        
        cancelTask.addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });
        
        taskModal.querySelector('.modal-backdrop').addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });

        // 关闭确认删除模态框事件
        closeDeleteModal.addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });
        
        cancelDelete.addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });
        
        confirmDeleteModal.querySelector('.modal-backdrop').addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });

        // 确认删除事件
        confirmDelete.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (currentTaskId !== null) {
                await deleteTask(currentTaskId);
                currentTaskId = null;
                hideConfirmDeleteModal();
            }
        });

        // 表单提交事件
        taskForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const recurrenceType = recurrenceTypeInput?.value || 'none';
            let startDate, startTime;
            
            // 根据当前选择的重复类型获取对应的开始日期时间
            switch(recurrenceType) {
                case 'none':
                    startDate = document.getElementById('none-start-date').value;
                    startTime = document.getElementById('none-start-time').value;
                    break;
                case 'daily':
                    startDate = document.getElementById('daily-start-date').value;
                    startTime = document.getElementById('daily-start-time').value;
                    break;
                case 'daily_times':
                    startDate = document.getElementById('daily_times-start-date').value;
                    startTime = document.getElementById('daily_times-start-time').value;
                    break;
                case 'weekly':
                    startDate = document.getElementById('weekly-start-date').value;
                    startTime = document.getElementById('weekly-start-time').value;
                    break;
                case 'monthly':
                    startDate = document.getElementById('monthly-start-date').value;
                    startTime = document.getElementById('monthly-start-time').value;
                    break;
                case 'interval':
                    startDate = document.getElementById('interval-start-date').value;
                    startTime = document.getElementById('interval-start-time').value;
                    break;
                case 'monthly_interval':
                    startDate = document.getElementById('monthly_interval-start-date').value;
                    startTime = document.getElementById('monthly_interval-start-time').value;
                    break;
                default:
                    startDate = '';
                    startTime = '';
            }
            
            // 收集monthly_interval类型的日期选择
            let monthlyIntervalDays = [];
            if (recurrenceTypeInput?.value === 'monthly_interval') {
                monthlyIntervalDays = Array.from(document.querySelectorAll('input[name="monthly_interval-day"]:checked'))
                    .map(cb => cb.value);
            }
            
            const formData = {
                id: document.getElementById('task-id').value,
                name: document.getElementById('task-name').value,
                startDate: startDate,
                startTime: startTime,
                displayThreshold: document.getElementById('display-threshold').value,
                displayThresholdUnit: document.getElementById('display-threshold-unit').value,
                priority: document.getElementById('task-priority').value,
                recurrenceType: recurrenceTypeInput?.value || 'none',
                duration: document.getElementById('task-duration').value,
                durationUnit: document.getElementById('duration-unit').value,
                intervalCount: document.getElementById('interval-count').value,
                intervalUnit: document.getElementById('interval-unit').value,
                weekdays: Array.from(weekdayCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value),
                monthdays: Array.from(monthdayCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value),
                monthlyIntervalDays: monthlyIntervalDays,
                monthweekdays: Array.from(monthweekdayCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value),
                dailyTimes: getDailyTimes()
            };
            
            if (!validateFormData(formData.recurrenceType)) {
                return;
            }
            
            if (formData.id) {
                await updateExistingTask(formData);
            } else {
                await addNewTask(formData);
            }
            
            hideTaskModal();
        });

        // 下载为HTML文件功能
        function downloadAsHtml() {
            try {
                const dataToSave = { tasks: tasks };
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = document.documentElement.outerHTML;
                
                const elementsWithStyles = tempDiv.querySelectorAll('[style]');
                elementsWithStyles.forEach(el => {
                    if (el.style.transform) {
                        const transform = el.style.transform;
                        el.removeAttribute('style');
                        el.style.transform = transform;
                    } else {
                        el.removeAttribute('style');
                    }
                });
                
                const appContainer = tempDiv.querySelector('#app-container');
                if (appContainer) {
                    appContainer.className = 'bg-dark-card rounded-2xl shadow-lg task-transition border border-gray-700 w-auto max-w-md app-compact';
                }
                
                const scripts = tempDiv.querySelectorAll('script');
                scripts.forEach(script => {
                    if (script.textContent.includes('let externalData = null;')) {
                        const newContent = script.textContent.replace(
                            'let externalData = null;',
                            `let externalData = ${JSON.stringify(dataToSave, null, 2)};`
                        );
                        script.textContent = newContent;
                    }
                });
                
                const body = tempDiv.querySelector('body');
                if (body) {
                    body.className = 'bg-dark-bg min-h-screen flex items-center justify-center p-4 font-inter text-dark-text m-0';
                }
                
                const updatedHtml = '<!DOCTYPE html>' + tempDiv.innerHTML;
                
                const blob = new Blob([updatedHtml], { 
                    type: 'text/html; charset=utf-8' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                a.download = `光·遇事件时间_${dateStr}.html`;
                
                a.href = url;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
                
                showNotification('数据已导出为HTML文件');
            } catch (e) {
                console.error('下载失败:', e);
                showNotification('导出HTML文件失败: ' + e.message, true);
            }
        }

        // ==================== 主题管理器 ====================
        class ThemeManager {
            constructor() {
                this.currentTheme = this.getStoredTheme() || 'light';
                this.init();
            }
            
            // 初始化主题
            init() {
                this.applyTheme(this.currentTheme);
            }

            // 获取系统主题偏好
            getSystemTheme() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark';
                }
                return 'light';
            }

            // 获取存储的主题
            getStoredTheme() {
                return localStorage.getItem('theme');
            }

            // 保存主题偏好
            saveTheme(theme) {
                localStorage.setItem('theme', theme);
            }

            // 应用主题
            applyTheme(theme) {
                this.currentTheme = theme;
                document.documentElement.setAttribute('data-theme', theme);
                
                this.saveTheme(theme);
                this.updateThemeIcon();
                this.updateTooltips();
            }

            // 更新词条提示器样式
            updateTooltips() {
                const tooltips = document.querySelectorAll('.download-tooltip, .save-tooltip');
                tooltips.forEach(tooltip => {
                    if (this.currentTheme === 'light') {
                        tooltip.style.backgroundColor = '#FF6B8B';
                        tooltip.style.color = 'var(--card-color)';
                    } else {
                        tooltip.style.backgroundColor = 'var(--card-color)';
                        tooltip.style.color = 'var(--text-color)';
                    }
                });
            }

            // 更新主题图标
            updateThemeIcon() {
                const icon = document.getElementById('theme-icon');
                if (icon) {
                    if (this.currentTheme === 'dark') {
                        icon.src = './icons/sun.png';
                        icon.title = '切换到浅色模式';
                    } else {
                        icon.src = './icons/moon.png';
                        icon.title = '切换到深色模式';
                    }
                }
            }

            // 切换主题
            toggleTheme() {
                const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                this.applyTheme(newTheme);
                showNotification(`已切换到${newTheme === 'dark' ? '深色' : '浅色'}模式`);
            }

            // 监听系统主题变化
            watchSystemTheme() {
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                        // 只有当用户没有手动设置过主题时才跟随系统
                        if (!this.getStoredTheme()) {
                            const newTheme = e.matches ? 'dark' : 'light';
                            this.applyTheme(newTheme);
                        }
                    });
                }
            }

            // 初始化主题
            init() {
                this.applyTheme(this.currentTheme);
                this.watchSystemTheme();
            }
        }

        // 在DOM加载完成后初始化主题管理器
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化主题管理器
            const themeManager = new ThemeManager();
            
            // 获取主题切换按钮
            const themeToggle = document.getElementById('theme-toggle');
            
            // 绑定主题切换事件
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    themeManager.toggleTheme();
                });
            }
        });

        // 魔法图标配置
        const magicIconsConfig = {
            0: [ // 星期日
                { name: '今日 体型重塑', png: 'txcs.png' },
                { name: '今日 彩虹魔法', png: 'chmf.png' }
            ],
            1: [ // 星期一
                { name: '今日 浪漫烟花', png: 'lmyh.png' }
            ],
            2: [ // 星期二
                { name: '今日 充能药剂', png: 'cnyj.png' }
            ],
            3: [ // 星期三
                { name: '今日 璀璨之星', png: 'cczx.png' }
            ],
            4: [ // 星期四
                { name: '今日 漂浮魔法', png: 'pfmf.png' }
            ],
            5: [ // 星期五
                { name: '今日魔法 小不点', png: 'xbd.png' },
                { name: '今日免费魔法 大只佬', png: 'dzl.png' }
            ],
            6: [ // 星期六
                { name: '今日 返老还童', png: 'flht.png' },
                { name: '今日 长大成人', png: 'zdcr.png' }
            ]
        };
        
        // 初始化魔法图标
        function initMagicIcons() {
            const container = document.getElementById('magic-icons-container');
            const today = new Date().getDay(); // 获取今天是星期几 (0-6)
            const magicIcons = magicIconsConfig[today] || [];
            
            // 清空容器
            container.innerHTML = '';
            
            // 添加魔法图标
                magicIcons.forEach(magic => {
                    const iconElement = document.createElement('div');
                    iconElement.className = 'magic-icon-item cursor-pointer relative';
                    iconElement.title = magic.name;
                    iconElement.innerHTML = `
                        <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background-color: transparent; border: none; border-radius: 8px; overflow: hidden;">
                            <img src="./icons/${magic.png}" alt="${magic.name}" 
                                 style="width: 32px; height: 32px; object-fit: contain; transition: transform 0.2s ease;" 
                                 class="magic-icon hover:scale-110" />
                        </div>
                    `;
                    
                    // 添加点击事件，显示魔法名称
                    iconElement.addEventListener('click', () => {
                        showNotification(magic.name);
                    });
                    
                    container.appendChild(iconElement);
                });
            
            // 添加季蜡图标 - 每天切换一个地图，顺序：云野, 雨林, 霞谷, 暮土, 禁阁
            const seasonWaxMaps = ['云野', '雨林', '霞谷', '暮土', '禁阁'];
            const currentDate = new Date();
            
            // 计算2025年11月27日应该显示霞谷（索引2）
            // 计算当天是一年中的第几天
            const dayOfYear = Math.floor((currentDate - new Date(currentDate.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // 添加偏移量确保2025年11月27日显示霞谷
            // 2025年11月27日是第331天，331 % 5 = 1（对应雨林），需要偏移+1到索引2（霞谷）
            const offset = 1;
            const mapIndex = (dayOfYear + offset) % seasonWaxMaps.length;
            const currentMap = seasonWaxMaps[mapIndex];
            
            // 检查jl.png是否存在，如不存在则使用默认图标
            const seasonWaxElement = document.createElement('div');
            seasonWaxElement.className = 'magic-icon-item cursor-pointer relative';
            seasonWaxElement.title = `今日季蜡位置: ${currentMap}`;
            seasonWaxElement.innerHTML = `
                <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background-color: transparent; border: none; border-radius: 8px; overflow: hidden; margin-top: 8px;">
                    <img src="./icons/jl.png" alt="季蜡" 
                         style="width: 32px; height: 32px; object-fit: contain; transition: transform 0.2s ease;" 
                         class="magic-icon hover:scale-110" 
                         onerror="this.src='./icons/gjf.png'; this.alt='季蜡';" />
                </div>
                <div style="text-align: center; font-size: 10px; color: var(--text-color); margin-top: 2px; font-weight: 500; width: 100%;">
                    ${currentMap}
                </div>
            `;
            
            // 添加点击事件，显示季蜡位置
            seasonWaxElement.addEventListener('click', () => {
                showNotification(`今日季蜡位置: ${currentMap}`);
            });
            
            container.appendChild(seasonWaxElement);
            
            // 添加大蜡图标 - 每天切换不同地图组合
            const largeWaxMaps = [
                { locations: ['霞谷'], name: '霞谷', fullName: '霞谷' },      // 周一
                { locations: ['暮土'], name: '暮土', fullName: '暮土' },      // 周二
                { locations: ['禁阁'], name: '禁阁', fullName: '禁阁' },      // 周三
                { locations: ['云野'], name: '云野', fullName: '云野' },      // 周四
                { locations: ['云野', '雨林', '霞谷'], name: '云 雨 霞', fullName: '云野 雨林 霞谷' },  // 周五
                { locations: ['云野', '雨林', '暮土'], name: '云 雨 暮', fullName: '云野 雨林 暮土' },  // 周六
                { locations: ['雨林', '暮土', '禁阁'], name: '雨 暮 禁', fullName: '雨林 暮土 禁阁' }   // 周日
            ];
            
            // 自动检测图片数量的函数
            function detectImages(dayIndex) {
                return new Promise((resolve) => {
                    const folderName = `l${dayIndex + 1}`;
                    const maxImages = 5; // 最多检测5张图片
                    const foundImages = [];
                    let checked = 0;
                    
                    // 检测数字命名的图片（如1.png, 2.png）
                    for (let i = 1; i <= maxImages; i++) {
                        const imageName = `${i}.png`;
                        const img = new Image();
                        img.onload = () => {
                            foundImages.push(imageName);
                            checked++;
                            if (checked === maxImages) resolve(foundImages);
                        };
                        img.onerror = () => {
                            checked++;
                            if (checked === maxImages) resolve(foundImages);
                        };
                        img.src = `./images/${folderName}/${imageName}?t=${Date.now()}`; // 加时间戳防止缓存
                    }
                });
            }
            
            const dayOfWeek = currentDate.getDay(); // 0-6，0是周日
            const adjustedDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // 调整为周一=0，周日=6
            const currentLargeWax = largeWaxMaps[adjustedDayOfWeek];
            
            // 检测当前日期的图片数量
            detectImages(adjustedDayOfWeek).then(images => {
                currentLargeWax.images = images;
                
                // 创建大蜡图标元素
                const largeWaxElement = document.createElement('div');
                largeWaxElement.className = 'magic-icon-item cursor-pointer relative';
                largeWaxElement.title = `今日大蜡位置: ${currentLargeWax.name}`;
                largeWaxElement.innerHTML = `
                    <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background-color: transparent; border: none; border-radius: 8px; overflow: hidden; margin-top: 8px;">
                        <img src="./icons/dl.png" alt="大蜡" 
                             style="width: 32px; height: 32px; object-fit: contain; transition: transform 0.2s ease;" 
                             class="magic-icon hover:scale-110" 
                             onerror="this.src='./icons/gjf.png'; this.alt='大蜡';" />
                    </div>
                    <div style="text-align: center; font-size: 10px; color: var(--text-color); margin-top: 2px; font-weight: 500; width: 100%;">
                        ${currentLargeWax.name}
                    </div>
                `;
                
                // 添加点击事件，显示大蜡位置和图片
                largeWaxElement.addEventListener('click', () => {
                    showNotification(`今日大蜡位置: ${currentLargeWax.fullName}`);
                    // 显示图片卡片，传入文件夹名称
                    const folderName = `l${adjustedDayOfWeek + 1}`;
                    showLargeWaxImages(currentLargeWax.images, currentLargeWax.fullName, folderName);
                });
                
                container.appendChild(largeWaxElement);
            });
        }
        
        // 初始化并定时更新
        updateCurrentTime();
        updateTasks();
        initMagicIcons();
        
        // 数据加载完成，显示应用
        setTimeout(() => {
            const loadingIndicator = document.getElementById('loading-indicator');
            const appContainer = document.getElementById('app-container');
            
            if (loadingIndicator) {
                loadingIndicator.style.opacity = '0';
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 500);
            }
            
            if (appContainer) {
                appContainer.style.opacity = '1';
                appContainer.style.transform = 'translateY(0)';
            }
        }, 200);
        
        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);
        
        // 每秒更新一次事件状态
        setInterval(updateTasks, 1000);
        
        // 每分钟更新一次魔法图标（防止跨天未刷新）
        setInterval(initMagicIcons, 60000);
    </script>
</body>
</html>