<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试多个日期显示修复</title>
    <style>
        /* 简化的样式，用于测试 */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        /* 复制admin.html中的相关HTML结构样式 */
        #monthly-time-points, #monthly-time-range {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #monthly-time-points.hidden, #monthly-time-range.hidden {
            display: none;
        }
        input[name="monthday"] {
            margin: 0 5px 0 10px;
        }
    </style>
</head>
<body>
    <h1>测试多个日期显示修复</h1>
    
    <!-- 复制admin.html中的相关HTML结构 -->
    <div id="monthly-time-points">
        <h3>每月时间点模式</h3>
        <label>选择日期:</label>
        <input type="checkbox" name="monthday" value="1"><span>1</span>
        <input type="checkbox" name="monthday" value="2"><span>2</span>
        <input type="checkbox" name="monthday" value="3"><span>3</span>
        <input type="checkbox" name="monthday" value="4"><span>4</span>
        <input type="checkbox" name="monthday" value="5"><span>5</span>
        <input type="checkbox" name="monthday" value="6"><span>6</span>
        <input type="checkbox" name="monthday" value="7"><span>7</span>
        <input type="checkbox" name="monthday" value="8"><span>8</span>
    </div>
    
    <div id="monthly-time-range" class="hidden">
        <h3>每月时间段模式</h3>
        <label>选择日期:</label>
        <input type="checkbox" name="monthday" value="1"><span>1</span>
        <input type="checkbox" name="monthday" value="2"><span>2</span>
        <input type="checkbox" name="monthday" value="3"><span>3</span>
        <input type="checkbox" name="monthday" value="4"><span>4</span>
        <input type="checkbox" name="monthday" value="5"><span>5</span>
        <input type="checkbox" name="monthday" value="6"><span>6</span>
        <input type="checkbox" name="monthday" value="7"><span>7</span>
        <input type="checkbox" name="monthday" value="8"><span>8</span>
    </div>
    
    <div class="test-result" id="result"></div>
    
    <script>
        // 模拟用户提供的云数据，包含多个日期
        const testTask = {
            "recurrence": {
                "days": [1, 2, 3, 4, 5],
                "type": "monthly",
                "duration": 10,
                "rangeEnd": "23:59",
                "rangeStart": "00:10",
                "durationUnit": "minute",
                "intervalUnit": "hour",
                "intervalCount": 1,
                "monthlyRepeatType": "time-range"
            }
        };
        
        // 获取DOM元素
        const monthlyTimePointsDiv = document.getElementById('monthly-time-points');
        const monthlyTimeRangeDiv = document.getElementById('monthly-time-range');
        const monthlyRepeatType = testTask.recurrence.monthlyRepeatType;
        
        // 模拟修复前的代码（逻辑错误的代码）
        function simulateBuggyCode() {
            // 清除所有复选框
            document.querySelectorAll('input[name="monthday"]').forEach(cb => cb.checked = false);
            
            // 首先切换显示
            if (monthlyRepeatType === 'time-points') {
                monthlyTimePointsDiv.classList.remove('hidden');
                monthlyTimeRangeDiv.classList.add('hidden');
            } else {
                monthlyTimePointsDiv.classList.add('hidden');
                monthlyTimeRangeDiv.classList.remove('hidden');
            }
            
            // 然后设置日期，但有逻辑错误
            if (testTask.recurrence.days) {
                const visibleDiv = monthlyRepeatType === 'time-points' ? monthlyTimePointsDiv : monthlyTimeRangeDiv;
                
                testTask.recurrence.days.forEach(day => {
                    // 错误：每次迭代都取消所有复选框
                    const allCheckboxes = document.querySelectorAll('input[name="monthday"]');
                    allCheckboxes.forEach(cb => cb.checked = false);
                    
                    const checkbox = visibleDiv.querySelector(`input[name="monthday"][value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            return {
                expectedDays: testTask.recurrence.days,
                actualDays: getCheckedDays(monthlyTimeRangeDiv),
                success: false
            };
        }
        
        // 模拟修复后的代码（正确的代码）
        function simulateFixedCode() {
            // 清除所有复选框
            document.querySelectorAll('input[name="monthday"]').forEach(cb => cb.checked = false);
            
            // 首先切换显示
            if (monthlyRepeatType === 'time-points') {
                monthlyTimePointsDiv.classList.remove('hidden');
                monthlyTimeRangeDiv.classList.add('hidden');
            } else {
                monthlyTimePointsDiv.classList.add('hidden');
                monthlyTimeRangeDiv.classList.remove('hidden');
            }
            
            // 然后设置日期，修复了逻辑错误
            if (testTask.recurrence.days) {
                // 正确：只在开始时取消一次所有复选框
                const allCheckboxes = document.querySelectorAll('input[name="monthday"]');
                allCheckboxes.forEach(cb => cb.checked = false);
                
                const visibleDiv = monthlyRepeatType === 'time-points' ? monthlyTimePointsDiv : monthlyTimeRangeDiv;
                
                testTask.recurrence.days.forEach(day => {
                    const checkbox = visibleDiv.querySelector(`input[name="monthday"][value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            const actualDays = getCheckedDays(monthlyTimeRangeDiv);
            const success = arraysEqual(actualDays, testTask.recurrence.days);
            
            return {
                expectedDays: testTask.recurrence.days,
                actualDays: actualDays,
                success: success
            };
        }
        
        // 获取指定div中被选中的日期
        function getCheckedDays(div) {
            const checkboxes = div.querySelectorAll('input[name="monthday"]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => a - b);
        }
        
        // 比较两个数组是否相等
        function arraysEqual(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            return true;
        }
        
        // 运行测试
        function runTest() {
            const resultDiv = document.getElementById('result');
            let html = '<h3>测试结果</h3>';
            
            // 测试有逻辑错误的代码
            const buggyResult = simulateBuggyCode();
            html += '<h4>1. 有逻辑错误的代码:</h4>';
            html += `<p>期望显示的日期: [${buggyResult.expectedDays.join(', ')}]</p>`;
            html += `<p>实际显示的日期: [${buggyResult.actualDays.join(', ')}]</p>`;
            html += `<p class="error">问题: 每次迭代都取消所有复选框，导致只有最后一个日期被选中</p>`;
            
            // 重置复选框
            document.querySelectorAll('input[name="monthday"]').forEach(cb => cb.checked = false);
            
            // 测试修复后的代码
            const fixedResult = simulateFixedCode();
            html += '<h4>2. 修复后的代码:</h4>';
            html += `<p>期望显示的日期: [${fixedResult.expectedDays.join(', ')}]</p>`;
            html += `<p>实际显示的日期: [${fixedResult.actualDays.join(', ')}]</p>`;
            
            if (fixedResult.success) {
                html += `<p class="success">修复成功: 所有日期都被正确显示</p>`;
            } else {
                html += `<p class="error">修复失败: 日期显示不正确</p>`;
            }
            
            resultDiv.innerHTML = html;
        }
        
        // 页面加载时运行测试
        window.onload = runTest;
    </script>
</body>
</html>