<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-case {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>重复模式时间显示测试</h1>
    
    <div class="test-case">
        <h2>测试用例：每天00:01开始，每2小时，持续1小时</h2>
        <p>当前时间：06:00</p>
        <p>预期显示：06:01-07:01</p>
        <div class="result" id="test1-result">计算中...</div>
    </div>
    
    <script>
        // 模拟任务数据
        const testTask = {
            id: "test1",
            name: "测试任务",
            recurrence: {
                type: "daily",
                rangeStart: "00:01",
                rangeEnd: "23:59",
                intervalCount: 2,
                intervalUnit: "hour",
                duration: 1,
                durationUnit: "hour"
            },
            startTime: "00:01",
            startDate: new Date().toISOString().split('T')[0]
        };
        
        // 模拟当前时间为06:00
        const mockNow = new Date();
        mockNow.setHours(6, 0, 0, 0);
        
        // 时间转换函数
        function convertToMilliseconds(value, unit) {
            const units = {
                minute: 60 * 1000,
                hour: 60 * 60 * 1000,
                day: 24 * 60 * 60 * 1000,
                week: 7 * 24 * 60 * 60 * 1000,
                month: 30 * 24 * 60 * 60 * 1000
            };
            return value * (units[unit] || units.minute);
        }
        
        // 简化版getNextOccurrence函数
        function getNextOccurrence(task, now) {
            // 处理时间段间隔模式
            if (task.recurrence.rangeStart && task.recurrence.rangeEnd) {
                const [startHour, startMinute] = task.recurrence.rangeStart.split(':').map(Number);
                const [endHour, endMinute] = task.recurrence.rangeEnd.split(':').map(Number);
                const intervalCount = parseInt(task.recurrence.intervalCount) || 1;
                const intervalUnit = task.recurrence.intervalUnit || 'hour';
                
                // 计算间隔毫秒数
                const intervalMs = convertToMilliseconds(intervalCount, intervalUnit);
                
                // 创建开始和结束时间的Date对象
                const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHour, startMinute, 0, 0);
                const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), endHour, endMinute, 0, 0);
                
                // 生成时间段内所有的时间点
                let currentTime = new Date(startDate);
                let candidates = [];
                
                while (currentTime <= endDate) {
                    candidates.push(currentTime);
                    currentTime = new Date(currentTime.getTime() + intervalMs);
                }
                
                // 寻找当前时间之后的第一个时间点
                for (const candidate of candidates) {
                    if (candidate > now) {
                        return {
                            startTime: candidate,
                            location: ""
                        };
                    }
                }
                
                // 如果今天没有找到，返回明天的第一个时间点
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(startHour, startMinute, 0, 0);
                return {
                    startTime: tomorrow,
                    location: ""
                };
            }
            
            // 默认情况
            return {
                startTime: new Date(now),
                location: ""
            };
        }
        
        // 执行测试
        function runTest() {
            const nextOccurrence = getNextOccurrence(testTask, mockNow);
            const durationMs = convertToMilliseconds(testTask.recurrence.duration, testTask.recurrence.durationUnit);
            const endTime = new Date(nextOccurrence.startTime.getTime() + durationMs);
            
            const timeText = `${nextOccurrence.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})} - ${endTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}`;
            
            document.getElementById('test1-result').innerHTML = `
                <p><strong>计算结果：</strong>${timeText}</p>
                <p><strong>是否符合预期：</strong>${timeText === "06:01 - 07:01" ? "是" : "否"}</p>
            `;
        }
        
        // 页面加载完成后执行测试
        window.onload = runTest;
    </script>
</body>
</html>