<!DOCTYPE html>
    <script>window._sandbox_context = {"locale":"zh","sourceCodeType":"html"}</script><script>window.channelId="";window._img_loading = "//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/image/img_loading.b156c4b8.gif";</script>
  <title>Sandbox Document</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><script>
    ;(function (w, d, u, b, n, pc, ga, ae, po, s, p, e, t, pp) {pc = 'precollect';ga
    = 'getAttribute';ae = 'addEventListener';po = 'PerformanceObserver';s = function
    (m) {p = [].slice.call(arguments);p.push(Date.now(), location.href);(m == pc ?
    s.p.a : s.q).push(p)};s.q = [];s.p = { a: [] };w[n] = s;e =
    document.createElement('script');e.src = u + '?bid=' + b + '&globalName=' +
    n;e.crossOrigin = u.indexOf('sdk-web') > 0 ? 'anonymous' :
    'use-credentials';d.getElementsByTagName('head')[0].appendChild(e);if (ae in w)
    {s.pcErr = function (e) {e = e || w.event;t = e.target || e.srcElement;if (t
    instanceof Element || t instanceof HTMLElement) {if (t[ga]('integrity'))
    {w[n](pc, 'sri', t[ga]('href') || t[ga]('src'))} else {w[n](pc, 'st', { tagName:
    t.tagName, url: t[ga]('href') || t[ga]('src') })}} else {w[n](pc, 'err', e.error)}};s.pcRej = function (e) {e = e || w.event;w[n](pc, 'reject',
    e.reason || (e.detail && e.detail.reason))};w[ae]('error', s.pcErr,
    true);w[ae]('unhandledrejection', s.pcRej,
    true);};if('PerformanceLongTaskTiming' in w) {pp = s.pp = { entries: []
    };pp.observer = new PerformanceObserver(function (l) {pp.entries =
    pp.entries.concat(l.getEntries())});pp.observer.observe({ entryTypes:
    ['longtask']
    })}})(window,document,'https://lf3-short.ibytedapm.com/slardar/fe/sdk-web/browser.cn.js','flow_web','_slardar')

    window._slardar('context.merge', window._sandbox_context)
    window._slardar('init', {
        bid: 'flow_web',
        env: 'cn-release-production-samantha',
        release: '1.0.0.225',
        pid: 'html_preview_sandbox',
        plugins: {
          blankScreen: {
            screenshot: true,
            quality: 0.5,
          },
        }
      })

    // 注册report回调插件
    window._slardar('on', 'report', (event) => { return window.__sendErrorEvent__(event) });
    window._slardar('start')
  </script><script src="https://lf3-short.ibytedapm.com/slardar/fe/sdk-web/browser.cn.js?bid=flow_web&amp;globalName=_slardar" crossorigin="anonymous"></script><script>
  (function () {
    function initPerformanceObserver() {
  function dispatchActionToParent(action) {
    window.parent.postMessage(
      {
        action,
        channelId: window.channelId
      },
      '*'
    );
  }

  const observer = new PerformanceObserver((list) => {
    const entries = list.getEntries();
    for (const entry of entries) {
      if (entry.name === 'first-paint') {
        dispatchActionToParent('Renderer::Performance::FirstPaint');
      }
      if (entry.name === 'first-contentful-paint') {
        dispatchActionToParent('Renderer::Performance::FirstContentfulPaint');
      }
    }
  });

  observer.observe({ type: 'paint', buffered: true });
}
    initPerformanceObserver()
  })()
  </script><script>
  (function () {
    function replaceImages() {
  function dispatchActionToParent(action, payload) {
    window.parent.postMessage(
      {
        action,
        payload,
        channelId: window.channelId
      },
      '*'
    );
  }

  function replaceImage(img) {
    if (!img || img.dataset.key || img.dataset.src || img.src === window._img_loading) {
      return;
    }

    const originalUrl = img.src;
    img.src = window._img_loading;
    img.dataset.src = originalUrl;
    img.dataset.reviewStatus = '-1';

    dispatchActionToParent('Renderer::Image::Censor', {
      originalUrl,
      attributes: { alt: img.attributes.getNamedItem('alt')?.value }
    });
  }

  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.target === document.head) {
        return;
      }

      // 新增节点
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach((node) => {
          if (node instanceof HTMLImageElement) {
            replaceImage(node);
          } else if (node instanceof HTMLElement) {
            // 递归处理子元素里的 img
            node.querySelectorAll?.('img').forEach((img) => {
              replaceImage(img);
            });
          }
        });
      }
      // 属性变化
      if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
        const target = mutation.target;
        if (target instanceof HTMLImageElement) {
          replaceImage(target);
        }
      }
    });
  });

  const observe = () => {
    observer.observe(document.documentElement, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['src']
    });
  };

  observe();

  window.addEventListener('DOMContentLoaded', () => {
    // 由 apps/preview/src/pages/renderer/image-replacer.ts 处理
    observer.disconnect();
  });
}
    replaceImages()
  })()
  </script><script defer="" src="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/lib-polyfill.09284630.js" crossorigin="anonymous"></script><script defer="" src="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/lib-react.d2e0d445.js" crossorigin="anonymous"></script><script defer="" src="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/246.ef0bd76a.js" crossorigin="anonymous"></script><script defer="" src="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/165.4d012433.js" crossorigin="anonymous"></script><script defer="" src="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/renderer.64596f0b.js" crossorigin="anonymous"></script><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/130.bdce60e2.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/132.fe6379f6.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/137.a79569ec.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/176.97193455.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/22.b3cea4be.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/319.1be1ba06.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/320.1447129b.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/362.efe1c7a7.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/415.08e4ee8b.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/448.b5dfe782.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/482.ac0f620f.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/551.7b76f771.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/60.bf749252.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/621.9a383247.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/622.55f062ef.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/642.17c68b8d.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/779.26fde9ca.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/789.40d8c2e2.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/799.319f3ee7.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/js/async/842.5021728e.js" rel="prefetch"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/css/165.dd2b60e3.css" rel="stylesheet" crossorigin="anonymous"><link href="//lf-flow-web-cdn.doubao.com/obj/flow-doubao/html_preview/1.0.0.225/static/css/renderer.d61766de.css" rel="stylesheet" crossorigin="anonymous"><style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.z-10{z-index:10}.z-50{z-index:50}.m-0{margin:0px}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mr-2{margin-right:0.5rem}.mt-1{margin-top:0.25rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.ml-2{margin-left:0.5rem}.mr-1{margin-right:0.25rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-2{height:0.5rem}.max-h-0{max-height:0px}.min-h-\[80px\]{min-height:80px}.min-h-screen{min-height:100vh}.w-48{width:12rem}.w-auto{width:auto}.w-full{width:100%}.w-2{width:0.5rem}.max-w-md{max-width:28rem}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-1{gap:0.25rem}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-3 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.75rem * var(--tw-space-x-reverse));margin-left:calc(0.75rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-2\.5 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.625rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.625rem * var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.rounded{border-radius:0.25rem}.rounded-2xl{border-radius:1rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-gray-600{--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1))}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-dark-bg{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.bg-dark-card{--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1))}.bg-primary{--tw-bg-opacity:1;background-color:rgb(96 165 250 / var(--tw-bg-opacity, 1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-priority-high{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-priority-low{--tw-bg-opacity:1;background-color:rgb(16 185 129 / var(--tw-bg-opacity, 1))}.bg-priority-medium{--tw-bg-opacity:1;background-color:rgb(245 158 11 / var(--tw-bg-opacity, 1))}.bg-opacity-60{--tw-bg-opacity:0.6}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.text-center{text-align:center}.font-inter{font-family:Inter, system-ui, sans-serif}.text-2xl{font-size:1.5rem;line-height:2rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-dark-text{--tw-text-opacity:1;color:rgb(248 250 252 / var(--tw-text-opacity, 1))}.text-dark-textSecondary{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.text-primary{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity, 1))}.opacity-70{opacity:0.7}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.duration-500{transition-duration:500ms}.ease-in-out{transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1)}.task-transition {
                transition: all 0.5s ease-in-out;
            }.hover-expand {
                transition: max-height 0.5s ease-in-out;
            }.context-menu {
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }.modal-backdrop {
                -webkit-backdrop-filter: blur(2px);
                        backdrop-filter: blur(2px);
            }.app-expanded {
                padding: 2rem;
                width: auto !important;
                max-width: 500px;
            }.task-item {
                cursor: pointer;
            }.day-checkbox {
                width: 1.5rem;
                height: 1.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }.recurrence-option{cursor:pointer;border-radius:0.5rem;border-width:1px;--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1));padding:0.75rem;transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.recurrence-option:hover{--tw-border-opacity:1;border-color:rgb(96 165 250 / var(--tw-border-opacity, 1))}.recurrence-option.selected{--tw-border-opacity:1;border-color:rgb(96 165 250 / var(--tw-border-opacity, 1));background-color:rgb(96 165 250 / 0.1)}.ongoing-indicator {
                animation: pulse 2s infinite;
            }@keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }.time-input-group{display:flex;align-items:center;gap:0.75rem}.time-input{width:5rem;border-radius:0.5rem;border-width:1px;--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1));--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1));padding-left:0.75rem;padding-right:0.75rem;padding-top:0.5rem;padding-bottom:0.5rem;--tw-text-opacity:1;color:rgb(248 250 252 / var(--tw-text-opacity, 1))}.time-input:focus{border-color:transparent;outline:2px solid transparent;outline-offset:2px;--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);--tw-ring-opacity:1;--tw-ring-color:rgb(96 165 250 / var(--tw-ring-opacity, 1))}.time-select{flex:1 1 0%;border-radius:0.5rem;border-width:1px;--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity, 1));--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1));padding-left:0.75rem;padding-right:0.75rem;padding-top:0.5rem;padding-bottom:0.5rem;--tw-text-opacity:1;color:rgb(248 250 252 / var(--tw-text-opacity, 1))}.time-select:focus{border-color:transparent;outline:2px solid transparent;outline-offset:2px;--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);--tw-ring-opacity:1;--tw-ring-color:rgb(96 165 250 / var(--tw-ring-opacity, 1))}.countdown{border-radius:0.25rem;background-color:rgb(96 165 250 / 0.1);padding-left:0.5rem;padding-right:0.5rem;padding-top:0.125rem;padding-bottom:0.125rem;font-size:0.75rem;line-height:1rem;font-weight:500;--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.download-btn{position:fixed;bottom:1.5rem;right:1.5rem;z-index:40;display:flex;align-items:center;justify-content:center;border-radius:9999px;--tw-bg-opacity:1;background-color:rgb(96 165 250 / var(--tw-bg-opacity, 1));padding:0.75rem;--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1));--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:300ms}.download-btn:hover{background-color:rgb(96 165 250 / 0.9)}.download-tooltip{visibility:hidden;position:absolute;right:100%;margin-right:0.75rem;white-space:nowrap;border-radius:0.5rem;--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1));padding-left:0.75rem;padding-right:0.75rem;padding-top:0.25rem;padding-bottom:0.25rem;font-size:0.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgb(248 250 252 / var(--tw-text-opacity, 1));opacity:0;transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:300ms}.download-container:hover .download-tooltip{visibility:visible;opacity:1}.notification{position:fixed;top:1rem;right:1rem;z-index:50;--tw-translate-x:100%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));border-radius:0.5rem;--tw-bg-opacity:1;background-color:rgb(96 165 250 / var(--tw-bg-opacity, 1));padding-left:1rem;padding-right:1rem;padding-top:0.5rem;padding-bottom:0.5rem;--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1));--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:300ms}.notification.show{--tw-translate-x:0px;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.notification.error{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.save-btn{position:fixed;bottom:1.5rem;left:1.5rem;z-index:40;display:flex;align-items:center;justify-content:center;border-radius:9999px;--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity, 1));padding:0.75rem;--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1));--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:300ms}.save-btn:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61 / var(--tw-bg-opacity, 1))}.save-tooltip{visibility:hidden;position:absolute;left:100%;margin-left:0.75rem;white-space:nowrap;border-radius:0.5rem;--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1));padding-left:0.75rem;padding-right:0.75rem;padding-top:0.25rem;padding-bottom:0.25rem;font-size:0.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgb(248 250 252 / var(--tw-text-opacity, 1));opacity:0;transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:300ms}.save-container:hover .save-tooltip{visibility:visible;opacity:1}/* 保存状态指示器 */.save-status{position:fixed;bottom:1.5rem;left:5rem;z-index:40;border-radius:0.5rem;--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1));padding-left:0.75rem;padding-right:0.75rem;padding-top:0.25rem;padding-bottom:0.25rem;font-size:0.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgb(248 250 252 / var(--tw-text-opacity, 1))}/* 新增：优化文字间距和排版 */.task-title{letter-spacing:0.025em}.task-meta{margin-top:0.375rem;letter-spacing:-0.025em}.task-meta-item{margin-right:0.75rem}.task-meta-item:last-child{margin-right:0px}
        .hover\:bg-dark-hover:hover{--tw-bg-opacity:1;background-color:rgb(71 85 105 / var(--tw-bg-opacity, 1))}
        .hover\:bg-primary\/90:hover{background-color:rgb(96 165 250 / 0.9)}
        .hover\:bg-red-600:hover{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}
        .hover\:text-dark-text:hover{--tw-text-opacity:1;color:rgb(248 250 252 / var(--tw-text-opacity, 1))}
        .focus\:border-transparent:focus{border-color:transparent}
        .focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}
        .focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}
        .focus\:ring-primary:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(96 165 250 / var(--tw-ring-opacity, 1))}
        .peer:checked ~ .peer-checked\:text-primary{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}
        @media (min-width: 640px){.sm\:flex-row{flex-direction:row}.sm\:justify-between{justify-content:space-between}}
    </style><script src="https://lf3-short.ibytedapm.com/slardar/fe/sdk-web/plugins/common-monitors.1.16.3.js" crossorigin="anonymous"></script><script src="https://lf3-short.ibytedapm.com/slardar/fe/sdk-web/plugins/blank-screen.1.16.3.js" crossorigin="anonymous"></script>
  
    <div id="root"></div>
    
    <meta charset="UTF-8" data-doubao-line="3" data-doubao-column="5">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" data-doubao-line="4" data-doubao-column="5">
    <title data-doubao-line="5" data-doubao-column="5">时间项目提醒</title>
    <script src="https://cdn.tailwindcss.com" data-doubao-line="6" data-doubao-column="5"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" data-doubao-line="7" data-doubao-column="5">
    
    <!-- 配置Tailwind自定义颜色和字体 - 暗黑模式 -->
    <script data-doubao-line="10" data-doubao-column="5">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        priority: {
                            high: '#ef4444',    // 红色表示高优先级
                            medium: '#f59e0b',  // 黄色表示中优先级
                            low: '#10b981'      // 绿色表示低优先级
                        },
                        primary: '#60a5fa',   // 稍浅的蓝色，适合暗黑模式
                        secondary: '#94a3b8', // 稍浅的灰色，适合暗黑模式
                        dark: {
                            bg: '#1e293b',      // 主背景色
                            card: '#334155',    // 卡片背景色
                            hover: '#475569',   // 悬停状态颜色
                            text: '#f8fafc',    // 主要文本色
                            textSecondary: '#cbd5e1' // 次要文本色
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss" data-doubao-line="38" data-doubao-column="5">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .task-transition {
                transition: all 0.5s ease-in-out;
            }
            .hover-expand {
                transition: max-height 0.5s ease-in-out;
            }
            .context-menu {
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .modal-backdrop {
                backdrop-filter: blur(2px);
            }
            .app-compact {
                padding: 1.5rem;
                min-height: auto !important;
                width: auto !important;
                max-width: 280px;
            }
            .app-expanded {
                padding: 2rem;
                width: auto !important;
                max-width: 500px;
            }
            .task-item {
                cursor: pointer;
            }
            .day-checkbox {
                width: 1.5rem;
                height: 1.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .recurrence-option {
                @apply p-3 border border-gray-600 rounded-lg cursor-pointer transition-all hover:border-primary;
            }
            .recurrence-option.selected {
                @apply border-primary bg-primary/10;
            }
            .ongoing-indicator {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }
            .time-input-group {
                @apply flex items-center gap-3;
            }
            .time-input {
                @apply w-20 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .time-select {
                @apply flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .countdown {
                @apply text-xs font-medium px-2 py-0.5 rounded bg-primary/10 text-primary;
            }
            .download-btn {
                @apply fixed bottom-6 right-6 bg-primary hover:bg-primary/90 text-white p-3 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-40;
            }
            .download-tooltip {
                @apply absolute right-full mr-3 bg-dark-card text-dark-text px-3 py-1 rounded-lg text-sm opacity-0 invisible transition-all duration-300 whitespace-nowrap;
            }
            .download-container:hover .download-tooltip {
                @apply opacity-100 visible;
            }
            .notification {
                @apply fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full;
            }
            .notification.show {
                @apply translate-x-0;
            }
            .notification.error {
                @apply bg-red-500;
            }
            .save-btn {
                @apply fixed bottom-6 left-6 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-40;
            }
            .save-tooltip {
                @apply absolute left-full ml-3 bg-dark-card text-dark-text px-3 py-1 rounded-lg text-sm opacity-0 invisible transition-all duration-300 whitespace-nowrap;
            }
            .save-container:hover .save-tooltip {
                @apply opacity-100 visible;
            }
            /* 保存状态指示器 */
            .save-status {
                @apply fixed bottom-6 left-20 bg-dark-card text-dark-text px-3 py-1 rounded-lg text-sm z-40;
            }
            /* 新增：优化文字间距和排版 */
            .task-title {
                @apply tracking-wide;
            }
            .task-meta {
                @apply tracking-tight mt-1.5;
            }
            .task-meta-item {
                @apply mr-3 last:mr-0;
            }
        }
    </style>
<style>:root {
    
    }
  img[data-key]:not([data-review-status='0']) { object-fit: cover !important; }
  </style>

    <div id="app-container" class="bg-dark-card rounded-2xl shadow-lg task-transition border border-gray-700 w-auto max-w-md app-compact" data-doubao-line="149" data-doubao-column="5" data-doubao-key="0">
        <!-- 当前时间显示（始终显示） -->
        <div id="current-time" class="text-center text-2xl font-semibold text-dark-text mb-6" data-doubao-line="151" data-doubao-column="9" data-doubao-key="1">20:06:46</div>
        
        <!-- 项目轮播容器 -->
        <div id="tasks-container" class="relative min-h-[80px] overflow-hidden" data-doubao-line="154" data-doubao-column="9" data-doubao-key="2">
            <div id="task-carousel" class="transition-transform duration-500 ease-in-out" data-doubao-line="155" data-doubao-column="13" data-doubao-key="3"><div class="task-item p-4 rounded-xl mb-3 task-transition bg-dark-bg shadow-sm mx-auto max-w-md" data-task-id="25">
                <div class="flex justify-between items-center task-title">
                    <div class="font-medium text-dark-text flex items-center">
                        <span class="w-2 h-2 rounded-full mr-2 bg-priority-low"></span>
                        空间站
                    </div>
                    <div class="text-sm text-primary flex items-center">
                        <span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>正在进行，19小时后结束<span class="countdown ml-2">18时53分</span>
                    </div>
                </div>
                <div class="text-xs text-dark-textSecondary task-meta flex flex-col sm:flex-row sm:justify-between gap-1">
                    <span class="task-meta-item"><i class="fa fa-repeat mr-1 opacity-70"></i>每周周四</span>
                    <span class="task-meta-item"><i class="fa fa-clock-o mr-1 opacity-70"></i>持续 1天</span>
                    <span class="task-meta-item"><i class="fa fa-calendar mr-1 opacity-70"></i>今天</span>
                    <span class="task-meta-item"><i class="fa fa-hourglass-start mr-1 opacity-70"></i>15:00 - 
                    15:00</span>
                </div>
            </div></div>
        </div>
        
        <!-- 全部项目（鼠标悬停时显示） -->
        <div id="all-tasks" class="mt-6 max-h-0 overflow-hidden hover-expand" data-doubao-line="161" data-doubao-column="9" data-doubao-key="4">
            <div class="text-sm text-dark-textSecondary mb-3 font-medium text-center" data-doubao-line="162" data-doubao-column="13" data-doubao-key="5">未来事件:</div>
            <div id="all-tasks-list" class="space-y-2.5 text-sm" data-doubao-line="163" data-doubao-column="13" data-doubao-key="6"><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="25">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-low"></span>
                    <span><span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>空间站<span class="countdown ml-2">18时53分</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    进行中
                </div>
            </div><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="17">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-medium"></span>
                    <span>间歇泉<span class="countdown ml-2">58分13秒</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    21:05
                </div>
            </div><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="22">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-medium"></span>
                    <span>奶奶饭<span class="countdown ml-2">1时28分</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    21:35
                </div>
            </div><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="21">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-medium"></span>
                    <span>海龟<span class="countdown ml-2">1时43分</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    21:50
                </div>
            </div><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="23">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-medium"></span>
                    <span>AURORA<span class="countdown ml-2">3时3分</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    23:10
                </div>
            </div><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="24">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-high"></span>
                    <span>任务 重置<span class="countdown ml-2">18时53分</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    15:00
                </div>
            </div><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="18">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-low"></span>
                    <span>献祭 重置<span class="countdown ml-2">2天19时</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    15:39
                </div>
            </div><div class="flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover" data-task-id="10">
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-low"></span>
                    <span>复刻先祖<span class="countdown ml-2">13天15时</span></span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    11:36
                </div>
            </div></div>
        </div>
        
        <!-- 轮播控制按钮已删除 -->
        <div id="controls-container" class="flex justify-center mt-4 space-x-2 transition-all duration-300 hidden" data-doubao-line="167" data-doubao-column="9" data-doubao-key="7">
        </div>
    </div>

    <!-- 右键菜单 - 通用菜单 -->
    <div id="main-context-menu" class="context-menu hidden absolute bg-dark-card rounded-lg shadow-lg p-2 w-48 border border-gray-700" data-doubao-line="172" data-doubao-column="5" data-doubao-key="8">
        <div id="add-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer" data-doubao-line="173" data-doubao-column="9" data-doubao-key="9">
            <i class="fa fa-plus mr-2 text-primary" data-doubao-line="174" data-doubao-column="13" data-doubao-key="10"></i>添加新事件
        </div>
    </div>

    <!-- 任务右键菜单 -->
    <div id="task-context-menu" class="context-menu hidden absolute bg-dark-card rounded-lg shadow-lg p-2 w-48 border border-gray-700" data-doubao-line="179" data-doubao-column="5" data-doubao-key="11">
        <div id="edit-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer" data-doubao-line="180" data-doubao-column="9" data-doubao-key="12">
            <i class="fa fa-pencil mr-2 text-primary" data-doubao-line="181" data-doubao-column="13" data-doubao-key="13"></i>编辑事件
        </div>
        <div id="delete-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer" data-doubao-line="183" data-doubao-column="9" data-doubao-key="14">
            <i class="fa fa-trash mr-2 text-red-500" data-doubao-line="184" data-doubao-column="13" data-doubao-key="15"></i>删除事件
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="confirm-delete-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden" data-doubao-line="189" data-doubao-column="5" data-doubao-key="16">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60" data-doubao-line="190" data-doubao-column="9" data-doubao-key="17"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700" data-doubao-line="191" data-doubao-column="9" data-doubao-key="18">
            <div class="flex justify-between items-center mb-4" data-doubao-line="192" data-doubao-column="13" data-doubao-key="19">
                <h3 class="text-lg font-semibold text-dark-text" data-doubao-line="193" data-doubao-column="17" data-doubao-key="20">确认删除</h3>
                <button id="close-delete-modal" class="text-dark-textSecondary hover:text-dark-text" data-doubao-line="194" data-doubao-column="17" data-doubao-key="21">
                    <i class="fa fa-times" data-doubao-line="195" data-doubao-column="21" data-doubao-key="22"></i>
                </button>
            </div>
            
            <p class="text-dark-textSecondary mb-6" data-doubao-line="199" data-doubao-column="13" data-doubao-key="23">您确定要删除这个事件吗？此操作无法撤销。</p>
            
            <div class="flex justify-end space-x-3" data-doubao-line="201" data-doubao-column="13" data-doubao-key="24">
                <button id="cancel-delete" class="px-4 py-2 border border-gray-600 rounded-lg text-dark-text hover:bg-dark-hover transition-colors" data-doubao-line="202" data-doubao-column="17" data-doubao-key="25">取消</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" data-doubao-line="203" data-doubao-column="17" data-doubao-key="26">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑任务模态框 -->
    <div id="task-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden" data-doubao-line="211" data-doubao-column="5" data-doubao-key="27">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60" data-doubao-line="212" data-doubao-column="9" data-doubao-key="28"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700" data-doubao-line="213" data-doubao-column="9" data-doubao-key="29">
            <div class="flex justify-between items-center mb-4" data-doubao-line="214" data-doubao-column="13" data-doubao-key="30">
                <h3 id="modal-title" class="text-lg font-semibold text-dark-text" data-doubao-line="215" data-doubao-column="17" data-doubao-key="31">添加新事件</h3>
                <button id="close-modal" class="text-dark-textSecondary hover:text-dark-text" data-doubao-line="216" data-doubao-column="17" data-doubao-key="32">
                    <i class="fa fa-times" data-doubao-line="217" data-doubao-column="21" data-doubao-key="33"></i>
                </button>
            </div>
            
            <form id="task-form" data-doubao-line="221" data-doubao-column="13" data-doubao-key="34">
                <input type="hidden" id="task-id" data-doubao-line="222" data-doubao-column="17" data-doubao-key="35">
                
                <div class="mb-4" data-doubao-line="224" data-doubao-column="17" data-doubao-key="36">
                    <label for="task-name" class="block text-sm font-medium text-dark-textSecondary mb-1" data-doubao-line="225" data-doubao-column="21" data-doubao-key="37">事件名称</label>
                    <input type="text" id="task-name" name="task-name" required="" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" data-doubao-line="226" data-doubao-column="21" data-doubao-key="38">
                </div>
                
                <div class="mb-4" data-doubao-line="229" data-doubao-column="17" data-doubao-key="39">
                    <label for="task-priority" class="block text-sm font-medium text-dark-textSecondary mb-1" data-doubao-line="230" data-doubao-column="21" data-doubao-key="40">优先级</label>
                    <select id="task-priority" name="task-priority" required="" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" data-doubao-line="231" data-doubao-column="21" data-doubao-key="41">
                        <option value="high" data-doubao-line="232" data-doubao-column="25" data-doubao-key="42">高 (红色)</option>
                        <option value="medium" selected="" data-doubao-line="233" data-doubao-column="25" data-doubao-key="43">中 (黄色)</option>
                        <option value="low" data-doubao-line="234" data-doubao-column="25" data-doubao-key="44">低 (绿色)</option>
                    </select>
                </div>
                
                <div class="mb-4" data-doubao-line="238" data-doubao-column="17" data-doubao-key="45">
                    <label for="display-threshold" class="block text-sm font-medium text-dark-textSecondary mb-1" data-doubao-line="239" data-doubao-column="21" data-doubao-key="46">提前提醒时间</label>
                    <div class="time-input-group" data-doubao-line="240" data-doubao-column="21" data-doubao-key="47">
                        <input type="number" id="display-threshold" name="display-threshold" min="1" value="10" class="time-input" data-doubao-line="241" data-doubao-column="25" data-doubao-key="48">
                        <select id="display-threshold-unit" name="display-threshold-unit" class="time-select" data-doubao-line="242" data-doubao-column="25" data-doubao-key="49">
                            <option value="minute" data-doubao-line="243" data-doubao-column="29" data-doubao-key="50">分钟</option>
                            <option value="hour" data-doubao-line="244" data-doubao-column="29" data-doubao-key="51">小时</option>
                            <option value="day" data-doubao-line="245" data-doubao-column="29" data-doubao-key="52">天</option>
                            <option value="week" data-doubao-line="246" data-doubao-column="29" data-doubao-key="53">周</option>
                        </select>
                    </div>
                    <p class="text-xs text-primary mt-1" data-doubao-line="249" data-doubao-column="21" data-doubao-key="54">事件开始前多久显示提醒</p>
                </div>
                
                <div class="mb-4" data-doubao-line="252" data-doubao-column="17" data-doubao-key="55">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2" data-doubao-line="253" data-doubao-column="21" data-doubao-key="56">开始时间</label>
                    <div class="grid grid-cols-2 gap-3" data-doubao-line="254" data-doubao-column="21" data-doubao-key="57">
                        <div data-doubao-line="255" data-doubao-column="25" data-doubao-key="58">
                            <input type="date" id="start-date" name="start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" data-doubao-line="256" data-doubao-column="29" data-doubao-key="59">
                            <label for="start-date" class="text-xs text-dark-textSecondary" data-doubao-line="257" data-doubao-column="29" data-doubao-key="60">日期</label>
                        </div>
                        <div data-doubao-line="259" data-doubao-column="25" data-doubao-key="61">
                            <input type="time" id="start-time" name="start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" data-doubao-line="260" data-doubao-column="29" data-doubao-key="62">
                            <label for="start-time" class="text-xs text-dark-textSecondary" data-doubao-line="261" data-doubao-column="29" data-doubao-key="63">时间</label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4" data-doubao-line="266" data-doubao-column="17" data-doubao-key="64">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2" data-doubao-line="267" data-doubao-column="21" data-doubao-key="65">重复方式</label>
                    <div class="grid grid-cols-2 gap-2 mb-3" data-doubao-line="268" data-doubao-column="21" data-doubao-key="66">
                        <div class="recurrence-option selected" data-type="none" data-doubao-line="269" data-doubao-column="25" data-doubao-key="67">
                            <div class="font-medium" data-doubao-line="270" data-doubao-column="29" data-doubao-key="68">不重复</div>
                            <div class="text-xs text-dark-textSecondary" data-doubao-line="271" data-doubao-column="29" data-doubao-key="69">仅一次</div>
                        </div>
                        <div class="recurrence-option" data-type="daily" data-doubao-line="273" data-doubao-column="25" data-doubao-key="70">
                            <div class="font-medium" data-doubao-line="274" data-doubao-column="29" data-doubao-key="71">每天</div>
                            <div class="text-xs text-dark-textSecondary" data-doubao-line="275" data-doubao-column="29" data-doubao-key="72">每天同一时间</div>
                        </div>
                        <div class="recurrence-option" data-type="weekly" data-doubao-line="277" data-doubao-column="25" data-doubao-key="73">
                            <div class="font-medium" data-doubao-line="278" data-doubao-column="29" data-doubao-key="74">每周</div>
                            <div class="text-xs text-dark-textSecondary" data-doubao-line="279" data-doubao-column="29" data-doubao-key="75">每周特定日期</div>
                        </div>
                        <div class="recurrence-option" data-type="custom" data-doubao-line="281" data-doubao-column="25" data-doubao-key="76">
                            <div class="font-medium" data-doubao-line="282" data-doubao-column="29" data-doubao-key="77">自定义</div>
                            <div class="text-xs text-dark-textSecondary" data-doubao-line="283" data-doubao-column="29" data-doubao-key="78">按间隔重复</div>
                        </div>
                    </div>
                    <input type="hidden" id="recurrence-type" value="none" data-doubao-line="286" data-doubao-column="21" data-doubao-key="79">
                </div>
                
                <!-- 每周重复选项 -->
                <div id="weekly-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600" data-doubao-line="290" data-doubao-column="17" data-doubao-key="80">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2" data-doubao-line="291" data-doubao-column="21" data-doubao-key="81">每周重复日期</label>
                    <div class="flex flex-wrap gap-2 mb-1" data-doubao-line="292" data-doubao-column="21" data-doubao-key="82">
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer" data-doubao-line="293" data-doubao-column="25" data-doubao-key="83">
                            <input type="checkbox" name="weekday" value="1" class="hidden peer" data-doubao-line="294" data-doubao-column="29" data-doubao-key="84">
                            <span class="text-xs peer-checked:text-primary" data-doubao-line="295" data-doubao-column="29" data-doubao-key="85">一</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer" data-doubao-line="297" data-doubao-column="25" data-doubao-key="86">
                            <input type="checkbox" name="weekday" value="2" class="hidden peer" data-doubao-line="298" data-doubao-column="29" data-doubao-key="87">
                            <span class="text-xs peer-checked:text-primary" data-doubao-line="299" data-doubao-column="29" data-doubao-key="88">二</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer" data-doubao-line="301" data-doubao-column="25" data-doubao-key="89">
                            <input type="checkbox" name="weekday" value="3" class="hidden peer" data-doubao-line="302" data-doubao-column="29" data-doubao-key="90">
                            <span class="text-xs peer-checked:text-primary" data-doubao-line="303" data-doubao-column="29" data-doubao-key="91">三</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer" data-doubao-line="305" data-doubao-column="25" data-doubao-key="92">
                            <input type="checkbox" name="weekday" value="4" class="hidden peer" data-doubao-line="306" data-doubao-column="29" data-doubao-key="93">
                            <span class="text-xs peer-checked:text-primary" data-doubao-line="307" data-doubao-column="29" data-doubao-key="94">四</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer" data-doubao-line="309" data-doubao-column="25" data-doubao-key="95">
                            <input type="checkbox" name="weekday" value="5" class="hidden peer" data-doubao-line="310" data-doubao-column="29" data-doubao-key="96">
                            <span class="text-xs peer-checked:text-primary" data-doubao-line="311" data-doubao-column="29" data-doubao-key="97">五</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer" data-doubao-line="313" data-doubao-column="25" data-doubao-key="98">
                            <input type="checkbox" name="weekday" value="6" class="hidden peer" data-doubao-line="314" data-doubao-column="29" data-doubao-key="99">
                            <span class="text-xs peer-checked:text-primary" data-doubao-line="315" data-doubao-column="29" data-doubao-key="100">六</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer" data-doubao-line="317" data-doubao-column="25" data-doubao-key="101">
                            <input type="checkbox" name="weekday" value="0" class="hidden peer" data-doubao-line="318" data-doubao-column="29" data-doubao-key="102">
                            <span class="text-xs peer-checked:text-primary" data-doubao-line="319" data-doubao-column="29" data-doubao-key="103">日</span>
                        </label>
                    </div>
                </div>
                
                <!-- 自定义重复选项 -->
                <div id="custom-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600" data-doubao-line="325" data-doubao-column="17" data-doubao-key="104">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2" data-doubao-line="326" data-doubao-column="21" data-doubao-key="105">重复间隔</label>
                    <div class="time-input-group" data-doubao-line="327" data-doubao-column="21" data-doubao-key="106">
                        <input type="number" id="interval-count" name="interval-count" min="1" value="1" class="time-input" data-doubao-line="328" data-doubao-column="25" data-doubao-key="107">
                        <select id="interval-unit" name="interval-unit" class="time-select" data-doubao-line="329" data-doubao-column="25" data-doubao-key="108">
                            <option value="minute" data-doubao-line="330" data-doubao-column="29" data-doubao-key="109">分钟</option>
                            <option value="hour" data-doubao-line="331" data-doubao-column="29" data-doubao-key="110">小时</option>
                            <option value="day" data-doubao-line="332" data-doubao-column="29" data-doubao-key="111">天</option>
                            <option value="week" data-doubao-line="333" data-doubao-column="29" data-doubao-key="112">周</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4" data-doubao-line="338" data-doubao-column="17" data-doubao-key="113">
                    <label for="task-duration" class="block text-sm font-medium text-dark-textSecondary mb-1" data-doubao-line="339" data-doubao-column="21" data-doubao-key="114">持续时间</label>
                    <div class="time-input-group" data-doubao-line="340" data-doubao-column="21" data-doubao-key="115">
                        <input type="number" id="task-duration" name="task-duration" min="1" value="10" class="time-input" data-doubao-line="341" data-doubao-column="25" data-doubao-key="116">
                        <select id="duration-unit" name="duration-unit" class="time-select" data-doubao-line="342" data-doubao-column="25" data-doubao-key="117">
                            <option value="minute" data-doubao-line="343" data-doubao-column="29" data-doubao-key="118">分钟</option>
                            <option value="hour" data-doubao-line="344" data-doubao-column="29" data-doubao-key="119">小时</option>
                            <option value="day" data-doubao-line="345" data-doubao-column="29" data-doubao-key="120">天</option>
                            <option value="week" data-doubao-line="346" data-doubao-column="29" data-doubao-key="121">周</option>
                        </select>
                    </div>
                    <p class="text-xs text-primary mt-1" data-doubao-line="349" data-doubao-column="21" data-doubao-key="122">事件进行的时长，将作为进行中事件的倒计时基准</p>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6" data-doubao-line="352" data-doubao-column="17" data-doubao-key="123">
                    <button type="button" id="cancel-task" class="px-4 py-2 border border-gray-600 rounded-lg text-dark-text hover:bg-dark-hover transition-colors" data-doubao-line="353" data-doubao-column="21" data-doubao-key="124">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors" data-doubao-line="354" data-doubao-column="21" data-doubao-key="125">
                        保存事件
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 下载按钮 -->
    <div class="download-container relative" data-doubao-line="363" data-doubao-column="5" data-doubao-key="126">
        <button id="download-btn" class="download-btn" data-doubao-line="364" data-doubao-column="9" data-doubao-key="127">
            <i class="fa fa-download" data-doubao-line="365" data-doubao-column="13" data-doubao-key="128"></i>
        </button>
        <span class="download-tooltip" data-doubao-line="367" data-doubao-column="9" data-doubao-key="129">保存当前事件到HTML文件</span>
    </div>

    <!-- 手动保存按钮 -->
    <div class="save-container relative" data-doubao-line="371" data-doubao-column="5" data-doubao-key="130">
        <button id="manual-save-btn" class="save-btn" data-doubao-line="372" data-doubao-column="9" data-doubao-key="131">
            <i class="fa fa-save" data-doubao-line="373" data-doubao-column="13" data-doubao-key="132"></i>
        </button>
        <span class="save-tooltip" data-doubao-line="375" data-doubao-column="9" data-doubao-key="133">手动保存当前数据</span>
    </div>

    <!-- 保存状态指示器 -->
    <div id="save-status" class="save-status text-green-500" data-doubao-line="379" data-doubao-column="5" data-doubao-key="134">
        <span id="save-status-text" data-doubao-line="380" data-doubao-column="9" data-doubao-key="135">保存成功</span>
    </div>

    <!-- 通知提示 -->
    <div id="notification" class="notification" data-doubao-line="384" data-doubao-column="5" data-doubao-key="136">数据已成功保存</div>

    <script data-doubao-line="386" data-doubao-column="5" data-doubao-key="137">
        // 用于存储外部数据的变量 - 从localStorage加载或使用默认值
        let externalData = {
  "tasks": [
    {
      "id": 10,
      "name": "复刻先祖",
      "startDate": "2025-10-16",
      "startTime": "11:36",
      "displayThreshold": 1,
      "displayThresholdUnit": "day",
      "priority": "low",
      "recurrence": {
        "duration": 10,
        "durationUnit": "minute",
        "type": "custom",
        "count": 2,
        "unit": "week"
      }
    },
    {
      "id": 11,
      "name": "1",
      "startDate": "2025-10-16",
      "startTime": "11:39",
      "displayThreshold": 10,
      "displayThresholdUnit": "minute",
      "priority": "medium",
      "recurrence": {
        "duration": 10,
        "durationUnit": "minute",
        "type": "none"
      }
    },
    {
      "id": 16,
      "name": "3",
      "startDate": "2025-10-16",
      "startTime": "11:49",
      "displayThreshold": 10,
      "displayThresholdUnit": "minute",
      "priority": "medium",
      "recurrence": {
        "duration": 10,
        "durationUnit": "minute",
        "type": "none"
      }
    },
    {
      "id": 17,
      "name": "间歇泉",
      "startDate": "2025-10-16",
      "startTime": "15:05",
      "displayThreshold": 10,
      "displayThresholdUnit": "minute",
      "priority": "medium",
      "recurrence": {
        "duration": 10,
        "durationUnit": "minute",
        "type": "custom",
        "count": 2,
        "unit": "hour"
      }
    },
    {
      "id": 18,
      "name": "献祭 重置",
      "startDate": "2025-10-16",
      "startTime": "15:39",
      "displayThreshold": 1,
      "displayThresholdUnit": "day",
      "priority": "low",
      "recurrence": {
        "duration": 10,
        "durationUnit": "minute",
        "type": "weekly",
        "weekdays": [
          0
        ]
      }
    },
    {
      "id": 21,
      "name": "海龟",
      "startDate": "2025-10-16",
      "startTime": "15:50",
      "displayThreshold": 10,
      "displayThresholdUnit": "minute",
      "priority": "medium",
      "recurrence": {
        "duration": 10,
        "durationUnit": "minute",
        "type": "custom",
        "count": 2,
        "unit": "hour"
      }
    },
    {
      "id": 22,
      "name": "奶奶饭",
      "startDate": "2025-10-16",
      "startTime": "15:35",
      "displayThreshold": 10,
      "displayThresholdUnit": "minute",
      "priority": "medium",
      "recurrence": {
        "duration": 10,
        "durationUnit": "minute",
        "type": "custom",
        "count": 2,
        "unit": "hour"
      }
    },
    {
      "id": 23,
      "name": "AURORA",
      "startDate": "2025-10-16",
      "startTime": "15:10",
      "displayThreshold": 10,
      "displayThresholdUnit": "minute",
      "priority": "medium",
      "recurrence": {
        "duration": 50,
        "durationUnit": "minute",
        "type": "custom",
        "count": 4,
        "unit": "hour"
      }
    },
    {
      "id": 24,
      "name": "任务 重置",
      "startDate": "2025-10-16",
      "startTime": "15:00",
      "displayThreshold": 30,
      "displayThresholdUnit": "minute",
      "priority": "high",
      "recurrence": {
        "duration": 1,
        "durationUnit": "minute",
        "type": "daily"
      }
    },
    {
      "id": 25,
      "name": "空间站",
      "startDate": "2025-10-16",
      "startTime": "15:00",
      "displayThreshold": 1,
      "displayThresholdUnit": "day",
      "priority": "low",
      "recurrence": {
        "duration": 1,
        "durationUnit": "day",
        "type": "weekly",
        "weekdays": [
          4
        ]
      }
    }
  ]
};
        
        // 保存状态管理
        const saveState = {
            isSaving: false,
            lastSaved: null,
            saveAttempts: 0,
            maxAttempts: 3
        };
        
        // 尝试从localStorage加载数据
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('timeProjectReminderTasks');
                if (savedData) {
                    return JSON.parse(savedData);
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                showNotification('加载数据失败: ' + e.message, true);
            }
            return null;
        }
        
        // 保存数据到localStorage - 核心保存函数
        function saveToLocalStorage(data, retry = 0) {
            // 如果正在保存中，等待后重试
            if (saveState.isSaving) {
                if (retry < saveState.maxAttempts) {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            saveToLocalStorage(data, retry + 1)
                                .then(resolve)
                                .catch(resolve);
                        }, 300);
                    });
                }
                return Promise.resolve(false);
            }
            
            // 标记为正在保存
            saveState.isSaving = true;
            showSaveStatus(true);
            
            return new Promise(resolve => {
                try {
                    // 验证数据格式
                    if (!data || !Array.isArray(data)) {
                        throw new Error('无效的数据格式');
                    }
                    
                    // 尝试保存数据
                    localStorage.setItem('timeProjectReminderTasks', JSON.stringify(data));
                    
                    // 更新保存状态
                    saveState.lastSaved = new Date();
                    saveState.saveAttempts = 0;
                    saveState.isSaving = false;
                    
                    // 显示成功状态
                    showSaveStatus(false, true);
                    showNotification('数据已成功保存');
                    resolve(true);
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                    
                    // 处理保存失败
                    saveState.saveAttempts++;
                    saveState.isSaving = false;
                    
                    // 显示失败状态
                    showSaveStatus(false, false);
                    showNotification('保存失败: ' + e.message, true);
                    
                    // 如果达到最大尝试次数，提示用户导出数据
                    if (saveState.saveAttempts >= saveState.maxAttempts) {
                        if (confirm('多次保存失败，是否导出数据以防止丢失？')) {
                            downloadAsHtml();
                        }
                    }
                    
                    resolve(false);
                }
            });
        }
        
        // 显示保存状态指示器
        function showSaveStatus(isSaving, success = false) {
            const statusEl = document.getElementById('save-status');
            const statusTextEl = document.getElementById('save-status-text');
            
            if (isSaving) {
                statusTextEl.textContent = '保存中...';
                statusEl.classList.remove('hidden', 'text-green-500', 'text-red-500');
                statusEl.classList.add('text-primary');
            } else {
                if (success) {
                    statusTextEl.textContent = '保存成功';
                    statusEl.classList.remove('hidden', 'text-primary', 'text-red-500');
                    statusEl.classList.add('text-green-500');
                    
                    // 2秒后隐藏成功状态
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 2000);
                } else {
                    statusTextEl.textContent = '保存失败';
                    statusEl.classList.remove('hidden', 'text-primary', 'text-green-500');
                    statusEl.classList.add('text-red-500');
                }
            }
        }
        
        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            // 添加或移除错误类
            if (isError) {
                notification.classList.add('error');
            } else {
                notification.classList.remove('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 事件数据 - 从localStorage加载或使用测试数据
        let tasks = loadFromLocalStorage() || [
            {
                id: 1,
                name: "正在进行的测试事件",
                startDate: new Date().toISOString().split('T')[0],
                startTime: new Date(Date.now() - 10 * 60 * 1000).toTimeString().split(':').slice(0, 2).join(':'),
                displayThreshold: 10,
                displayThresholdUnit: "minute",
                recurrence: {
                    type: "none",
                    duration: 30,
                    durationUnit: "minute"
                },
                priority: "high"
            },
            {
                id: 2,
                name: "每日会议",
                startDate: new Date().toISOString().split('T')[0],
                startTime: new Date(Date.now() - 5 * 60 * 1000).toTimeString().split(':').slice(0, 2).join(':'),
                displayThreshold: 10,
                displayThresholdUnit: "minute",
                recurrence: {
                    type: "daily",
                    duration: 20,
                    durationUnit: "minute"
                },
                priority: "medium"
            }
        ];

        // 当前操作的事件ID
        let currentTaskId = null;

        // DOM元素
        const currentTimeEl = document.getElementById('current-time');
        const taskCarousel = document.getElementById('task-carousel');
        const allTasksEl = document.getElementById('all-tasks');
        const allTasksListEl = document.getElementById('all-tasks-list');
        const appContainer = document.getElementById('app-container');
        const controlsContainer = document.getElementById('controls-container');
        const mainContextMenu = document.getElementById('main-context-menu');
        const taskContextMenu = document.getElementById('task-context-menu');
        const addTaskOption = document.getElementById('add-task-option');
        const editTaskOption = document.getElementById('edit-task-option');
        const deleteTaskOption = document.getElementById('delete-task-option');
        const taskModal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModal = document.getElementById('close-modal');
        const cancelTask = document.getElementById('cancel-task');
        const taskForm = document.getElementById('task-form');
        const taskIdInput = document.getElementById('task-id');
        const displayThresholdInput = document.getElementById('display-threshold');
        const displayThresholdUnitInput = document.getElementById('display-threshold-unit');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const closeDeleteModal = document.getElementById('close-delete-modal');
        const cancelDelete = document.getElementById('cancel-delete');
        const confirmDelete = document.getElementById('confirm-delete');
        const recurrenceTypeInput = document.getElementById('recurrence-type');
        const weeklyOptions = document.getElementById('weekly-options');
        const customOptions = document.getElementById('custom-options');
        const startDateInput = document.getElementById('start-date');
        const startTimeInput = document.getElementById('start-time');
        const intervalCountInput = document.getElementById('interval-count');
        const intervalUnitInput = document.getElementById('interval-unit');
        const taskDurationInput = document.getElementById('task-duration');
        const durationUnitInput = document.getElementById('duration-unit');
        const weekdayCheckboxes = document.querySelectorAll('input[name="weekday"]');
        const recurrenceOptions = document.querySelectorAll('.recurrence-option');
        const downloadBtn = document.getElementById('download-btn');
        const manualSaveBtn = document.getElementById('manual-save-btn');
        
        // 初始化日期和时间为今天和当前时间
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(':').slice(0, 2).join(':');
            
            startDateInput.value = dateStr;
            startTimeInput.value = timeStr;
            
            // 初始化重复选项点击事件
            recurrenceOptions.forEach(option => {
                option.addEventListener('click', () => {
                    recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    const type = option.getAttribute('data-type');
                    recurrenceTypeInput.value = type;
                    showRecurrenceOptions(type);
                });
            });
            
            // 检查是否有外部数据并加载
            if (externalData && externalData.tasks) {
                tasks = externalData.tasks;
                saveToLocalStorage(tasks); // 将外部数据同步到localStorage
            }
            
            // 初始化下载按钮事件
            downloadBtn.addEventListener('click', downloadAsHtml);
            
            // 初始化手动保存按钮事件
            manualSaveBtn.addEventListener('click', async () => {
                await saveToLocalStorage(tasks);
            });
            
            // 验证本地存储是否可用
            testLocalStorageAvailability();
        });
        
        // 测试本地存储是否可用
        function testLocalStorageAvailability() {
            try {
                const testKey = 'test_local_storage_availability_' + Math.random();
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                // 不显示成功通知，避免干扰
            } catch (e) {
                console.error('LocalStorage is not available:', e);
                showNotification('本地存储不可用，建议使用下载功能保存数据', true);
            }
        }
        
        // 转换时间单位为毫秒
        function convertToMilliseconds(value, unit) {
            const units = {
                minute: 60 * 1000,
                hour: 60 * 60 * 1000,
                day: 24 * 60 * 60 * 1000,
                week: 7 * 24 * 60 * 60 * 1000
            };
            return value * (units[unit] || units.minute);
        }
        
        // 转换毫秒为最适合的单位
        function convertFromMilliseconds(ms) {
            if (ms >= 7 * 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (7 * 24 * 60 * 60 * 1000)), unit: 'week', text: '周' };
            } else if (ms >= 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (24 * 60 * 60 * 1000)), unit: 'day', text: '天' };
            } else if (ms >= 60 * 60 * 1000) {
                return { value: Math.round(ms / (60 * 60 * 1000)), unit: 'hour', text: '小时' };
            } else {
                return { value: Math.round(ms / (60 * 1000)), unit: 'minute', text: '分钟' };
            }
        }

        // 格式化倒计时显示
        function formatCountdown(ms) {
            if (ms < 0) return "已开始";
            
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            if (days > 0) {
                return `${days}天${hours}时`;
            } else if (hours > 0) {
                return `${hours}时${minutes}分`;
            } else if (minutes > 0) {
                return `${minutes}分${seconds}秒`;
            } else {
                return `${seconds}秒`;
            }
        }

        // 轮播状态
        let currentSlide = 0;
        let visibleTasks = [];

        // 更新当前时间显示
        function updateCurrentTime() {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 计算事件的下一次发生时间
        function getNextOccurrence(task, now) {
            // 解析事件的开始时间（忽略日期，只关注时间部分）
            const [startHour, startMinute] = task.startTime.split(':').map(Number);
            
            // 克隆当前时间，用于计算
            let nextTime = new Date(now);
            nextTime.setHours(startHour, startMinute, 0, 0);
            
            // 处理每周重复的特殊情况
            if (task.recurrence.type === "weekly") {
                const todayWeekday = now.getDay();
                let daysToAdd = 0;
                let found = false;
                
                // 查找下一个符合条件的星期几（包括今天）
                for (let i = 0; i < 7; i++) {
                    const checkDay = (todayWeekday + i) % 7;
                    if (task.recurrence.weekdays.includes(checkDay)) {
                        daysToAdd = i;
                        found = true;
                        break;
                    }
                }
                
                // 如果没有找到（理论上不会发生），默认一周后
                if (!found && task.recurrence.weekdays.length > 0) {
                    daysToAdd = 7;
                }
                
                // 设置到下一个符合条件的星期几
                nextTime.setDate(nextTime.getDate() + daysToAdd);
                
                // 计算事件持续时间
                const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                
                // 检查是否在本周的同一天但时间已过但仍在持续时间内
                const sameDay = nextTime.toDateString() === now.toDateString();
                if (sameDay && nextTime <= now && now < nextTime.getTime() + durationMs) {
                    // 如果在持续时间内，返回原始开始时间
                    return new Date(nextTime);
                }
                
                // 如果计算出的时间仍在当前时间之前且不在持续时间内，再加一周
                if (nextTime <= now) {
                    nextTime.setDate(nextTime.getDate() + 7);
                }
                
                return nextTime;
            }
            
            // 处理其他重复类型
            const [startYear, startMonth, startDay] = task.startDate.split('-').map(Number);
            const initialStart = new Date(startYear, startMonth - 1, startDay, startHour, startMinute);
            
            // 对于重复事件，计算最近的一次发生时间（可能在过去但仍在持续时间内）
            if (task.recurrence.type !== "none") {
                // 计算间隔毫秒数
                let intervalMs;
                switch(task.recurrence.type) {
                    case "daily":
                        intervalMs = 24 * 60 * 60 * 1000; // 一天的毫秒数
                        break;
                    case "custom":
                        intervalMs = convertToMilliseconds(task.recurrence.count, task.recurrence.unit);
                        break;
                    default:
                        intervalMs = 24 * 60 * 60 * 1000; // 默认一天
                }
                
                // 计算从初始时间到现在的总间隔数
                const timeDiff = now - initialStart;
                const intervals = Math.floor(timeDiff / intervalMs);
                
                // 计算最近一次发生时间（可能在过去）
                const lastOccurrence = new Date(initialStart.getTime() + intervals * intervalMs);
                
                // 计算事件持续时间
                const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                
                // 如果当前时间仍在最近一次事件的持续时间内，返回该时间
                if (now <= lastOccurrence.getTime() + durationMs) {
                    return lastOccurrence;
                }
                
                // 否则返回下一次发生时间
                return new Date(lastOccurrence.getTime() + intervalMs);
            }
            
            // 非重复事件的处理
            if (initialStart > now) {
                return new Date(initialStart);
            }
            
            return new Date(initialStart);
        }

        // 获取事件状态信息 - 修改为显示距离开始时间
        function getTaskStatus(task, now) {
            const nextStart = getNextOccurrence(task, now);
            
            // 计算事件结束时间（基于持续时间）
            const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
            const endTime = new Date(nextStart.getTime() + durationMs);
            
            // 计算事件的显示开始时间（开始时间 - 提前提醒时间）
            const thresholdMs = convertToMilliseconds(task.displayThreshold, task.displayThresholdUnit);
            const displayStartTime = new Date(nextStart.getTime() - thresholdMs);
            
            // 计算事件的显示结束时间（结束时间）
            const displayEndTime = new Date(endTime);
            
            // 判断是否在显示时间范围内（提前提醒时间到结束时间）
            const isInDisplayRange = now >= displayStartTime && now <= displayEndTime;
            
            // 判断是否正在进行中（当前时间在开始时间和结束时间之间）
            const isOngoing = now >= nextStart && now < endTime;
            
            // 计算距离开始时间的毫秒数（核心修改：不再使用显示时间）
            const timeUntilStart = nextStart - now;
            
            // 对于重复事件，不标记为已完成
            if (task.recurrence.type === "none" && now > displayEndTime) {
                return {
                    status: "completed",
                    timeText: "已完成",
                    countdownMs: 0,
                    countdownText: "已完成",
                    minutes: Infinity,
                    startTime: null,
                    endTime: null,
                    displayStartTime: displayStartTime,
                    displayEndTime: displayEndTime
                };
            }
            
            if (isOngoing) {
                const timeLeft = endTime - now;
                const converted = convertFromMilliseconds(timeLeft);
                return {
                    status: "ongoing",
                    timeText: `正在进行，${converted.value}${converted.text}后结束`,
                    countdownMs: timeLeft,
                    countdownText: formatCountdown(timeLeft),
                    minutes: Math.ceil(timeLeft / (1000 * 60)),
                    startTime: nextStart,
                    endTime: endTime,
                    displayStartTime: displayStartTime,
                    displayEndTime: displayEndTime
                };
            } else if (isInDisplayRange) {
                // 还未开始但在提前提醒范围内 - 显示距离开始时间
                const converted = convertFromMilliseconds(timeUntilStart);
                return {
                    status: "upcoming",
                    timeText: `${converted.value}${converted.text}后开始`,
                    countdownMs: timeUntilStart,
                    countdownText: formatCountdown(timeUntilStart),
                    minutes: Math.ceil(timeUntilStart / (1000 * 60)),
                    startTime: nextStart,
                    endTime: endTime,
                    displayStartTime: displayStartTime,
                    displayEndTime: displayEndTime
                };
            } else {
                // 不在显示范围内 - 显示距离开始时间
                const converted = convertFromMilliseconds(timeUntilStart);
                return {
                    status: "future",
                    timeText: `${converted.value}${converted.text}后开始`,
                    countdownMs: timeUntilStart,
                    countdownText: formatCountdown(timeUntilStart),
                    minutes: Math.ceil(timeUntilStart / (1000 * 60)),
                    startTime: nextStart,
                    endTime: endTime,
                    displayStartTime: displayStartTime,
                    displayEndTime: displayEndTime
                };
            }
        }

        // 过滤出需要显示的事件
        function getVisibleTasks() {
            const now = new Date();
            return tasks
                .map(task => {
                    const status = getTaskStatus(task, now);
                    return {
                        ...task,
                        ...status
                    };
                })
                .filter(task => {
                    // 显示正在进行和即将开始的事件（在显示时间范围内），排除已完成的
                    return task.status !== "completed" && 
                           (task.status === "ongoing" || task.status === "upcoming");
                })
                .sort((a, b) => {
                    // 优先显示正在进行的事件，然后按剩余时间排序
                    if (a.status === "ongoing" && b.status !== "ongoing") return -1;
                    if (a.status !== "ongoing" && b.status === "ongoing") return 1;
                    return a.minutes - b.minutes;
                });
        }

        // 获取所有事件（用于悬停显示）
        function getAllTasksWithStatus() {
            const now = new Date();
            return tasks
                .map(task => {
                    const status = getTaskStatus(task, now);
                    return {
                        ...task,
                        ...status
                    };
                })
                .filter(task => task.status !== "completed")
                .sort((a, b) => a.startTime - b.startTime);
        }

        // 创建事件元素 - 统一正在进行和即将开始的UI，优化排版
        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            // 统一所有可见事件的基础样式，仅通过指示器区分状态
            const baseClass = "task-item p-4 rounded-xl mb-3 task-transition bg-dark-bg shadow-sm mx-auto max-w-md";
            
            taskEl.className = baseClass;
            taskEl.dataset.taskId = task.id;
            
            // 生成重复规则文本描述
            let recurrenceText = "";
            switch(task.recurrence.type) {
                case "none":
                    recurrenceText = "不重复";
                    break;
                case "daily":
                    recurrenceText = "每天";
                    break;
                case "weekly":
                    const dayNames = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
                    const selectedDays = task.recurrence.weekdays?.map(day => dayNames[day]).join(', ') || "";
                    recurrenceText = `每周${selectedDays}`;
                    break;
                case "custom":
                    const unitNames = {
                        "minute": "分钟",
                        "hour": "小时",
                        "day": "天",
                        "week": "周"
                    };
                    recurrenceText = `每${task.recurrence.count}${unitNames[task.recurrence.unit]}`;
                    break;
            }
            
            // 生成持续时间文本
            const durationUnitNames = {
                "minute": "分钟",
                "hour": "小时",
                "day": "天",
                "week": "周"
            };
            const durationText = `${task.recurrence.duration}${durationUnitNames[task.recurrence.durationUnit]}`;
            
            // 格式化日期显示
            const isToday = task.startTime.toLocaleDateString() === new Date().toLocaleDateString();
            const dateText = isToday ? '今天' : task.startTime.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric', weekday: 'short'});
            
            // 为正在进行的事件添加视觉指示器
            const ongoingIndicator = task.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            
            // 倒计时文本
            const countdownBadge = `<span class="countdown ml-2">${task.countdownText}</span>`;
            
            taskEl.innerHTML = `
                <div class="flex justify-between items-center task-title">
                    <div class="font-medium text-dark-text flex items-center">
                        <span class="w-2 h-2 rounded-full mr-2 bg-priority-${task.priority}"></span>
                        ${task.name}
                    </div>
                    <div class="text-sm text-primary flex items-center">
                        ${ongoingIndicator}${task.timeText}${countdownBadge}
                    </div>
                </div>
                <div class="text-xs text-dark-textSecondary task-meta flex flex-col sm:flex-row sm:justify-between gap-1">
                    <span class="task-meta-item"><i class="fa fa-repeat mr-1 opacity-70"></i>${recurrenceText}</span>
                    <span class="task-meta-item"><i class="fa fa-clock-o mr-1 opacity-70"></i>持续 ${durationText}</span>
                    <span class="task-meta-item"><i class="fa fa-calendar mr-1 opacity-70"></i>${dateText}</span>
                    <span class="task-meta-item"><i class="fa fa-hourglass-start mr-1 opacity-70"></i>${task.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})} - 
                    ${task.endTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
                </div>
            `;
            
            // 为事件项添加右键菜单事件
            taskEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                hideAllContextMenus();
                
                currentTaskId = task.id;
                const x = e.clientX;
                const y = e.clientY;
                
                taskContextMenu.style.left = `${x}px`;
                taskContextMenu.style.top = `${y}px`;
                taskContextMenu.classList.remove('hidden');
            });
            
            return taskEl;
        }

        // 创建缩略事件元素（用于悬停显示）
        function createMiniTaskElement(task) {
            const taskEl = document.createElement('div');
            // 统一缩略事件的样式
            const baseClass = "flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover";
            
            taskEl.className = baseClass;
            taskEl.dataset.taskId = task.id;
            
            // 为正在进行的事件添加视觉指示器
            const ongoingIndicator = task.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            
            // 倒计时徽章
            const countdownBadge = `<span class="countdown ml-2">${task.countdownText}</span>`;
            
            taskEl.innerHTML = `
                <div class="flex items-center">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-${task.priority}"></span>
                    <span>${ongoingIndicator}${task.name}${countdownBadge}</span>
                </div>
                <div class="text-xs text-dark-textSecondary">
                    ${task.status === 'ongoing' ? '进行中' : task.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}
                </div>
            `;
            
            // 为缩略事件项添加右键菜单事件
            taskEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                hideAllContextMenus();
                
                currentTaskId = task.id;
                const x = e.clientX;
                const y = e.clientY;
                
                taskContextMenu.style.left = `${x}px`;
                taskContextMenu.style.top = `${y}px`;
                taskContextMenu.classList.remove('hidden');
            });
            
            return taskEl;
        }

        // 更新事件显示
        function updateTasks() {
            visibleTasks = getVisibleTasks();
            const allTasks = getAllTasksWithStatus();
            const hasVisibleContent = visibleTasks.length > 0 || allTasks.length > 0;
            
            // 清空轮播容器
            taskCarousel.innerHTML = '';
            
            if (visibleTasks.length === 0) {
                // 没有可见事件时显示提示
                taskCarousel.innerHTML = `
                    <div class="text-center py-4 text-dark-textSecondary">
                        目前没有即将开始的事件
                    </div>
                `;
            } else {
                // 添加所有可见事件到轮播
                visibleTasks.forEach(task => {
                    const taskEl = createTaskElement(task);
                    taskCarousel.appendChild(taskEl);
                });
                
                // 重置轮播位置
                currentSlide = 0;
                updateCarouselPosition();
            }
            
            // 更新所有事件列表（悬停时显示）
            updateAllTasksList();
            
            // 调整容器大小和样式
            adjustContainerSize(hasVisibleContent);
        }

        // 更新所有事件列表
        function updateAllTasksList() {
            const allTasks = getAllTasksWithStatus();
            allTasksListEl.innerHTML = '';
            
            allTasks.forEach(task => {
                const taskEl = createMiniTaskElement(task);
                allTasksListEl.appendChild(taskEl);
            });
        }

        // 调整容器大小和样式
        function adjustContainerSize(hasContent) {
            if (hasContent) {
                appContainer.classList.remove('app-compact');
                appContainer.classList.add('app-expanded');
                controlsContainer.classList.remove('opacity-0', 'pointer-events-none', 'h-0');
                
                const height = visibleTasks.length > 0 ? 
                    160 + visibleTasks.length * 110 : 140; // 增加高度以容纳更好的排版
                
                appContainer.style.minHeight = `${height}px`;
            } else {
                appContainer.classList.remove('app-expanded');
                appContainer.classList.add('app-compact');
                controlsContainer.classList.add('opacity-0', 'pointer-events-none', 'h-0');
                appContainer.style.minHeight = '140px'; // 固定高度以容纳时间显示
            }
        }

        // 更新轮播位置
        function updateCarouselPosition() {
            if (visibleTasks.length <= 1) return;
            
            const slideHeight = 110; // 增加高度以适应优化后的排版
            taskCarousel.style.transform = `translateY(-${currentSlide * slideHeight}px)`;
        }

        // 显示对应的重复选项面板
        function showRecurrenceOptions(type) {
            weeklyOptions.classList.add('hidden');
            customOptions.classList.add('hidden');
            
            if (type === 'weekly') {
                weeklyOptions.classList.remove('hidden');
            } else if (type === 'custom') {
                customOptions.classList.remove('hidden');
            }
        }

        // 验证表单数据
        function validateFormData(recurrenceType) {
            if (recurrenceType === 'weekly') {
                const checkedDays = Array.from(weekdayCheckboxes).filter(cb => cb.checked);
                if (checkedDays.length === 0) {
                    alert('请至少选择一个星期几');
                    return false;
                }
            } else if (recurrenceType === 'custom') {
                const count = parseInt(intervalCountInput.value) || 0;
                if (count < 1) {
                    alert('间隔计数必须大于0');
                    return false;
                }
            }
            
            // 验证提前提醒时间
            const threshold = parseInt(displayThresholdInput.value) || 0;
            if (threshold < 1) {
                alert('提前提醒时间必须大于0');
                return false;
            }
            
            // 验证持续时间
            const duration = parseInt(taskDurationInput.value) || 0;
            if (duration < 1) {
                alert('持续时间必须大于0');
                return false;
            }
            
            return true;
        }

        // 添加新事件
        async function addNewTask(taskData) {
            const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
            
            let newTask = {
                id: newId,
                name: taskData.name,
                startDate: taskData.startDate || new Date().toISOString().split('T')[0],
                startTime: taskData.startTime || new Date().toTimeString().split(':').slice(0, 2).join(':'),
                displayThreshold: parseInt(taskData.displayThreshold) || 10,
                displayThresholdUnit: taskData.displayThresholdUnit || "minute",
                priority: taskData.priority,
                recurrence: {
                    duration: parseInt(taskData.duration) || 10,
                    durationUnit: taskData.durationUnit || "minute",
                    type: taskData.recurrenceType
                }
            };
            
            switch(taskData.recurrenceType) {
                case "weekly":
                    newTask.recurrence.weekdays = taskData.weekdays ? 
                        taskData.weekdays.map(Number) : [1];
                    break;
                case "custom":
                    newTask.recurrence.count = parseInt(taskData.intervalCount) || 1;
                    newTask.recurrence.unit = taskData.intervalUnit || "day";
                    break;
            }
            
            tasks.push(newTask);
            // 强制保存并处理可能的失败
            const saveSuccess = await saveToLocalStorage(tasks);
            if (saveSuccess) {
                updateTasks();
            } else {
                // 如果保存失败，从数组中移除刚刚添加的任务
                tasks.pop();
                alert('添加事件失败，请重试');
            }
        }

        // 更新现有事件
        async function updateExistingTask(taskData) {
            const taskIndex = tasks.findIndex(t => t.id === parseInt(taskData.id));
            if (taskIndex === -1) return;
            
            // 保存原始任务数据，用于失败时恢复
            const originalTask = {...tasks[taskIndex]};
            
            tasks[taskIndex].name = taskData.name;
            tasks[taskIndex].startDate = taskData.startDate;
            tasks[taskIndex].startTime = taskData.startTime;
            tasks[taskIndex].displayThreshold = parseInt(taskData.displayThreshold) || 10;
            tasks[taskIndex].displayThresholdUnit = taskData.displayThresholdUnit || "minute";
            tasks[taskIndex].priority = taskData.priority;
            tasks[taskIndex].recurrence.duration = parseInt(taskData.duration) || 10;
            tasks[taskIndex].recurrence.durationUnit = taskData.durationUnit || "minute";
            tasks[taskIndex].recurrence.type = taskData.recurrenceType;
            
            delete tasks[taskIndex].recurrence.weekdays;
            delete tasks[taskIndex].recurrence.count;
            delete tasks[taskIndex].recurrence.unit;
            
            switch(taskData.recurrenceType) {
                case "weekly":
                    tasks[taskIndex].recurrence.weekdays = taskData.weekdays ? 
                        taskData.weekdays.map(Number) : [1];
                    break;
                case "custom":
                    tasks[taskIndex].recurrence.count = parseInt(taskData.intervalCount) || 1;
                    tasks[taskIndex].recurrence.unit = taskData.intervalUnit || "day";
                    break;
            }
            
            // 强制保存并处理可能的失败
            const saveSuccess = await saveToLocalStorage(tasks);
            if (saveSuccess) {
                updateTasks();
            } else {
                // 如果保存失败，恢复原始任务数据
                tasks[taskIndex] = originalTask;
                alert('更新事件失败，请重试');
            }
        }

        // 删除事件
        async function deleteTask(taskId) {
            // 保存要删除的任务，用于失败时恢复
            const taskToDelete = tasks.find(t => t.id === taskId);
            if (!taskToDelete) return;
            
            tasks = tasks.filter(task => task.id !== taskId);
            
            // 强制保存并处理可能的失败
            const saveSuccess = await saveToLocalStorage(tasks);
            if (saveSuccess) {
                updateTasks();
            } else {
                // 如果保存失败，恢复被删除的任务
                tasks.push(taskToDelete);
                alert('删除事件失败，请重试');
            }
        }

        // 显示添加事件模态框
        function showAddTaskModal() {
            modalTitle.textContent = "添加新事件";
            taskForm.reset();
            taskIdInput.value = "";
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(':').slice(0, 2).join(':');
            
            startDateInput.value = dateStr;
            startTimeInput.value = timeStr;
            displayThresholdInput.value = 10;
            displayThresholdUnitInput.value = "minute";
            taskDurationInput.value = 10;
            durationUnitInput.value = "minute";
            
            recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.recurrence-option[data-type="none"]').classList.add('selected');
            recurrenceTypeInput.value = "none";
            showRecurrenceOptions("none");
            
            taskModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // 显示编辑事件模态框
        function showEditTaskModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            modalTitle.textContent = "编辑事件";
            taskIdInput.value = task.id;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-duration').value = task.recurrence.duration;
            document.getElementById('duration-unit').value = task.recurrence.durationUnit || "minute";
            document.getElementById('start-date').value = task.startDate;
            document.getElementById('start-time').value = task.startTime;
            document.getElementById('display-threshold').value = task.displayThreshold;
            document.getElementById('display-threshold-unit').value = task.displayThresholdUnit || "minute";
            
            const recurrenceType = task.recurrence.type || "none";
            recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
            const selectedOption = document.querySelector(`.recurrence-option[data-type="${recurrenceType}"]`) || 
                                  document.querySelector('.recurrence-option[data-type="none"]');
            selectedOption.classList.add('selected');
            recurrenceTypeInput.value = recurrenceType;
            
            weekdayCheckboxes.forEach(checkbox => checkbox.checked = false);
            intervalCountInput.value = 1;
            intervalUnitInput.value = "day";
            
            if (recurrenceType === "weekly" && task.recurrence.weekdays) {
                task.recurrence.weekdays.forEach(day => {
                    const checkbox = document.querySelector(`input[name="weekday"][value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            } else if (recurrenceType === "custom") {
                intervalCountInput.value = task.recurrence.count || 1;
                intervalUnitInput.value = task.recurrence.unit || "day";
            }
            
            showRecurrenceOptions(recurrenceType);
            taskModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // 显示确认删除模态框
        function showConfirmDeleteModal(taskId) {
            currentTaskId = taskId;
            confirmDeleteModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // 隐藏所有右键菜单
        function hideAllContextMenus() {
            mainContextMenu.classList.add('hidden');
            taskContextMenu.classList.add('hidden');
        }

        // 隐藏事件模态框
        function hideTaskModal() {
            taskModal.classList.add('hidden');
        }

        // 隐藏确认删除模态框
        function hideConfirmDeleteModal() {
            confirmDeleteModal.classList.add('hidden');
        }

        // 鼠标悬停显示所有事件
        appContainer.addEventListener('mouseenter', () => {
            allTasksEl.style.maxHeight = '500px';
        });

        appContainer.addEventListener('mouseleave', () => {
            allTasksEl.style.maxHeight = '0';
        });

        // 应用容器右键菜单事件
        appContainer.addEventListener('contextmenu', (e) => {
            if (!e.target.closest('.task-item') && !e.target.closest('[data-task-id]')) {
                e.preventDefault();
                hideAllContextMenus();
                
                const x = e.clientX;
                const y = e.clientY;
                
                mainContextMenu.style.left = `${x}px`;
                mainContextMenu.style.top = `${y}px`;
                mainContextMenu.classList.remove('hidden');
            }
        });

        // 点击其他地方隐藏右键菜单
        document.addEventListener('click', hideAllContextMenus);

        // 添加事件选项点击事件
        addTaskOption.addEventListener('click', (e) => {
            e.stopPropagation();
            showAddTaskModal();
        });

        // 编辑事件选项点击事件
        editTaskOption.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentTaskId !== null) {
                showEditTaskModal(currentTaskId);
            }
        });

        // 删除事件选项点击事件
        deleteTaskOption.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentTaskId !== null) {
                showConfirmDeleteModal(currentTaskId);
            }
        });

        // 关闭模态框事件
        closeModal.addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });
        
        cancelTask.addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });
        
        taskModal.querySelector('.modal-backdrop').addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });

        // 关闭确认删除模态框事件
        closeDeleteModal.addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });
        
        cancelDelete.addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });
        
        confirmDeleteModal.querySelector('.modal-backdrop').addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });

        // 确认删除事件
        confirmDelete.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (currentTaskId !== null) {
                await deleteTask(currentTaskId);
                currentTaskId = null;
                hideConfirmDeleteModal();
            }
        });

        // 表单提交事件
        taskForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // 明确获取表单数据
            const formData = {
                id: document.getElementById('task-id').value,
                name: document.getElementById('task-name').value,
                startDate: document.getElementById('start-date').value,
                startTime: document.getElementById('start-time').value,
                displayThreshold: document.getElementById('display-threshold').value,
                displayThresholdUnit: document.getElementById('display-threshold-unit').value,
                priority: document.getElementById('task-priority').value,
                recurrenceType: recurrenceTypeInput.value,
                duration: document.getElementById('task-duration').value,
                durationUnit: document.getElementById('duration-unit').value,
                intervalCount: document.getElementById('interval-count').value,
                intervalUnit: document.getElementById('interval-unit').value,
                weekdays: Array.from(weekdayCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value)
            };
            
            // 验证表单数据
            if (!validateFormData(formData.recurrenceType)) {
                return;
            }
            
            // 执行保存操作
            if (formData.id) {
                await updateExistingTask(formData);
            } else {
                await addNewTask(formData);
            }
            
            hideTaskModal();
        });

        // 下载为HTML文件功能 - 修复保存不完整和代码不一致问题
        function downloadAsHtml() {
            try {
                // 创建完整的HTML内容，包含当前数据
                const dataToSave = { tasks: tasks };
                
                // 创建一个临时div用于处理HTML内容
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = document.documentElement.outerHTML;
                
                // 移除所有内联样式，避免显示问题
                const elementsWithStyles = tempDiv.querySelectorAll('[style]');
                elementsWithStyles.forEach(el => {
                    if (el.style.transform) {
                        const transform = el.style.transform;
                        el.removeAttribute('style');
                        el.style.transform = transform;
                    } else {
                        el.removeAttribute('style');
                    }
                });
                
                // 确保app-container使用默认的app-compact类
                const appContainer = tempDiv.querySelector('#app-container');
                if (appContainer) {
                    appContainer.className = 'bg-dark-card rounded-2xl shadow-lg task-transition border border-gray-700 w-auto max-w-md app-compact';
                }
                
                // 找到并更新包含externalData的script标签
                const scripts = tempDiv.querySelectorAll('script');
                scripts.forEach(script => {
                    if (script.textContent.includes('let externalData = null;')) {
                        // 完整替换externalData变量，确保数据完整
                        const newContent = script.textContent.replace(
                            'let externalData = null;',
                            `let externalData = ${JSON.stringify(dataToSave, null, 2)};`
                        );
                        script.textContent = newContent;
                    }
                });
                
                // 确保body标签包含正确的样式类
                const body = tempDiv.querySelector('body');
                if (body) {
                    body.className = 'bg-dark-bg min-h-screen flex items-center justify-center p-4 font-inter text-dark-text m-0';
                }
                
                // 获取更新后的HTML内容
                const updatedHtml = '<!DOCTYPE html>' + tempDiv.innerHTML;
                
                // 创建Blob对象，确保使用UTF-8编码
                const blob = new Blob([updatedHtml], { 
                    type: 'text/html; charset=utf-8' 
                });
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                // 生成包含当前日期的文件名
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                a.download = `时间项目提醒_${dateStr}.html`;
                
                a.href = url;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
                
                showNotification('数据已导出为HTML文件');
            } catch (e) {
                console.error('下载失败:', e);
                showNotification('导出HTML文件失败: ' + e.message, true);
            }
        }

        // 初始化并定时更新
        updateCurrentTime();
        updateTasks();
        
        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);
        
        // 每秒更新一次事件状态
        setInterval(updateTasks, 1000);
    </script>


    
  

<div id="global-shadow-host"></div>