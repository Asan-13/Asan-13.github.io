<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sky äº‹ä»¶ æ—¶é—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        priority: {
                            high: '#ef4444',
                            medium: '#f59e0b',
                            low: '#10b981',
                            none: '#64748b'
                        },
                        primary: '#60a5fa',
                        secondary: '#94a3b8',
                        dark: {
                            bg: '#1e293b',
                            card: '#334155',
                            hover: '#475569',
                            text: '#f8fafc',
                            textSecondary: '#cbd5e1'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .task-transition {
                transition: all 0.5s ease-in-out;
            }
            .hover-expand {
                transition: max-height 0.5s ease-in-out;
            }
            .context-menu {
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
            .modal-backdrop {
                backdrop-filter: blur(2px);
            }
            .app-compact {
                padding: 1.5rem;
                min-height: auto !important;
                width: auto !important;
                max-width: 280px;
            }
            .app-expanded {
                padding: 2rem;
                width: auto !important;
                max-width: 500px;
            }
            .task-item {
                cursor: pointer;
            }
            .day-checkbox {
                width: 1.5rem;
                height: 1.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .recurrence-option {
                @apply p-3 border border-gray-600 rounded-lg cursor-pointer transition-all hover:border-primary;
            }
            .recurrence-option.selected {
                @apply border-primary bg-primary/10;
            }
            .ongoing-indicator {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }
            .time-input-group {
                @apply flex items-center gap-3;
            }
            .time-input {
                @apply w-20 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .time-select {
                @apply flex-1 px-3 py-2 border border-gray-600 rounded-lg bg-dark-card text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent;
            }
            .countdown {
                @apply text-xs font-medium px-2 py-0.5 rounded-lg bg-primary/10 text-primary;
            }
            .download-btn {
                @apply fixed bottom-6 right-6 bg-primary hover:bg-primary/90 text-white p-3 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-40;
            }
            .download-tooltip {
                @apply absolute right-full mr-3 bg-dark-card text-dark-text px-3 py-1 rounded-lg text-sm opacity-0 invisible transition-all duration-300 whitespace-nowrap;
            }
            .download-container:hover .download-tooltip {
                @apply opacity-100 visible;
            }
            .notification {
                @apply fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full;
            }
            .notification.show {
                @apply translate-x-0;
            }
            .notification.error {
                @apply bg-red-500;
            }
            .save-btn {
                @apply fixed bottom-6 left-6 bg-green-600 hover:bg-green-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center z-40;
            }
            .save-tooltip {
                @apply absolute left-full ml-3 bg-dark-card text-dark-text px-3 py-1 rounded-lg text-sm opacity-0 invisible transition-all duration-300 whitespace-nowrap;
            }
            .save-container:hover .save-tooltip {
                @apply opacity-100 visible;
            }
            .save-status {
                @apply fixed bottom-6 left-20 bg-dark-card text-dark-text px-3 py-1 rounded-lg text-sm z-40;
            }
            .task-title {
                @apply tracking-wide;
            }
            .task-meta {
                @apply tracking-tight mt-1.5;
            }
            .task-meta-item {
                @apply mr-3 last:mr-0;
            }
            .ongoing-text {
                @apply text-priority-high font-medium;
            }
            .lock-indicator {
                @apply absolute top-4 right-4 text-dark-textSecondary hover:text-primary transition-colors cursor-pointer;
            }
            .lock-indicator.locked {
                @apply text-primary;
            }
            .empty-hover-area {
                cursor: pointer;
                @apply hover:bg-dark-hover/30 transition-colors rounded-lg;
            }
            .scrollable-list {
                max-height: 300px;
                overflow-y: auto;
                scrollbar-width: thin;
                scrollbar-color: theme('colors.primary') theme('colors.dark.bg');
            }
            .scrollable-list::-webkit-scrollbar {
                width: 6px;
            }
            .scrollable-list::-webkit-scrollbar-track {
                background: theme('colors.dark.bg');
                border-radius: 3px;
            }
            .scrollable-list::-webkit-scrollbar-thumb {
                background-color: theme('colors.primary');
                border-radius: 3px;
            }
            /* é¢„è§ˆå¡ç‰‡æ ·å¼ - ç´§å‡‘ä¼˜åŒ–ç‰ˆæœ¬ */
            .preview-card {
                @apply fixed bg-dark-card rounded-xl shadow-2xl border-2 border-primary/50 p-3 max-w-xs z-50 transform transition-all duration-200 scale-95 opacity-0 pointer-events-none;
                backdrop-filter: blur(10px);
                min-width: 260px;
            }
            .preview-card.show {
                @apply scale-100 opacity-100 pointer-events-auto;
            }
            .preview-card::before {
                content: '';
                @apply absolute -top-2 left-4 w-4 h-4 bg-primary/50 transform rotate-45;
            }
            .preview-content {
                @apply space-y-1.5;
            }
            .preview-header {
                @apply flex justify-between items-center mb-2 pb-2 border-b border-gray-700;
            }
            .preview-name {
                @apply font-medium text-dark-text flex items-center text-sm;
            }
            .preview-status {
                @apply text-xs text-primary flex items-center;
            }
            .preview-details {
                @apply text-xs text-dark-textSecondary space-y-1;
            }
            .preview-row {
                @apply flex justify-between items-center;
            }
            .preview-icon {
                @apply w-3 h-3 mr-1.5 opacity-70 flex items-center justify-center;
            }
            .preview-label {
                @apply flex items-center mr-2;
            }
            .preview-value {
                @apply text-dark-text text-right;
            }
            .preview-highlight {
                animation: glow 2s ease-in-out infinite alternate;
            }
            @keyframes glow {
                from {
                    box-shadow: 0 0 5px theme('colors.primary'), 0 0 10px theme('colors.primary');
                }
                to {
                    box-shadow: 0 0 10px theme('colors.primary'), 0 0 20px theme('colors.primary');
                }
            }
            /* ä¸æ»‘è·Ÿéšæ•ˆæœ */
            .preview-smooth {
                transition: transform 0.1s ease-out, opacity 0.2s ease-out;
            }
            /* æ‰‹æœºç«¯ä¼˜åŒ– */
            @media (max-width: 640px) {
                .app-expanded {
                    padding: 1rem;
                    max-width: 100%;
                    margin: 0.5rem;
                    min-height: auto !important;
                }
                .app-compact {
                    padding: 1rem;
                    max-width: 100%;
                    margin: 0.5rem;
                }
                .preview-card {
                    max-width: 85vw;
                    min-width: 0;
                    left: 7.5vw !important;
                    right: 7.5vw;
                    transform-origin: center;
                }
                .preview-card::before {
                    display: none;
                }
                /* æ–°å¢ï¼šè½®æ’­æ¨¡å—ä¸‹æ–¹ä¿¡æ¯æ”¹ä¸º2è¡Œæ˜¾ç¤º */
                .task-meta {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 0.25rem 1rem;
                    margin-top: 0.75rem;
                }
                .task-meta-item {
                    margin-right: 0;
                    display: flex;
                    align-items: center;
                }
                /* é‡å¤æ–¹å¼å’Œæ—¥æœŸåœ¨ç¬¬ä¸€è¡Œ */
                .task-meta-item:nth-child(1),
                .task-meta-item:nth-child(3) {
                    grid-column: span 1;
                }
                /* æŒç»­æ—¶é—´å’Œæ—¶é—´èŒƒå›´åœ¨ç¬¬äºŒè¡Œ */
                .task-meta-item:nth-child(2),
                .task-meta-item:nth-child(4) {
                    grid-column: span 1;
                }
                .time-input-group {
                    flex-direction: column;
                    align-items: stretch;
                }
                .time-input, .time-select {
                    width: 100%;
                }
                .download-btn, .save-btn {
                    bottom: 1rem;
                    padding: 0.625rem;
                }
                .download-btn {
                    right: 1rem;
                }
                .save-btn {
                    left: 1rem;
                }
                .save-status {
                    bottom: 1rem;
                    left: 4rem;
                }
                .modal-content {
                    max-height: 90vh;
                    overflow-y: auto;
                }
                .task-item {
                    padding: 0.75rem;
                }
                .task-title {
                    font-size: 0.875rem;
                }
                .task-meta {
                    font-size: 0.75rem;
                }
            }
        }
    </style>
</head>
<body class="bg-dark-bg min-h-screen flex items-center justify-center p-4 font-inter text-dark-text m-0">
    <div id="app-container" class="bg-dark-card rounded-2xl shadow-lg task-transition border border-gray-700 w-auto max-w-md app-expanded relative">
        <div id="lock-indicator" class="lock-indicator" title="å½“å‰é”å®šçŠ¶æ€">
            <i class="fa fa-unlock"></i>
        </div>
        
        <div id="current-time" class="text-center text-2xl font-semibold text-dark-text mb-4"></div>
        
        <div id="tasks-container" class="relative min-h-[80px] overflow-hidden">
            <div id="task-carousel" class="transition-transform duration-500 ease-in-out">
            </div>
        </div>
        
        <div class="text-sm text-dark-textSecondary mb-2 font-medium text-center empty-hover-area p-2">
            æœªæ¥äº‹ä»¶
        </div>
        
        <div id="all-tasks" class="mt-0 max-h-0 overflow-hidden hover-expand">
            <div id="all-tasks-list" class="space-y-2.5 text-sm scrollable-list"></div>
        </div>
        
        <div id="controls-container" class="flex justify-center mt-4 space-x-2 transition-all duration-300 hidden">
        </div>
    </div>

    <!-- é¢„è§ˆå¡ç‰‡ - ç´§å‡‘ä¼˜åŒ–æ’ç‰ˆ -->
    <div id="preview-card" class="preview-card preview-smooth">
        <div class="preview-content">
            <div class="preview-header">
                <div class="preview-name">
                    <span id="preview-priority" class="w-2 h-2 rounded-full mr-2"></span>
                    <span id="preview-name" class="truncate"></span>
                </div>
                <div id="preview-status" class="preview-status"></div>
            </div>
            <div class="preview-details">
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-repeat preview-icon"></i>
                        <span>é‡å¤</span>
                    </span>
                    <span id="preview-recurrence" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-clock-o preview-icon"></i>
                        <span>æ—¶é•¿</span>
                    </span>
                    <span id="preview-duration" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-calendar preview-icon"></i>
                        <span>æ—¥æœŸ</span>
                    </span>
                    <span id="preview-date" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-hourglass-start preview-icon"></i>
                        <span>æ—¶é—´</span>
                    </span>
                    <span id="preview-time" class="preview-value"></span>
                </div>
                <div class="preview-row">
                    <span class="preview-label">
                        <i class="fa fa-bell preview-icon"></i>
                        <span>æé†’</span>
                    </span>
                    <span id="preview-alert" class="preview-value"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div id="main-context-menu" class="context-menu hidden absolute bg-dark-card rounded-lg shadow-lg p-2 w-48 border border-gray-700">
        <div id="add-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer">
            <i class="fa fa-plus mr-2 text-primary"></i>æ·»åŠ æ–°äº‹ä»¶
        </div>
    </div>

    <div id="task-context-menu" class="context-menu hidden absolute bg-dark-card rounded-lg shadow-lg p-2 w-48 border border-gray-700">
        <div id="edit-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer">
            <i class="fa fa-pencil mr-2 text-primary"></i>ç¼–è¾‘äº‹ä»¶
        </div>
        <div id="delete-task-option" class="px-4 py-2 text-sm text-dark-text hover:bg-dark-hover rounded cursor-pointer">
            <i class="fa fa-trash mr-2 text-red-500"></i>åˆ é™¤äº‹ä»¶
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div id="confirm-delete-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-dark-text">ç¡®è®¤åˆ é™¤</h3>
                <button id="close-delete-modal" class="text-dark-textSecondary hover:text-dark-text">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <p class="text-dark-textSecondary mb-6">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 border border-gray-600 rounded-lg text-dark-text hover:bg-dark-hover transition-colors">å–æ¶ˆ</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘äº‹ä»¶æ¨¡æ€æ¡† -->
    <div id="task-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-60"></div>
        <div class="bg-dark-card rounded-xl shadow-xl p-6 w-full max-w-md relative z-10 transform transition-all border border-gray-700 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-semibold text-dark-text">æ·»åŠ æ–°äº‹ä»¶</h3>
                <button id="close-modal" class="text-dark-textSecondary hover:text-dark-text">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="task-form">
                <input type="hidden" id="task-id">
                
                <div class="mb-4">
                    <label for="task-name" class="block text-sm font-medium text-dark-textSecondary mb-1">äº‹ä»¶åç§°</label>
                    <input type="text" id="task-name" name="task-name" required class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div class="mb-4">
                    <label for="task-priority" class="block text-sm font-medium text-dark-textSecondary mb-1">ä¼˜å…ˆçº§</label>
                    <select id="task-priority" name="task-priority" required class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="high">é«˜ (çº¢è‰²)</option>
                        <option value="medium" selected>ä¸­ (é»„è‰²)</option>
                        <option value="low">ä½ (ç»¿è‰²)</option>
                        <option value="none">æ—  (ç°è‰²)</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="display-threshold" class="block text-sm font-medium text-dark-textSecondary mb-1">æå‰æé†’æ—¶é—´</label>
                    <div class="time-input-group">
                        <input type="number" id="display-threshold" name="display-threshold" min="1" value="10" class="time-input">
                        <select id="display-threshold-unit" name="display-threshold-unit" class="time-select">
                            <option value="minute">åˆ†é’Ÿ</option>
                            <option value="hour">å°æ—¶</option>
                            <option value="day">å¤©</option>
                            <option value="week">å‘¨</option>
                        </select>
                    </div>
                    <p class="text-xs text-primary mt-1">äº‹ä»¶å¼€å§‹å‰å¤šä¹…æ˜¾ç¤ºæé†’</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">å¼€å§‹æ—¶é—´</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <input type="date" id="start-date" name="start-date" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="start-date" class="text-xs text-dark-textSecondary">æ—¥æœŸ</label>
                        </div>
                        <div>
                            <input type="time" id="start-time" name="start-time" class="w-full px-3 py-2 border border-gray-600 rounded-lg bg-dark-bg text-dark-text focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <label for="start-time" class="text-xs text-dark-textSecondary">æ—¶é—´</label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">é‡å¤æ–¹å¼</label>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="recurrence-option selected" data-type="none">
                            <div class="font-medium">ä¸é‡å¤</div>
                            <div class="text-xs text-dark-textSecondary">ä»…ä¸€æ¬¡</div>
                        </div>
                        <div class="recurrence-option" data-type="daily">
                            <div class="font-medium">æ¯å¤©</div>
                            <div class="text-xs text-dark-textSecondary">æ¯å¤©åŒä¸€æ—¶é—´</div>
                        </div>
                        <div class="recurrence-option" data-type="weekly">
                            <div class="font-medium">æ¯å‘¨</div>
                            <div class="text-xs text-dark-textSecondary">æ¯å‘¨ç‰¹å®šæ—¥æœŸ</div>
                        </div>
                        <div class="recurrence-option" data-type="monthly">
                            <div class="font-medium">æ¯æœˆ</div>
                            <div class="text-xs text-dark-textSecondary">æ¯æœˆç‰¹å®šæ—¥æœŸ</div>
                        </div>
                        <div class="recurrence-option" data-type="custom">
                            <div class="font-medium">è‡ªå®šä¹‰</div>
                            <div class="text-xs text-dark-textSecondary">æŒ‰é—´éš”é‡å¤</div>
                        </div>
                    </div>
                    <input type="hidden" id="recurrence-type" value="none">
                </div>
                
                <!-- æ¯å‘¨é‡å¤é€‰é¡¹ -->
                <div id="weekly-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">æ¯å‘¨é‡å¤æ—¥æœŸ</label>
                    <div class="flex flex-wrap gap-2 mb-1">
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="1" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">ä¸€</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="2" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">äºŒ</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="3" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">ä¸‰</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="4" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">å››</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="5" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">äº”</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="6" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">å…­</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="weekday" value="0" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">æ—¥</span>
                        </label>
                    </div>
                </div>
                
                <!-- æ¯æœˆé‡å¤é€‰é¡¹ -->
                <div id="monthly-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">æ¯æœˆé‡å¤æ—¥æœŸ</label>
                    <div class="flex flex-wrap gap-2 mb-1">
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="1" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">1</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="2" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">2</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="3" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">3</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="4" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">4</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="5" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">5</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="6" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">6</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="7" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">7</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="8" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">8</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="9" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">9</span>
                        </label>
                        <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                            <input type="checkbox" name="monthday" value="10" class="hidden peer">
                            <span class="text-xs peer-checked:text-primary">10</span>
                        </label>
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-medium text-dark-textSecondary mb-1">æˆ–æŒ‰æ˜ŸæœŸå‡ </label>
                        <div class="flex flex-wrap gap-2">
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="1" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">ä¸€</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="2" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">äºŒ</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="3" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">ä¸‰</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="4" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">å››</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="5" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">äº”</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="6" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">å…­</span>
                            </label>
                            <label class="day-checkbox bg-dark-card border border-gray-600 hover:bg-dark-hover cursor-pointer">
                                <input type="checkbox" name="monthweekday" value="0" class="hidden peer">
                                <span class="text-xs peer-checked:text-primary">æ—¥</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰é‡å¤é€‰é¡¹ -->
                <div id="custom-options" class="mb-4 hidden bg-dark-bg p-3 rounded-lg border border-gray-600">
                    <label class="block text-sm font-medium text-dark-textSecondary mb-2">é‡å¤é—´éš”</label>
                    <div class="time-input-group">
                        <input type="number" id="interval-count" name="interval-count" min="1" value="1" class="time-input">
                        <select id="interval-unit" name="interval-unit" class="time-select">
                            <option value="minute">åˆ†é’Ÿ</option>
                            <option value="hour">å°æ—¶</option>
                            <option value="day">å¤©</option>
                            <option value="week">å‘¨</option>
                            <option value="month">æœˆ</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="task-duration" class="block text-sm font-medium text-dark-textSecondary mb-1">æŒç»­æ—¶é—´</label>
                    <div class="time-input-group">
                        <input type="number" id="task-duration" name="task-duration" min="1" value="10" class="time-input">
                        <select id="duration-unit" name="duration-unit" class="time-select">
                            <option value="minute">åˆ†é’Ÿ</option>
                            <option value="hour">å°æ—¶</option>
                            <option value="day">å¤©</option>
                            <option value="week">å‘¨</option>
                        </select>
                    </div>
                    <p class="text-xs text-primary mt-1">äº‹ä»¶è¿›è¡Œçš„æ—¶é•¿ï¼Œå°†ä½œä¸ºè¿›è¡Œä¸­äº‹ä»¶çš„å€’è®¡æ—¶åŸºå‡†</p>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-task" class="px-4 py-2 border border-gray-600 rounded-lg text-dark-text hover:bg-dark-hover transition-colors">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        ä¿å­˜äº‹ä»¶
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸‹è½½æŒ‰é’® -->
    <div class="download-container relative">
        <button id="download-btn" class="download-btn">
            <i class="fa fa-downloadåä¸‰éšè—"></i>
        </button>
        <span class="download-tooltip">ä¿å­˜å½“å‰äº‹ä»¶åˆ°HTMLæ–‡ä»¶</span>
    </div>

    <!-- ä¿å­˜æŒ‰é’® -->
    <div class="save-container relative">
        <button id="manual-save-btn" class="save-btn">
            <i class="fa fa-saveåä¸‰éšè—"></i>
        </button>
        <span class="save-tooltip">æ‰‹åŠ¨ä¿å­˜å½“å‰æ•°æ®</span>
    </div>

    <!-- ä¿å­˜çŠ¶æ€ -->
    <div id="save-status" class="save-status hidden">
        <span id="save-status-text">ä¿å­˜ä¸­...</span>
    </div>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification">æ•°æ®å·²ä¿å­˜</div>

    <script>
        // ç”¨äºå­˜å‚¨å¤–éƒ¨æ•°æ®çš„å˜é‡ - ä»localStorageåŠ è½½æˆ–ä½¿ç”¨é»˜è®¤å€¼
        let externalData = null;
        
        // ä¿å­˜çŠ¶æ€ç®¡ç†
        const saveState = {
            isSaving: false,
            lastSaved: null,
            saveAttempts: 0,
            maxAttempts: 3
        };
        
        // ä»»åŠ¡åˆ—è¡¨é”å®šçŠ¶æ€
        let isListLocked = false;
        
        // é¢„è§ˆå¡ç‰‡çŠ¶æ€
        let previewTimeout = null;
        let currentPreviewTaskId = null;
        let isPreviewVisible = false;
        let mouseX = 0;
        let mouseY = 0;
        
        // å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„å¯è§ä»»åŠ¡ï¼Œç”¨äºé¢„è§ˆå¡ç‰‡æ•°æ®åŒæ­¥
        let currentVisibleTasks = [];
        let currentAllTasks = [];
        
        // å°è¯•ä»localStorageåŠ è½½æ•°æ®
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('timeProjectReminderTasks');
                if (savedData) {
                    return JSON.parse(savedData);
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥: ' + e.message, true);
            }
            return null;
        }
        
        // ä¿å­˜æ•°æ®åˆ°localStorage - æ ¸å¿ƒä¿å­˜å‡½æ•°
        function saveToLocalStorage(data, retry = 0) {
            if (saveState.isSaving) {
                if (retry < saveState.maxAttempts) {
                    return new Promise(resolve => {
                        setTimeout(() => {
                            saveToLocalStorage(data, retry + 1)
                                .then(resolve)
                                .catch(resolve);
                        }, 300);
                    });
                }
                return Promise.resolve(false);
            }
            
            saveState.isSaving = true;
            showSaveStatus(true);
            
            return new Promise(resolve => {
                try {
                    if (!data || !Array.isArray(data)) {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                    }
                    
                    localStorage.setItem('timeProjectReminderTasks', JSON.stringify(data));
                    
                    saveState.lastSaved = new Date();
                    saveState.saveAttempts = 0;
                    saveState.isSaving = false;
                    
                    showSaveStatus(false, true);
                    showNotification('æ•°æ®å·²æˆåŠŸä¿å­˜');
                    resolve(true);
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                    
                    saveState.saveAttempts++;
                    saveState.isSaving = false;
                    
                    showSaveStatus(false, false);
                    showNotification('ä¿å­˜å¤±è´¥: ' + e.message, true);
                    
                    if (saveState.saveAttempts >= saveState.maxAttempts) {
                        if (confirm('å¤šæ¬¡ä¿å­˜å¤±è´¥ï¼Œæ˜¯å¦å¯¼å‡ºæ•°æ®ä»¥é˜²æ­¢ä¸¢å¤±ï¼Ÿ')) {
                            downloadAsHtml();
                        }
                    }
                    
                    resolve(false);
                }
            });
        }
        
        // æ˜¾ç¤ºä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨
        function showSaveStatus(isSaving, success = false) {
            const statusEl = document.getElementById('save-status');
            const statusTextEl = document.getElementById('save-status-text');
            
            if (isSaving) {
                statusTextEl.textContent = 'ä¿å­˜ä¸­...';
                statusEl.classList.remove('hidden', 'text-green-500', 'text-red-500');
                statusEl.classList.add('text-primary');
            } else {
                if (success) {
                    statusTextEl.textContent = 'ä¿å­˜æˆåŠŸ';
                    statusEl.classList.remove('hidden', 'text-primary', 'text-red-500');
                    statusEl.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 2000);
                } else {
                    statusTextEl.textContent = 'ä¿å­˜å¤±è´¥';
                    statusEl.classList.remove('hidden', 'text-primary', 'text-green-500');
                    statusEl.classList.add('text-red-500');
                }
            }
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            if (isError) {
                notification.classList.add('error');
            } else {
                notification.classList.remove('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // è·å–åŒ—äº¬æ—¶é—´å¯¹åº”çš„PDTæ—¥æœŸ
        function getPDTDateFromCST(cstTime) {
            // åŒ—äº¬æ—¶é—´ (CST) = UTC+8
            // å¤ªå¹³æ´‹å¤ä»¤æ—¶ (PDT) = UTC-7
            // æ—¶å·®: 15å°æ—¶
            const pdtTime = new Date(cstTime.getTime() - 15 * 60 * 60 * 1000);
            return pdtTime;
        }

        // æ–°å¢è¾…åŠ©å‡½æ•°ï¼šè·å–æŒ‡å®šPDTæ—¥æœŸçš„æ‰€æœ‰æœ‰æ•ˆæ—¶é—´æ®µ
        function getDawnRedstoneTimeSlots(pdtDate) {
            const pdtDay = pdtDate.getDate();
            const pdtWeekday = pdtDate.getDay();
            
            // ç¬¬ä¸€ç»„PDTæ—¥æœŸï¼š1,7,13,19,25,31æ—¥
            const group1 = [1, 7, 13, 19, 25, 31];
            // ç¬¬äºŒç»„PDTæ—¥æœŸï¼š3,9,15,17,21,27æ—¥
            const group2 = [3, 9, 15, 17, 21, 27];
            // ç¬¬ä¸‰ç»„PDTæ—¥æœŸï¼š5,11,23,29æ—¥
            const group3 = [5, 11, 23, 29];
            
            let timeSlots = [];
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ç¬¬ä¸€ç»„PDTæ—¥æœŸ
            if (group1.includes(pdtDay)) {
                // å‘¨ä¸€æˆ–å‘¨äºŒå–æ¶ˆï¼ˆPDTæ—¶é—´ï¼‰
                if (pdtWeekday === 1 || pdtWeekday === 2) return [];
                
                // ä¸‰ä¸ªæ—¶é—´æ®µï¼ˆåŒ—äº¬æ—¶é—´ï¼‰- æŒ‰æ­£ç¡®é¡ºåº
                timeSlots = [
                    { startHour: 22, startMinute: 48, endHour: 2, endMinute: 40, isOvernight: true },
                    { startHour: 4, startMinute: 48, endHour: 8, endMinute: 40, isOvernight: false },
                    { startHour: 10, startMinute: 48, endHour: 14, endMinute: 40, isOvernight: false }
                ];
            }
            // æ£€æŸ¥æ˜¯å¦åœ¨ç¬¬äºŒç»„PDTæ—¥æœŸ
            else if (group2.includes(pdtDay)) {
                // å‘¨äºŒæˆ–å‘¨ä¸‰å–æ¶ˆï¼ˆPDTæ—¶é—´ï¼‰
                if (pdtWeekday === 2 || pdtWeekday === 3) return [];
                
                // ä¸‰ä¸ªæ—¶é—´æ®µï¼ˆåŒ—äº¬æ—¶é—´ï¼‰- æŒ‰æ­£ç¡®é¡ºåº
                timeSlots = [
                    { startHour: 17, startMinute: 28, endHour: 21, endMinute: 20, isOvernight: false },
                    { startHour: 23, startMinute: 28, endHour: 3, endMinute: 20, isOvernight: true },
                    { startHour: 5, startMinute: 28, endHour: 9, endMinute: 20, isOvernight: false }
                ];
            }
            // æ£€æŸ¥æ˜¯å¦åœ¨ç¬¬ä¸‰ç»„PDTæ—¥æœŸ
            else if (group3.includes(pdtDay)) {
                // å‘¨ä¸‰æˆ–å‘¨å››å–æ¶ˆï¼ˆPDTæ—¶é—´ï¼‰
                if (pdtWeekday === 3 || pdtWeekday === 4) return [];
                
                // ä¸‰ä¸ªæ—¶é—´æ®µï¼ˆåŒ—äº¬æ—¶é—´ï¼‰- æŒ‰æ­£ç¡®é¡ºåº
                timeSlots = [
                    { startHour: 18, startMinute: 38, endHour: 22, endMinute: 30, isOvernight: false },
                    { startHour: 0, startMinute: 38, endHour: 4, endMinute: 30, isOvernight: false },
                    { startHour: 6, startMinute: 38, endHour: 10, endMinute: 30, isOvernight: false }
                ];
            }
            
            // è½¬æ¢æ—¶é—´æ®µä¸ºå…·ä½“çš„Dateå¯¹è±¡
            const result = [];
            const cstYear = pdtDate.getFullYear();
            const cstMonth = pdtDate.getMonth();
            const cstDay = pdtDate.getDate();
            
            for (let slot of timeSlots) {
                let startTime, endTime;
                
                if (slot.isOvernight) {
                    // è·¨å¤©æ—¶é—´æ®µï¼šå¼€å§‹æ—¶é—´åœ¨å½“å‰CSTæ—¥ï¼Œç»“æŸæ—¶é—´åœ¨æ¬¡æ—¥
                    startTime = new Date(cstYear, cstMonth, cstDay, slot.startHour, slot.startMinute);
                    endTime = new Date(cstYear, cstMonth, cstDay + 1, slot.endHour, slot.endMinute);
                } else {
                    // æ™®é€šæ—¶é—´æ®µ
                    startTime = new Date(cstYear, cstMonth, cstDay, slot.startHour, slot.startMinute);
                    endTime = new Date(cstYear, cstMonth, cstDay, slot.endHour, slot.endMinute);
                    
                    // å¦‚æœç»“æŸæ—¶é—´å°äºå¼€å§‹æ—¶é—´ï¼Œè¯´æ˜è·¨å¤©
                    if (endTime < startTime) {
                        endTime.setDate(endTime.getDate() + 1);
                    }
                }
                
                result.push({
                    startTime: startTime,
                    endTime: endTime
                });
            }
            
            return result;
        }

        // ä¿®å¤åçš„å‡½æ•°ï¼šæ£€æŸ¥ç ´æ™“çº¢çŸ³äº‹ä»¶æ˜¯å¦åœ¨æ´»åŠ¨æ—¶é—´æ®µ
        function isDawnRedstoneActive(now) {
            const pdtDate = getPDTDateFromCST(now);
            const timeSlots = getDawnRedstoneTimeSlots(pdtDate);
            
            for (let slot of timeSlots) {
                if (now >= slot.startTime && now < slot.endTime) {
                    return slot;
                }
            }
            
            return null;
        }

        // ä¿®å¤åçš„å‡½æ•°ï¼šè®¡ç®—ç ´æ™“çº¢çŸ³äº‹ä»¶çš„ä¸‹ä¸€æ¬¡å‘ç”Ÿæ—¶é—´
        function getNextDawnRedstoneOccurrence(now) {
            // é¦–å…ˆæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„äº‹ä»¶
            const currentActiveInfo = isDawnRedstoneActive(now);
            if (currentActiveInfo) {
                return currentActiveInfo.startTime;
            }
            
            // è·å–å½“å‰åŒ—äº¬æ—¶é—´å¯¹åº”çš„PDTæ—¥æœŸ
            const currentPDTDate = getPDTDateFromCST(now);
            
            // æ£€æŸ¥å½“å‰PDTæ—¥å†…çš„æ‰€æœ‰æ—¶é—´æ®µï¼ˆæŒ‰æ­£ç¡®é¡ºåºï¼‰
            const timeSlots = getDawnRedstoneTimeSlots(currentPDTDate);
            
            for (let slot of timeSlots) {
                if (slot.startTime > now) {
                    return slot.startTime;
                }
            }
            
            // å¦‚æœå½“å‰PDTæ—¥å†…æ²¡æœ‰æ‰¾åˆ°ï¼Œæ£€æŸ¥æœªæ¥7å¤©
            let checkDate = new Date(currentPDTDate);
            for (let i = 1; i <= 7; i++) {
                checkDate.setDate(checkDate.getDate() + 1);
                checkDate.setHours(0, 0, 0, 0);
                
                const nextSlots = getDawnRedstoneTimeSlots(checkDate);
                if (nextSlots.length > 0) {
                    return nextSlots[0].startTime; // è¿”å›ç¬¬ä¸€ä¸ªæ—¶é—´æ®µ
                }
            }
            
            // å¦‚æœ7å¤©å†…æ²¡æ‰¾åˆ°ï¼Œè¿”å›ä¸€ä¸ªè¾ƒè¿œçš„æœªæ¥æ—¶é—´
            return new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        }
        
        // äº‹ä»¶æ•°æ®
        let tasks = [
            {
                id: 1,
                name: "å¥¶å¥¶é¥­",
                startDate: getTodayDate(),
                startTime: "15:35",
                displayThreshold: 10,
                displayThresholdUnit: "minute",
                priority: "medium",
                recurrence: {
                    type: "custom",
                    count: 2,
                    unit: "hour",
                    duration: 10,
                    durationUnit: "minute"
                }
            },
            {
                id: 2,
                name: "é—´æ­‡æ³‰",
                startDate: getTodayDate(),
                startTime: "15:05",
                displayThreshold: 10,
                displayThresholdUnit: "minute",
                priority: "medium",
                recurrence: {
                    type: "custom",
                    count: 2,
                    unit: "hour",
                    duration: 10,
                    durationUnit: "minute"
                }
            },
            {
                id: 3,
                name: "æµ·é¾Ÿ",
                startDate: getTodayDate(),
                startTime: "15:50",
                displayThreshold: 10,
                displayThresholdUnit: "minute",
                priority: "medium",
                recurrence: {
                    type: "custom",
                    count: 2,
                    unit: "hour",
                    duration: 10,
                    durationUnit: "minute"
                }
            },
            {
                id: 4,
                name: "ğŸ”„çŒ®ç¥­ é‡ç½®â†» â™º â™»  ğŸ—˜ âŸ³ ğŸ”„",
                startDate: getTodayDate(),
                startTime: "15:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "weekly",
                    weekdays: [0],
                    duration: 5,
                    durationUnit: "minute"
                }
            },
            {
                id: 5,
                name: "æ¯æ—¥ é‡ç½®",
                startDate: getTodayDate(),
                startTime: "15:00",
                displayThreshold: 60,
                displayThresholdUnit: "minute",
                priority: "high",
                recurrence: {
                    type: "daily",
                    duration: 5,
                    durationUnit: "minute"
                }
            },
            {
                id: 6,
                name: "AURORA",
                startDate: getTodayDate(),
                startTime: "15:10",
                displayThreshold: 30,
                displayThresholdUnit: "minute",
                priority: "low",
                recurrence: {
                    type: "custom",
                    count: 4,
                    unit: "hour",
                    duration: 50,
                    durationUnit: "minute"
                }
            },
            {
                id: 7,
                name: "å…ˆç¥–å¤åˆ»",
                startDate: "2025-10-09",
                startTime: "15:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "custom",
                    count: 2,
                    unit: "week",
                    duration: 10,
                    durationUnit: "minute"
                }
            },
            {
                id: 8,
                name: "ç©ºé—´ç«™",
                startDate: getTodayDate(),
                startTime: "15:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "weekly",
                    weekdays: [4],
                    duration: 5,
                    durationUnit: "hour"
                }
            },
            {
                id: 9,
                name: "è¿å¾™å­£",
                startDate: "2025-10-20",
                startTime: "15:00",
                displayThreshold: 7,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "none",
                    duration: 76,
                    durationUnit: "day"
                }
            },
            {
                id: 10,
                name: "ä¸‡åœ£èŠ‚",
                startDate: "2025-10-27",
                startTime: "15:00",
                displayThreshold: 7,
                displayThresholdUnit: "day",
                priority: "none",
                recurrence: {
                    type: "none",
                    duration: 3,
                    durationUnit: "week"
                }
            },
            {
                id: 12,
                name: "å¤åˆ» å…¬å¸ƒ",
                startDate: "2025-10-18",
                startTime: "02:00",
                displayThreshold: 12,
                displayThresholdUnit: "hour",
                priority: "low",
                recurrence: {
                    type: "custom",
                    count: 2,
                    unit: "week",
                    duration: 1,
                    durationUnit: "day"
                }
            },
            {
                id: 18,
                name: "å®¶å…· è½®æ¢",
                startDate:"2025-10-14",
                startTime: "15:00",
                displayThreshold: 1,
                displayThresholdUnit: "day",
                priority: "low",
                recurrence: {
                    type: "weekly",
                    weekdays: [1],
                    duration: 5,
                    durationUnit: "minute"
                }
            },
            // ä¿®å¤ï¼šç ´æ™“çº¢çŸ³äº‹ä»¶åç§°æ”¹ä¸º"ç ´æ™“ çº¢çŸ³"
            {
                id: 19,
                name: "ç ´æ™“ çº¢çŸ³",
                startDate: getTodayDate(),
                startTime: "22:48",
                displayThreshold: 8,
                displayThresholdUnit: "hour",
                priority: "high",
                recurrence: {
                    type: "custom_complex",
                    pattern: "dawn_redstone",
                    duration: 232,
                    durationUnit: "minute"
                }
            }
        ];

        // å½“å‰æ“ä½œçš„äº‹ä»¶ID
        let currentTaskId = null;

        // DOMå…ƒç´ 
        const currentTimeEl = document.getElementById('current-time');
        const taskCarousel = document.getElementById('task-carousel');
        const allTasksEl = document.getElementById('all-tasks');
        const allTasksListEl = document.getElementById('all-tasks-list');
        const appContainer = document.getElementById('app-container');
        const controlsContainer = document.getElementById('controls-container');
        const mainContextMenu = document.getElementById('main-context-menu');
        const taskContextMenu = document.getElementById('task-context-menu');
        const addTaskOption = document.getElementById('add-task-option');
        const editTaskOption = document.getElementById('edit-task-option');
        const deleteTaskOption = document.getElementById('delete-task-option');
        const taskModal = document.getElementById('task-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModal = document.getElementById('close-modal');
        const cancelTask = document.getElementById('cancel-task');
        const taskForm = document.getElementById('task-form');
        const taskIdInput = document.getElementById('task-id');
        const displayThresholdInput = document.getElementById('display-threshold');
        const displayThresholdUnitInput = document.getElementById('display-threshold-unit');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const closeDeleteModal = document.getElementById('close-delete-modal');
        const cancelDelete = document.getElementById('cancel-delete');
        const confirmDelete = document.getElementById('confirm-delete');
        const recurrenceTypeInput = document.getElementById('recurrence-type');
        const weeklyOptions = document.getElementById('weekly-options');
        const monthlyOptions = document.getElementById('monthly-options');
        const customOptions = document.getElementById('custom-options');
        const startDateInput = document.getElementById('start-date');
        const startTimeInput = document.getElementById('start-time');
        const intervalCountInput = document.getElementById('interval-count');
        const intervalUnitInput = document.getElementById('interval-unit');
        const taskDurationInput = document.getElementById('task-duration');
        const durationUnitInput = document.getElementById('duration-unit');
        const weekdayCheckboxes = document.querySelectorAll('input[name="weekday"]');
        const monthdayCheckboxes = document.querySelectorAll('input[name="monthday"]');
        const monthweekdayCheckboxes = document.querySelectorAll('input[name="monthweekday"]');
        const recurrenceOptions = document.querySelectorAll('.recurrence-option');
        const downloadBtn = document.getElementById('download-btn');
        const manualSaveBtn = document.getElementById('manual-save-btn');
        const lockIndicator = document.getElementById('lock-indicator');
        const emptyHoverArea = document.querySelector('.empty-hover-area');
        const previewCard = document.getElementById('preview-card');
        
        // åˆå§‹åŒ–æ—¥æœŸå’Œæ—¶é—´ä¸ºä»Šå¤©å’Œå½“å‰æ—¶é—´
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(':').slice(0, 2).join(':');
            
            startDateInput.value = dateStr;
            startTimeInput.value = timeStr;
            
            // åˆå§‹åŒ–é‡å¤é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            recurrenceOptions.forEach(option => {
                option.addEventListener('click', () => {
                    recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    const type = option.getAttribute('data-type');
                    recurrenceTypeInput.value = type;
                    showRecurrenceOptions(type);
                });
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¤–éƒ¨æ•°æ®å¹¶åŠ è½½
            const savedData = loadFromLocalStorage();
            if (savedData && savedData.tasks) {
                tasks = savedData.tasks;
            } else {
                // ä¿å­˜åˆå§‹ä»»åŠ¡åˆ—è¡¨
                saveToLocalStorage(tasks);
            }
            
            // åˆå§‹åŒ–ä¸‹è½½æŒ‰é’®äº‹ä»¶
            downloadBtn.addEventListener('click', downloadAsHtml);
            
            // åˆå§‹åŒ–æ‰‹åŠ¨ä¿å­˜æŒ‰é’®äº‹ä»¶
            manualSaveBtn.addEventListener('click', async () => {
                await saveToLocalStorage(tasks);
            });
            
            // åˆå§‹åŒ–æ‚¬åœç©ºç™½åŒºåŸŸç‚¹å‡»äº‹ä»¶ç”¨äºé”å®š
            emptyHoverArea.addEventListener('click', toggleListLock);
            
            // ä¿®å¤ï¼šä¸ºå³é”®èœå•é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            addTaskOption.addEventListener('click', (e) => {
                e.stopPropagation();
                showAddTaskModal();
            });

            editTaskOption.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentTaskId !== null) {
                    showEditTaskModal(currentTaskId);
                }
            });

            deleteTaskOption.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentTaskId !== null) {
                    showConfirmDeleteModal(currentTaskId);
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—é¢„è§ˆå¡ç‰‡
            document.addEventListener('click', (e) => {
                if (!previewCard.contains(e.target) && !e.target.closest('.future-task-item')) {
                    hidePreviewCard();
                }
            });
            
            // è·Ÿè¸ªé¼ æ ‡ç§»åŠ¨ä»¥å®ç°ä¸æ»‘è·Ÿéš
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                if (isPreviewVisible) {
                    updatePreviewCardPosition(mouseX, mouseY);
                }
            });
            
            // éªŒè¯æœ¬åœ°å­˜å‚¨æ˜¯å¦å¯ç”¨
            testLocalStorageAvailability();
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            updateCurrentTime();
            updateTasks();
        });
        
        // æ˜¾ç¤ºé¢„è§ˆå¡ç‰‡ - ä½¿ç”¨ç°æœ‰æ•°æ®ï¼Œæ— éœ€é‡æ–°è®¡ç®—
        function showPreviewCard(task, x, y) {
            // ä»å½“å‰æ˜¾ç¤ºçš„ä»»åŠ¡æ•°æ®ä¸­è·å–ä¿¡æ¯
            let currentTask = currentAllTasks.find(t => t.id === task.id);
            
            if (!currentTask) return;
            
            // ç”Ÿæˆé‡å¤æ–¹å¼æ–‡æœ¬
            let recurrenceText = "";
            if (currentTask.recurrence.type === "custom_complex" && currentTask.recurrence.pattern === "dawn_redstone") {
                recurrenceText = "ç ´æ™“çº¢çŸ³ç‰¹æ®Šè§„åˆ™";
            } else {
                switch(currentTask.recurrence.type) {
                    case "none":
                        recurrenceText = "ä¸é‡å¤";
                        break;
                    case "daily":
                        recurrenceText = "æ¯å¤©";
                        break;
                    case "weekly":
                        const dayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
                        const selectedDays = currentTask.recurrence.weekdays?.map(day => dayNames[day]).join(', ') || "";
                        recurrenceText = `æ¯å‘¨${selectedDays}`;
                        break;
                    case "monthly":
                        const monthDayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
                        if (currentTask.recurrence.weekdays && currentTask.recurrence.weekdays.length > 0) {
                            const selectedWeekDays = currentTask.recurrence.weekdays?.map(day => monthDayNames[day]).join(', ') || "";
                            recurrenceText = `æ¯æœˆ${selectedWeekDays}`;
                        } else if (currentTask.recurrence.days && currentTask.recurrence.days.length > 0) {
                            const selectedDays = currentTask.recurrence.days?.join(', ') || "";
                            recurrenceText = `æ¯æœˆ${selectedDays}æ—¥`;
                        }
                        break;
                    case "custom":
                        const unitNames = {
                            "minute": "åˆ†é’Ÿ",
                            "hour": "å°æ—¶",
                            "day": "å¤©",
                            "week": "å‘¨",
                            "month": "æœˆ"
                        };
                        recurrenceText = `æ¯${currentTask.recurrence.count}${unitNames[currentTask.recurrence.unit]}`;
                        break;
                }
            }
            
            // ç”ŸæˆæŒç»­æ—¶é—´æ–‡æœ¬
            const durationUnitNames = {
                "minute": "åˆ†é’Ÿ",
                "hour": "å°æ—¶",
                "day": "å¤©",
                "week": "å‘¨"
            };
            const durationText = `${currentTask.recurrence.duration}${durationUnitNames[currentTask.recurrence.durationUnit]}`;
            
            // ç”Ÿæˆæ—¶é—´èŒƒå›´æ–‡æœ¬
            const isToday = currentTask.startTime && currentTask.startTime.toLocaleDateString() === new Date().toLocaleDateString();
            const dateText = isToday ? 'ä»Šå¤©' : currentTask.startTime ? currentTask.startTime.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric', weekday: 'short'}) : '';
            const timeText = currentTask.startTime && currentTask.endTime ? 
                `${currentTask.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})} - ${currentTask.endTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}` : '';
            
            // ç”Ÿæˆæé†’æ–‡æœ¬
            const alertText = `æå‰${currentTask.displayThreshold} ${currentTask.displayThresholdUnit === 'minute' ? 'åˆ†é’Ÿ' : currentTask.displayThresholdUnit === 'hour' ? 'å°æ—¶' : currentTask.displayThresholdUnit === 'day' ? 'å¤©' : 'å‘¨'}æé†’`;
            
            // æ›´æ–°é¢„è§ˆå¡ç‰‡å†…å®¹
            document.getElementById('preview-priority').className = `w-2 h-2 rounded-full mr-2 bg-priority-${currentTask.priority}`;
            document.getElementById('preview-name').textContent = currentTask.name;
            
            const statusIndicator = currentTask.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            const statusTextClass = currentTask.status === "ongoing" ? "ongoing-text" : "";
            document.getElementById('preview-status').innerHTML = `${statusIndicator}<span class="${statusTextClass}">${currentTask.timeText}</span>`;
            
            document.getElementById('preview-recurrence').textContent = recurrenceText;
            document.getElementById('preview-duration').textContent = `æŒç»­ ${durationText}`;
            document.getElementById('preview-date').textContent = dateText;
            document.getElementById('preview-time').textContent = timeText;
            document.getElementById('preview-alert').textContent = alertText;
            
            // è®¾ç½®å¡ç‰‡ä½ç½®
            updatePreviewCardPosition(x, y);
            
            // æ˜¾ç¤ºå¡ç‰‡å¹¶æ·»åŠ é«˜äº®åŠ¨ç”»
            previewCard.classList.add('show', 'preview-highlight');
            currentPreviewTaskId = currentTask.id;
            isPreviewVisible = true;
        }
        
        // æ›´æ–°é¢„è§ˆå¡ç‰‡ä½ç½®ï¼ˆä¸æ»‘è·Ÿéšï¼‰
        function updatePreviewCardPosition(x, y) {
            const cardWidth = previewCard.offsetWidth;
            const cardHeight = previewCard.offsetHeight;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let finalX = x + 15;
            let finalY = y + 15;
            
            // ç¡®ä¿å¡ç‰‡ä¸ä¼šè¶…å‡ºè§†å£
            if (finalX + cardWidth > viewportWidth - 10) {
                finalX = x - cardWidth - 15;
            }
            if (finalY + cardHeight > viewportHeight - 10) {
                finalY = viewportHeight - cardHeight - 10;
            }
            
            // ç¡®ä¿å¡ç‰‡ä¸ä¼šè¶…å‡ºè§†å£é¡¶éƒ¨
            if (finalY < 10) {
                finalY = 10;
            }
            
            previewCard.style.left = `${finalX}px`;
            previewCard.style.top = `${finalY}px`;
        }
        
        // éšè—é¢„è§ˆå¡ç‰‡
        function hidePreviewCard() {
            previewCard.classList.remove('show', 'preview-highlight');
            currentPreviewTaskId = null;
            isPreviewVisible = false;
        }
        
        // åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨é”å®šçŠ¶æ€
        function toggleListLock() {
            isListLocked = !isListLocked;
            const icon = lockIndicator.querySelector('i');
            
            if (isListLocked) {
                icon.classList.remove('fa-unlock');
                icon.classList.add('fa-lock');
                lockIndicator.classList.add('locked');
                allTasksEl.style.maxHeight = '500px';
                showNotification('ä»»åŠ¡åˆ—è¡¨å·²é”å®šæ˜¾ç¤º');
            } else {
                icon.classList.remove('fa-lock');
                icon.classList.add('fa-unlock');
                lockIndicator.classList.remove('locked');
                allTasksEl.style.maxHeight = '0';
                showNotification('ä»»åŠ¡åˆ—è¡¨å·²è§£é”');
            }
        }
        
        // æµ‹è¯•æœ¬åœ°å­˜å‚¨æ˜¯å¦å¯ç”¨
        function testLocalStorageAvailability() {
            try {
                const testKey = 'test_local_storage_availability_' + Math.random();
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
            } catch (e) {
                console.error('LocalStorage is not available:', e);
                showNotification('æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨ï¼Œå»ºè®®ä½¿ç”¨ä¸‹è½½åŠŸèƒ½ä¿å­˜æ•°æ®', true);
            }
        }
        
        // è½¬æ¢æ—¶é—´å•ä½ä¸ºæ¯«ç§’
        function convertToMilliseconds(value, unit) {
            const units = {
                minute: 60 * 1000,
                hour: 60 * 60 * 1000,
                day: 24 * 60 * 60 * 1000,
                week: 7 * 24 * 60 * 60 * 1000,
                month: 30 * 24 * 60 * 60 * 1000
            };
            return value * (units[unit] || units.minute);
        }
        
        // è½¬æ¢æ¯«ç§’ä¸ºæœ€é€‚åˆçš„å•ä½
        function convertFromMilliseconds(ms) {
            if (ms >= 30 * 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (30 * 24 * 60 * 60 * 1000)), unit: 'month', text: 'æœˆ' };
            } else if (ms >= 7 * 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (7 * 24 * 60 * 60 * 1000)), unit: 'week', text: 'å‘¨' };
            } else if (ms >= 24 * 60 * 60 * 1000) {
                return { value: Math.round(ms / (24 * 60 * 60 * 1000)), unit: 'day', text: 'å¤©' };
            } else if (ms >= 60 * 60 * 1000) {
                return { value: Math.round(ms / (60 * 60 * 1000)), unit: 'hour', text: 'å°æ—¶' };
            } else {
                return { value: Math.round(ms / (60 * 1000)), unit: 'minute', text: 'åˆ†é’Ÿ' };
            }
        }

        // æ ¼å¼åŒ–å€’è®¡æ—¶æ˜¾ç¤º
        function formatCountdown(ms) {
            if (ms < 0) return "å·²å¼€å§‹";
            
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            if (days > 0) {
                return `${days}å¤©${hours}æ—¶`;
            } else if (hours > 0) {
                return `${hours}æ—¶${minutes}åˆ†`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${seconds}ç§’`;
            } else {
                return `${seconds}ç§’`;
            }
        }

        // è½®æ’­çŠ¶æ€
        let currentSlide = 0;
        let visibleTasks = [];

        // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
        function updateCurrentTime() {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // ä¿®å¤ï¼šè®¡ç®—äº‹ä»¶çš„ä¸‹ä¸€æ¬¡å‘ç”Ÿæ—¶é—´ - å¢å¼ºç‰ˆæœ¬
        function getNextOccurrence(task, now) {
            try {
                // ç¡®ä¿ now æ˜¯æœ‰æ•ˆçš„ Date å¯¹è±¡
                if (!(now instanceof Date) || isNaN(now)) {
                    now = new Date();
                }

                // å¤„ç†ç ´æ™“çº¢çŸ³å¤æ‚äº‹ä»¶
                if (task.recurrence.type === "custom_complex" && task.recurrence.pattern === "dawn_redstone") {
                    const nextTime = getNextDawnRedstoneOccurrence(now);
                    if (!(nextTime instanceof Date) || isNaN(nextTime)) {
                        throw new Error('ç ´æ™“çº¢çŸ³æ—¶é—´è®¡ç®—å¤±è´¥');
                    }
                    return nextTime;
                }
                
                // è§£æå¼€å§‹æ—¶é—´
                const [startHour, startMinute] = task.startTime.split(':').map(Number);
                if (isNaN(startHour) || isNaN(startMinute)) {
                    throw new Error('æ— æ•ˆçš„å¼€å§‹æ—¶é—´æ ¼å¼');
                }
                
                let nextTime = new Date(now);
                nextTime.setHours(startHour, startMinute, 0, 0);
                
                if (task.recurrence.type === "weekly") {
                    const todayWeekday = now.getDay();
                    let daysToAdd = 0;
                    let found = false;
                    
                    if (task.recurrence.weekdays && task.recurrence.weekdays.length > 0) {
                        for (let i = 0; i < 7; i++) {
                            const checkDay = (todayWeekday + i) % 7;
                            if (task.recurrence.weekdays.includes(checkDay)) {
                                daysToAdd = i;
                                found = true;
                                break;
                            }
                        }
                        
                        if (!found) {
                            daysToAdd = 7;
                        }
                        
                        nextTime.setDate(nextTime.getDate() + daysToAdd);
                        
                        const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                        
                        const sameDay = nextTime.toDateString() === now.toDateString();
                        if (sameDay && nextTime <= now && now < nextTime.getTime() + durationMs) {
                            return new Date(nextTime);
                        }
                        
                        if (nextTime <= now) {
                            nextTime.setDate(nextTime.getDate() + 7);
                        }
                    }
                    
                    return nextTime;
                }
                
                if (task.recurrence.type === "monthly") {
                    if (task.recurrence.weekdays && task.recurrence.weekdays.length > 0) {
                        const targetWeekday = task.recurrence.weekdays[0];
                        let currentMonth = now.getMonth();
                        let currentYear = now.getFullYear();
                        let candidateDate = new Date(currentYear, currentMonth, 1);
                        
                        while (candidateDate.getDay() !== targetWeekday) {
                            candidateDate.setDate(candidateDate.getDate() + 1);
                        }
                        
                        candidateDate.setHours(startHour, startMinute, 0, 0);
                        
                        if (candidateDate < now) {
                            candidateDate.setMonth(candidateDate.getMonth() + 1);
                            while (candidateDate.getDay() !== targetWeekday) {
                                candidateDate.setDate(candidateDate.getDate() + 1);
                            }
                        }
                        
                        return candidateDate;
                    } 
                    else if (task.recurrence.days && task.recurrence.days.length > 0) {
                        const targetDay = parseInt(task.recurrence.days[0]);
                        let candidateDate = new Date(now.getFullYear(), now.getMonth(), targetDay, startHour, startMinute);
                        
                        if (candidateDate < now) {
                            candidateDate.setMonth(candidateDate.getMonth() + 1);
                            if (candidateDate.getDate() !== targetDay) {
                                candidateDate.setDate(0);
                            }
                        }
                        
                        return candidateDate;
                    }
                }
                
                // è§£æå¼€å§‹æ—¥æœŸ
                const [startYear, startMonth, startDay] = task.startDate.split('-').map(Number);
                if (isNaN(startYear) || isNaN(startMonth) || isNaN(startDay)) {
                    throw new Error('æ— æ•ˆçš„å¼€å§‹æ—¥æœŸæ ¼å¼');
                }
                
                const initialStart = new Date(startYear, startMonth - 1, startDay, startHour, startMinute);
                
                if (task.recurrence.type !== "none") {
                    let intervalMs;
                    switch(task.recurrence.type) {
                        case "daily":
                            intervalMs = 24 * 60 * 60 * 1000;
                            break;
                        case "custom":
                            intervalMs = convertToMilliseconds(task.recurrence.count, task.recurrence.unit);
                            break;
                        default:
                            intervalMs = 24 * 60 * 60 * 1000;
                    }
                    
                    const timeDiff = now - initialStart;
                    const intervals = Math.floor(timeDiff / intervalMs);
                    
                    const lastOccurrence = new Date(initialStart.getTime() + intervals * intervalMs);
                    
                    const durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                    
                    if (now <= lastOccurrence.getTime() + durationMs) {
                        return lastOccurrence;
                    }
                    
                    return new Date(lastOccurrence.getTime() + intervalMs);
                }
                
                if (initialStart > now) {
                    return new Date(initialStart);
                }
                
                return new Date(initialStart);
            } catch (e) {
                console.error('è®¡ç®—ä¸‹æ¬¡å‘ç”Ÿæ—¶é—´å‡ºé”™:', task.name, e);
                // è¿”å›ä¸€ä¸ªå®‰å…¨çš„é»˜è®¤æ—¶é—´ï¼ˆ1å°æ—¶åï¼‰
                return new Date(now.getTime() + 60 * 60 * 1000);
            }
        }

        // ä¿®å¤ï¼šè·å–äº‹ä»¶çŠ¶æ€ä¿¡æ¯ - å¢å¼ºç‰ˆæœ¬
        function getTaskStatus(task, now) {
            try {
                // ç¡®ä¿ now æ˜¯æœ‰æ•ˆçš„ Date å¯¹è±¡
                if (!(now instanceof Date) || isNaN(now)) {
                    now = new Date();
                }

                const nextStart = getNextOccurrence(task, now);
                
                // ç¡®ä¿ nextStart æ˜¯æœ‰æ•ˆçš„ Date å¯¹è±¡
                if (!(nextStart instanceof Date) || isNaN(nextStart)) {
                    throw new Error('æ— æ•ˆçš„ä¸‹æ¬¡å¼€å§‹æ—¶é—´');
                }
                
                let durationMs, endTime;
                if (task.recurrence.type === "custom_complex" && task.recurrence.pattern === "dawn_redstone") {
                    const activeInfo = isDawnRedstoneActive(now);
                    if (activeInfo) {
                        endTime = activeInfo.endTime;
                        durationMs = endTime - activeInfo.startTime;
                    } else {
                        durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                        endTime = new Date(nextStart.getTime() + durationMs);
                    }
                } else {
                    durationMs = convertToMilliseconds(task.recurrence.duration, task.recurrence.durationUnit);
                    endTime = new Date(nextStart.getTime() + durationMs);
                }
                
                // ç¡®ä¿ endTime æ˜¯æœ‰æ•ˆçš„ Date å¯¹è±¡
                if (!(endTime instanceof Date) || isNaN(endTime)) {
                    throw new Error('æ— æ•ˆçš„ç»“æŸæ—¶é—´');
                }
                
                const thresholdMs = convertToMilliseconds(task.displayThreshold, task.displayThresholdUnit);
                const displayStartTime = new Date(nextStart.getTime() - thresholdMs);
                const displayEndTime = new Date(endTime);
                
                const isInDisplayRange = now >= displayStartTime && now <= displayEndTime;
                const isOngoing = now >= nextStart && now < endTime;
                const timeUntilStart = nextStart - now;
                
                if (task.recurrence.type === "none" && now > displayEndTime) {
                    return {
                        status: "completed",
                        timeText: "å·²å®Œæˆ",
                        countdownMs: 0,
                        countdownText: "å·²å®Œæˆ",
                        minutes: Infinity,
                        startTime: nextStart,
                        endTime: endTime,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime
                    };
                }
                
                if (isOngoing) {
                    const timeLeft = endTime - now;
                    const converted = convertFromMilliseconds(timeLeft);
                    return {
                        status: "ongoing",
                        timeText: `æ­£åœ¨è¿›è¡Œ`,
                        countdownMs: timeLeft,
                        countdownText: formatCountdown(timeLeft),
                        minutes: Math.ceil(timeLeft / (1000 * 60)),
                        startTime: nextStart,
                        endTime: endTime,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime
                    };
                } else if (isInDisplayRange) {
                    const converted = convertFromMilliseconds(timeUntilStart);
                    return {
                        status: "upcoming",
                        timeText: `${converted.value}${converted.text}åå¼€å§‹`,
                        countdownMs: timeUntilStart,
                        countdownText: formatCountdown(timeUntilStart),
                        minutes: Math.ceil(timeUntilStart / (1000 * 60)),
                        startTime: nextStart,
                        endTime: endTime,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime
                    };
                } else {
                    const converted = convertFromMilliseconds(timeUntilStart);
                    return {
                        status: "future",
                        timeText: `${converted.value}${converted.text}åå¼€å§‹`,
                        countdownMs: timeUntilStart,
                        countdownText: formatCountdown(timeUntilStart),
                        minutes: Math.ceil(timeUntilStart / (1000 * 60)),
                        startTime: nextStart,
                        endTime: endTime,
                        displayStartTime: displayStartTime,
                        displayEndTime: displayEndTime
                    };
                }
            } catch (e) {
                console.error('è®¡ç®—ä»»åŠ¡çŠ¶æ€å‡ºé”™:', task.name, e);
                // è¿”å›ä¸€ä¸ªå®‰å…¨çš„é»˜è®¤çŠ¶æ€
                const defaultTime = new Date();
                return {
                    status: "future",
                    timeText: "æ—¶é—´è®¡ç®—ä¸­",
                    countdownMs: 0,
                    countdownText: "--",
                    minutes: Infinity,
                    startTime: defaultTime,
                    endTime: new Date(defaultTime.getTime() + 60 * 60 * 1000), // 1å°æ—¶å
                    displayStartTime: defaultTime,
                    displayEndTime: new Date(defaultTime.getTime() + 60 * 60 * 1000)
                };
            }
        }

        // è¿‡æ»¤å‡ºéœ€è¦æ˜¾ç¤ºçš„äº‹ä»¶
        function getVisibleTasks() {
            const now = new Date();
            return tasks
                .map(task => {
                    const status = getTaskStatus(task, now);
                    return {
                        ...task,
                        ...status
                    };
                })
                .filter(task => {
                    if (task.priority === "none") {
                        return false;
                    }
                    
                    return task.status !== "completed" && 
                           (task.status === "ongoing" || task.status === "upcoming");
                })
                .sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    
                    if (a.status === "ongoing" && b.status !== "ongoing") return -1;
                    if (a.status !== "ongoing" && b.status === "ongoing") return 1;
                    
                    return a.minutes - b.minutes;
                });
        }

        // è·å–æ‰€æœ‰äº‹ä»¶ï¼ˆç”¨äºæ‚¬åœæ˜¾ç¤ºï¼‰- ä¿®å¤ç‰ˆæœ¬
        function getAllTasksWithStatus() {
            const now = new Date();
            return tasks
                .map(task => {
                    try {
                        const status = getTaskStatus(task, now);
                        return {
                            ...task,
                            ...status
                        };
                    } catch (e) {
                        console.error('è®¡ç®—ä»»åŠ¡çŠ¶æ€å‡ºé”™:', task.name, e);
                        // è¿”å›ä¸€ä¸ªåŸºæœ¬çŠ¶æ€ï¼Œé¿å…é¢„è§ˆåŠŸèƒ½å¤±æ•ˆ
                        return {
                            ...task,
                            status: "future",
                            timeText: "æ—¶é—´è®¡ç®—ä¸­",
                            countdownMs: 0,
                            countdownText: "--",
                            minutes: Infinity,
                            startTime: new Date(),
                            endTime: new Date(),
                            displayStartTime: new Date(),
                            displayEndTime: new Date()
                        };
                    }
                })
                .filter(task => task.status !== "completed")
                .sort((a, b) => {
                    if (a.priority === "none" && b.priority !== "none") return 1;
                    if (a.priority !== "none" && b.priority === "none") return -1;
                    
                    const priorityOrder = { high: 3, medium: 2, low: 1, none: 0 };
                    
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    
                    return (a.startTime || new Date()) - (b.startTime || new Date());
                });
        }

        // åˆ›å»ºäº‹ä»¶å…ƒç´ 
        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            const baseClass = "task-item p-4 rounded-xl mb-3 task-transition bg-dark-bg shadow-sm mx-auto max-w-md";
            
            taskEl.className = baseClass;
            taskEl.dataset.taskId = task.id;
            
            let recurrenceText = "";
            if (task.recurrence.type === "custom_complex" && task.recurrence.pattern === "dawn_redstone") {
                recurrenceText = "ç ´æ™“çº¢çŸ³ç‰¹æ®Šè§„åˆ™";
            } else {
                switch(task.recurrence.type) {
                    case "none":
                        recurrenceText = "ä¸é‡å¤";
                        break;
                    case "daily":
                        recurrenceText = "æ¯å¤©";
                        break;
                    case "weekly":
                        const dayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
                        const selectedDays = task.recurrence.weekdays?.map(day => dayNames[day]).join(', ') || "";
                        recurrenceText = `æ¯å‘¨${selectedDays}`;
                        break;
                    case "monthly":
                        const monthDayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
                        if (task.recurrence.weekdays && task.recurrence.weekdays.length > 0) {
                            const selectedWeekDays = task.recurrence.weekdays?.map(day => monthDayNames[day]).join(', ') || "";
                            recurrenceText = `æ¯æœˆ${selectedWeekDays}`;
                        } else if (task.recurrence.days && task.recurrence.days.length > 0) {
                            const selectedDays = task.recurrence.days?.join(', ') || "";
                            recurrenceText = `æ¯æœˆ${selectedDays}æ—¥`;
                        }
                        break;
                    case "custom":
                        const unitNames = {
                            "minute": "åˆ†é’Ÿ",
                            "hour": "å°æ—¶",
                            "day": "å¤©",
                            "week": "å‘¨",
                            "month": "æœˆ"
                        };
                        recurrenceText = `æ¯${task.recurrence.count}${unitNames[task.recurrence.unit]}`;
                        break;
                }
            }
            
            const durationUnitNames = {
                "minute": "åˆ†é’Ÿ",
                "hour": "å°æ—¶",
                "day": "å¤©",
                "week": "å‘¨"
            };
            const durationText = `${task.recurrence.duration}${durationUnitNames[task.recurrence.durationUnit]}`;
            
            const isToday = task.startTime.toLocaleDateString() === new Date().toLocaleDateString();
            const dateText = isToday ? 'ä»Šå¤©' : task.startTime.toLocaleDateString('zh-CN', {month: 'short', day: 'numeric', weekday: 'short'});
            
            const ongoingIndicator = task.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            
            const countdownBadge = `<span class="countdown ml-2">${task.countdownText}</span>`;
            
            const timeTextClass = task.status === "ongoing" ? "ongoing-text" : "";
            
            taskEl.innerHTML = `
                <div class="flex justify-between items-center task-title">
                    <div class="font-medium text-dark-text flex items-center">
                        <span class="w-2 h-2 rounded-full mr-2 bg-priority-${task.priority}"></span>
                        ${task.name}
                    </div>
                    <div class="text-sm text-primary flex items-center">
                        ${ongoingIndicator}<span class="${timeTextClass}">${task.timeText}</span>${countdownBadge}
                    </div>
                </div>
                <div class="text-xs text-dark-textSecondary task-meta">
                    <span class="task-meta-item"><i class="fa fa-repeat mr-1 opacity-70"></i>${recurrenceText}</span>
                    <span class="task-meta-item"><i class="fa fa-clock-o mr-1 opacity-70"></i>æŒç»­ ${durationText}</span>
                    <span class="task-meta-item"><i class="fa fa-calendar mr-1 opacity-70"></i>${dateText}</span>
                    <span class="task-meta-item"><i class="fa fa-hourglass-start mr-1 opacity-70"></i>${task.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})} - ${task.endTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
                </div>
            `;
            
            // ç§»é™¤äº†è½®æ’­äº‹ä»¶çš„é¢„è§ˆäº¤äº’
            
            taskEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                hideAllContextMenus();
                
                currentTaskId = task.id;
                const x = e.clientX;
                const y = e.clientY;
                
                taskContextMenu.style.left = `${x}px`;
                taskContextMenu.style.top = `${y}px`;
                taskContextMenu.classList.remove('hidden');
            });
            
            return taskEl;
        }

        // åˆ›å»ºç¼©ç•¥äº‹ä»¶å…ƒç´  - ä¿®å¤ç‰ˆæœ¬
        function createMiniTaskElement(task) {
            const taskEl = document.createElement('div');
            const baseClass = "flex justify-between items-center p-2 rounded-lg bg-dark-bg border border-gray-700 cursor-pointer hover:bg-dark-hover future-task-item";
            
            taskEl.className = baseClass;
            taskEl.dataset.taskId = task.id;
            
            const ongoingIndicator = task.status === "ongoing" ? 
                '<span class="inline-block w-2 h-2 bg-priority-high rounded-full ongoing-indicator mr-1"></span>' : '';
            
            const countdownBadge = task.countdownText ? `<span class="countdown ml-2">${task.countdownText}</span>` : '';
            
            const timeTextClass = task.status === "ongoing" ? "ongoing-text" : "";
            
            // å®‰å…¨åœ°å¤„ç†æ—¶é—´æ˜¾ç¤º
            let timeDisplay = 'æ—¶é—´è®¡ç®—ä¸­';
            if (task.startTime && task.startTime instanceof Date && !isNaN(task.startTime)) {
                timeDisplay = task.status === 'ongoing' ? 'è¿›è¡Œä¸­' : 
                             task.startTime.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            }
            
            taskEl.innerHTML = `
                <div class="flex items-center flex-1 min-w-0">
                    <span class="w-2 h-2 rounded-full mr-2 bg-priority-${task.priority}"></span>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm truncate">${task.name}</div>
                        <div class="text-xs text-primary flex items-center">
                            ${ongoingIndicator}<span class="${timeTextClass}">${task.timeText || 'å³å°†å¼€å§‹'}</span>${countdownBadge}
                        </div>
                    </div>
                </div>
                <div class="text-xs text-dark-textSecondary whitespace-nowrap ml-2">
                    ${timeDisplay}
                </div>
            `;
            
            // ä¸ºæœªæ¥äº‹ä»¶åˆ—è¡¨ä¸­çš„ä»»åŠ¡æ·»åŠ é¢„è§ˆäº¤äº’
            addPreviewInteractionToFutureTask(taskEl, task);
            
            taskEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                hideAllContextMenus();
                
                currentTaskId = task.id;
                const x = e.clientX;
                const y = e.clientY;
                
                taskContextMenu.style.left = `${x}px`;
                taskContextMenu.style.top = `${y}px`;
                taskContextMenu.classList.remove('hidden');
            });
            
            return taskEl;
        }

        // ä¸“é—¨ä¸ºæœªæ¥äº‹ä»¶åˆ—è¡¨æ·»åŠ é¢„è§ˆäº¤äº’
        function addPreviewInteractionToFutureTask(element, task) {
            let previewTimer = null;
            
            element.addEventListener('mouseenter', (e) => {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (previewTimer) {
                    clearTimeout(previewTimer);
                }
                
                // è®¾ç½®æ–°çš„é¢„è§ˆæ˜¾ç¤ºå®šæ—¶å™¨
                previewTimer = setTimeout(() => {
                    showPreviewCard(task, e.clientX, e.clientY);
                }, 2300);
            });
            
            element.addEventListener('mouseleave', () => {
                // æ¸…é™¤å®šæ—¶å™¨
                if (previewTimer) {
                    clearTimeout(previewTimer);
                    previewTimer = null;
                }
                hidePreviewCard();
            });
            
            element.addEventListener('mousemove', (e) => {
                if (isPreviewVisible && currentPreviewTaskId === task.id) {
                    updatePreviewCardPosition(e.clientX, e.clientY);
                }
            });
        }

        // æ›´æ–°äº‹ä»¶æ˜¾ç¤º
        function updateTasks() {
            currentVisibleTasks = getVisibleTasks();
            currentAllTasks = getAllTasksWithStatus();
            const hasVisibleContent = currentVisibleTasks.length > 0 || currentAllTasks.length > 0;
            
            taskCarousel.innerHTML = '';
            
            if (currentVisibleTasks.length === 0) {
                taskCarousel.innerHTML = `
                    <div class="text-center py-4 text-dark-textSecondary">
                        ç›®å‰æ²¡æœ‰å³å°†å¼€å§‹çš„äº‹ä»¶
                    </div>
                `;
            } else {
                currentVisibleTasks.forEach(task => {
                    const taskEl = createTaskElement(task);
                    taskCarousel.appendChild(taskEl);
                });
                
                currentSlide = 0;
                updateCarouselPosition();
            }
            
            updateAllTasksList();
            adjustContainerSize(hasVisibleContent);
        }

        // æ›´æ–°æ‰€æœ‰äº‹ä»¶åˆ—è¡¨ - ä¿®å¤ç‰ˆæœ¬
        function updateAllTasksList() {
            const allTasks = getAllTasksWithStatus();
            allTasksListEl.innerHTML = '';
            
            if (allTasks.length === 0) {
                allTasksListEl.innerHTML = `
                    <div class="text-center py-4 text-dark-textSecondary text-sm">
                        æš‚æ— æœªæ¥äº‹ä»¶
                    </div>
                `;
                return;
            }
            
            allTasks.forEach(task => {
                const taskEl = createMiniTaskElement(task);
                allTasksListEl.appendChild(taskEl);
            });
        }

        // è°ƒæ•´å®¹å™¨å¤§å°å’Œæ ·å¼
        function adjustContainerSize(hasContent) {
            if (hasContent) {
                appContainer.classList.remove('app-compact');
                appContainer.classList.add('app-expanded');
                controlsContainer.classList.remove('opacity-0', 'pointer-events-none', 'h-0');
                
                const height = currentVisibleTasks.length > 0 ? 
                    120 + currentVisibleTasks.length * 100 : 120;
                
                appContainer.style.minHeight = `${height}px`;
            } else {
                appContainer.classList.remove('app-expanded');
                appContainer.classList.add('app-compact');
                controlsContainer.classList.add('opacity-0', 'pointer-events-none', 'h-0');
                appContainer.style.minHeight = '120px';
            }
        }

        // æ›´æ–°è½®æ’­ä½ç½®
        function updateCarouselPosition() {
            if (currentVisibleTasks.length <= 1) return;
            
            const slideHeight = 100;
            taskCarousel.style.transform = `translateY(-${currentSlide * slideHeight}px)`;
        }

        // æ˜¾ç¤ºå¯¹åº”çš„é‡å¤é€‰é¡¹é¢æ¿
        function showRecurrenceOptions(type) {
            weeklyOptions.classList.add('hidden');
            monthlyOptions.classList.add('hidden');
            customOptions.classList.add('hidden');
            
            if (type === 'weekly') {
                weeklyOptions.classList.remove('hidden');
            } else if (type === 'monthly') {
                monthlyOptions.classList.remove('hidden');
            } else if (type === 'custom') {
                customOptions.classList.remove('hidden');
            }
        }

        // éªŒè¯è¡¨å•æ•°æ®
        function validateFormData(recurrenceType) {
            if (recurrenceType === 'weekly') {
                const checkedDays = Array.from(weekdayCheckboxes).filter(cb => cb.checked);
                if (checkedDays.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ˜ŸæœŸå‡ ');
                    return false;
                }
            } else if (recurrenceType === 'monthly') {
                const checkedDays = Array.from(monthdayCheckboxes).filter(cb => cb.checked);
                const checkedWeekDays = Array.from(monthweekdayCheckboxes).filter(cb => cb.checked);
                if (checkedDays.length === 0 && checkedWeekDays.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¥æœŸæˆ–æ˜ŸæœŸå‡ ');
                    return false;
                }
            } else if (recurrenceType === 'custom') {
                const count = parseInt(intervalCountInput.value) || 0;
                if (count < 1) {
                    alert('é—´éš”è®¡æ•°å¿…é¡»å¤§äº0');
                    return false;
                }
            }
            
            const threshold = parseInt(displayThresholdInput.value) || 0;
            if (threshold < 1) {
                alert('æå‰æé†’æ—¶é—´å¿…é¡»å¤§äº0');
                return false;
            }
            
            const duration = parseInt(taskDurationInput.value) || 0;
            if (duration < 1) {
                alert('æŒç»­æ—¶é—´å¿…é¡»å¤§äº0');
                return false;
            }
            
            return true;
        }

        // æ·»åŠ æ–°äº‹ä»¶
        async function addNewTask(taskData) {
            const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
            
            let newTask = {
                id: newId,
                name: taskData.name,
                startDate: taskData.startDate || new Date().toISOString().split('T')[0],
                startTime: taskData.startTime || new Date().toTimeString().split(':').slice(0, 2).join(':'),
                displayThreshold: parseInt(taskData.displayThreshold) || 10,
                displayThresholdUnit: taskData.displayThresholdUnit || "minute",
                priority: taskData.priority,
                recurrence: {
                    duration: parseInt(taskData.duration) || 10,
                    durationUnit: taskData.durationUnit || "minute",
                    type: taskData.recurrenceType
                }
            };
            
            switch(taskData.recurrenceType) {
                case "weekly":
                    newTask.recurrence.weekdays = taskData.weekdays ? 
                        taskData.weekdays.map(Number) : [1];
                    break;
                case "monthly":
                    if (taskData.monthweekdays && taskData.monthweekdays.length > 0) {
                        newTask.recurrence.weekdays = taskData.monthweekdays.map(Number);
                    } else if (taskData.monthdays && taskData.monthdays.length > 0) {
                        newTask.recurrence.days = taskData.monthdays.map(Number);
                    }
                    break;
                case "custom":
                    newTask.recurrence.count = parseInt(taskData.intervalCount) || 1;
                    newTask.recurrence.unit = taskData.intervalUnit || "day";
                    break;
            }
            
            tasks.push(newTask);
            const saveSuccess = await saveToLocalStorage(tasks);
            if (saveSuccess) {
                updateTasks();
            } else {
                tasks.pop();
                alert('æ·»åŠ äº‹ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ–°ç°æœ‰äº‹ä»¶
        async function updateExistingTask(taskData) {
            const taskIndex = tasks.findIndex(t => t.id === parseInt(taskData.id));
            if (taskIndex === -1) return;
            
            const originalTask = {...tasks[taskIndex]};
            
            tasks[taskIndex].name = taskData.name;
            tasks[taskIndex].startDate = taskData.startDate;
            tasks[taskIndex].startTime = taskData.startTime;
            tasks[taskIndex].displayThreshold = parseInt(taskData.displayThreshold) || 10;
            tasks[taskIndex].displayThresholdUnit = taskData.displayThresholdUnit || "minute";
            tasks[taskIndex].priority = taskData.priority;
            tasks[taskIndex].recurrence.duration = parseInt(taskData.duration) || 10;
            tasks[taskIndex].recurrence.durationUnit = taskData.durationUnit || "minute";
            tasks[taskIndex].recurrence.type = taskData.recurrenceType;
            
            delete tasks[taskIndex].recurrence.weekdays;
            delete tasks[taskIndex].recurrence.days;
            delete tasks[taskIndex].recurrence.count;
            delete tasks[taskIndex].recurrence.unit;
            
            switch(taskData.recurrenceType) {
                case "weekly":
                    tasks[taskIndex].recurrence.weekdays = taskData.weekdays ? 
                        taskData.weekdays.map(Number) : [1];
                    break;
                case "monthly":
                    if (taskData.monthweekdays && taskData.monthweekdays.length > 0) {
                        tasks[taskIndex].recurrence.weekdays = taskData.monthweekdays.map(Number);
                    } else if (taskData.monthdays && taskData.monthdays.length > 0) {
                        tasks[taskIndex].recurrence.days = taskData.monthdays.map(Number);
                    }
                    break;
                case "custom":
                    tasks[taskIndex].recurrence.count = parseInt(taskData.intervalCount) || 1;
                    tasks[taskIndex].recurrence.unit = taskData.intervalUnit || "day";
                    break;
            }
            
            const saveSuccess = await saveToLocalStorage(tasks);
            if (saveSuccess) {
                updateTasks();
            } else {
                tasks[taskIndex] = originalTask;
                alert('æ›´æ–°äº‹ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ é™¤äº‹ä»¶
        async function deleteTask(taskId) {
            const taskToDelete = tasks.find(t => t.id === taskId);
            if (!taskToDelete) return;
            
            tasks = tasks.filter(task => task.id !== taskId);
            
            const saveSuccess = await saveToLocalStorage(tasks);
            if (saveSuccess) {
                updateTasks();
            } else {
                tasks.push(taskToDelete);
                alert('åˆ é™¤äº‹ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºæ·»åŠ äº‹ä»¶æ¨¡æ€æ¡†
        function showAddTaskModal() {
            modalTitle.textContent = "æ·»åŠ æ–°äº‹ä»¶";
            taskForm.reset();
            taskIdInput.value = "";
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(':').slice(0, 2).join(':');
            
            startDateInput.value = dateStr;
            startTimeInput.value = timeStr;
            displayThresholdInput.value = 10;
            displayThresholdUnitInput.value = "minute";
            taskDurationInput.value = 10;
            durationUnitInput.value = "minute";
            
            recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.recurrence-option[data-type="none"]').classList.add('selected');
            recurrenceTypeInput.value = "none";
            showRecurrenceOptions("none");
            
            taskModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // æ˜¾ç¤ºç¼–è¾‘äº‹ä»¶æ¨¡æ€æ¡†
        function showEditTaskModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            modalTitle.textContent = "ç¼–è¾‘äº‹ä»¶";
            taskIdInput.value = task.id;
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-duration').value = task.recurrence.duration;
            document.getElementById('duration-unit').value = task.recurrence.durationUnit || "minute";
            document.getElementById('start-date').value = task.startDate;
            document.getElementById('start-time').value = task.startTime;
            document.getElementById('display-threshold').value = task.displayThreshold;
            document.getElementById('display-threshold-unit').value = task.displayThresholdUnit || "minute";
            
            const recurrenceType = task.recurrence.type || "none";
            recurrenceOptions.forEach(opt => opt.classList.remove('selected'));
            const selectedOption = document.querySelector(`.recurrence-option[data-type="${recurrenceType}"]`) || 
                                  document.querySelector('.recurrence-option[data-type="none"]');
            selectedOption.classList.add('selected');
            recurrenceTypeInput.value = recurrenceType;
            
            weekdayCheckboxes.forEach(checkbox => checkbox.checked = false);
            monthdayCheckboxes.forEach(checkbox => checkbox.checked = false);
            monthweekdayCheckboxes.forEach(checkbox => checkbox.checked = false);
            
            intervalCountInput.value = 1;
            intervalUnitInput.value = "day";
            
            if (recurrenceType === "weekly" && task.recurrence.weekdays) {
                task.recurrence.weekdays.forEach(day => {
                    const checkbox = document.querySelector(`input[name="weekday"][value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            } else if (recurrenceType === "monthly") {
                if (task.recurrence.weekdays) {
                    task.recurrence.weekdays.forEach(day => {
                        const checkbox = document.querySelector(`input[name="monthweekday"][value="${day}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else if (task.recurrence.days) {
                    task.recurrence.days.forEach(day => {
                        const checkbox = document.querySelector(`input[name="monthday"][value="${day}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else if (recurrenceType === "custom") {
                intervalCountInput.value = task.recurrence.count || 1;
                intervalUnitInput.value = task.recurrence.unit || "day";
            }
            
            showRecurrenceOptions(recurrenceType);
            taskModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // æ˜¾ç¤ºç¡®è®¤åˆ é™¤æ¨¡æ€æ¡†
        function showConfirmDeleteModal(taskId) {
            currentTaskId = taskId;
            confirmDeleteModal.classList.remove('hidden');
            hideAllContextMenus();
        }

        // éšè—æ‰€æœ‰å³é”®èœå•
        function hideAllContextMenus() {
            mainContextMenu.classList.add('hidden');
            taskContextMenu.classList.add('hidden');
        }

        // éšè—äº‹ä»¶æ¨¡æ€æ¡†
        function hideTaskModal() {
            taskModal.classList.add('hidden');
        }

        // éšè—ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡†
        function hideConfirmDeleteModal() {
            confirmDeleteModal.classList.add('hidden');
        }

        // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ‰€æœ‰äº‹ä»¶ - è€ƒè™‘é”å®šçŠ¶æ€
        appContainer.addEventListener('mouseenter', () => {
            if (!isListLocked) {
                allTasksEl.style.maxHeight = '500px';
            }
        });

        appContainer.addEventListener('mouseleave', () => {
            if (!isListLocked) {
                allTasksEl.style.maxHeight = '0';
            }
        });

        // åº”ç”¨å®¹å™¨å³é”®èœå•äº‹ä»¶
        appContainer.addEventListener('contextmenu', (e) => {
            if (!e.target.closest('.task-item') && !e.target.closest('[data-task-id]')) {
                e.preventDefault();
                hideAllContextMenus();
                
                const x = e.clientX;
                const y = e.clientY;
                
                mainContextMenu.style.left = `${x}px`;
                mainContextMenu.style.top = `${y}px`;
                mainContextMenu.classList.remove('hidden');
            }
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å³é”®èœå•
        document.addEventListener('click', hideAllContextMenus);

        // ä¿®å¤ï¼šä¸ºå³é”®èœå•é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆå·²åœ¨DOMContentLoadedä¸­æ·»åŠ ï¼‰

        // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
        closeModal.addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });
        
        cancelTask.addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });
        
        taskModal.querySelector('.modal-backdrop').addEventListener('click', (e) => {
            e.stopPropagation();
            hideTaskModal();
        });

        // å…³é—­ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡†äº‹ä»¶
        closeDeleteModal.addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });
        
        cancelDelete.addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });
        
        confirmDeleteModal.querySelector('.modal-backdrop').addEventListener('click', (e) => {
            e.stopPropagation();
            hideConfirmDeleteModal();
        });

        // ç¡®è®¤åˆ é™¤äº‹ä»¶
        confirmDelete.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (currentTaskId !== null) {
                await deleteTask(currentTaskId);
                currentTaskId = null;
                hideConfirmDeleteModal();
            }
        });

        // è¡¨å•æäº¤äº‹ä»¶
        taskForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const formData = {
                id: document.getElementById('task-id').value,
                name: document.getElementById('task-name').value,
                startDate: document.getElementById('start-date').value,
                startTime: document.getElementById('start-time').value,
                displayThreshold: document.getElementById('display-threshold').value,
                displayThresholdUnit: document.getElementById('display-threshold-unit').value,
                priority: document.getElementById('task-priority').value,
                recurrenceType: recurrenceTypeInput.value,
                duration: document.getElementById('task-duration').value,
                durationUnit: document.getElementById('duration-unit').value,
                intervalCount: document.getElementById('interval-count').value,
                intervalUnit: document.getElementById('interval-unit').value,
                weekdays: Array.from(weekdayCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value),
                monthdays: Array.from(monthdayCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value),
                monthweekdays: Array.from(monthweekdayCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value)
            };
            
            if (!validateFormData(formData.recurrenceType)) {
                return;
            }
            
            if (formData.id) {
                await updateExistingTask(formData);
            } else {
                await addNewTask(formData);
            }
            
            hideTaskModal();
        });

        // ä¸‹è½½ä¸ºHTMLæ–‡ä»¶åŠŸèƒ½
        function downloadAsHtml() {
            try {
                const dataToSave = { tasks: tasks };
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = document.documentElement.outerHTML;
                
                const elementsWithStyles = tempDiv.querySelectorAll('[style]');
                elementsWithStyles.forEach(el => {
                    if (el.style.transform) {
                        const transform = el.style.transform;
                        el.removeAttribute('style');
                        el.style.transform = transform;
                    } else {
                        el.removeAttribute('style');
                    }
                });
                
                const appContainer = tempDiv.querySelector('#app-container');
                if (appContainer) {
                    appContainer.className = 'bg-dark-card rounded-2xl shadow-lg task-transition border border-gray-700 w-auto max-w-md app-compact';
                }
                
                const scripts = tempDiv.querySelectorAll('script');
                scripts.forEach(script => {
                    if (script.textContent.includes('let externalData = null;')) {
                        const newContent = script.textContent.replace(
                            'let externalData = null;',
                            `let externalData = ${JSON.stringify(dataToSave, null, 2)};`
                        );
                        script.textContent = newContent;
                    }
                });
                
                const body = tempDiv.querySelector('body');
                if (body) {
                    body.className = 'bg-dark-bg min-h-screen flex items-center justify-center p-4 font-inter text-dark-text m-0';
                }
                
                const updatedHtml = '<!DOCTYPE html>' + tempDiv.innerHTML;
                
                const blob = new Blob([updatedHtml], { 
                    type: 'text/html; charset=utf-8' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                a.download = `Sky äº‹ä»¶ æ—¶é—´_${dateStr}.html`;
                
                a.href = url;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
                
                showNotification('æ•°æ®å·²å¯¼å‡ºä¸ºHTMLæ–‡ä»¶');
            } catch (e) {
                console.error('ä¸‹è½½å¤±è´¥:', e);
                showNotification('å¯¼å‡ºHTMLæ–‡ä»¶å¤±è´¥: ' + e.message, true);
            }
        }

        // æ¯ç§’æ›´æ–°æ—¶é—´
        setInterval(updateCurrentTime, 1000);
        
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡äº‹ä»¶çŠ¶æ€
        setInterval(updateTasks, 1000);
    </script>
</body>
</html>